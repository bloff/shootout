<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<title>C:\Fulgham\Projects\shootout\bench\regexmatch\regexmatch.gforth</title>
	<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body>
<pre><span class="line">    1 </span><span class="com">\ -*- mode: forth -*-
</span><span class="line">    2 </span><span class="com"></span><span class="com">\ $Id: regexmatch.gforth.html,v 1.1 2004-06-14 23:09:28 bfulgham Exp $
</span><span class="line">    3 </span><span class="com"></span><span class="com">\ http://www.bagley.org/~doug/shootout/
</span><span class="line">    4 </span><span class="com"></span>
<span class="line">    5 </span><span class="com">\ from Anton Ertl:
</span><span class="line">    6 </span><span class="com"></span><span class="com">\ this uses the Gray parser generator, which is probably too big a
</span><span class="line">    7 </span><span class="com"></span><span class="com">\ cannon for this problem (it also needs a lot of setup code).
</span><span class="line">    8 </span><span class="com"></span><span class="com">\ Writing a recursive descent parser by hand is probably both smaller
</span><span class="line">    9 </span><span class="com"></span><span class="com">\ and faster in this case.
</span><span class="line">   10 </span><span class="com"></span>
<span class="line">   11 </span>
<span class="line">   12 </span><span class="num">0</span>. argc &#64; <span class="num">1</span>- arg &gt;<span class="key">number </span><span class="num">2d</span>rop <span class="key">drop constant </span>NUM
<span class="line">   13 </span>
<span class="line">   14 </span>warnings off <span class="com">\ Gray is a little wordy
</span><span class="line">   15 </span><span class="com"></span>
<span class="line">   16 </span>require gray.fs
<span class="line">   17 </span>
<span class="line">   18 </span>: slurp-fid { fid -- addr u }
<span class="line">   19 </span>    <span class="num">0 0 </span><span class="key">begin </span><span class="com">( awhole uwhole )</span>
<span class="line">   20 </span>    <span class="key">dup </span><span class="num">1024 </span>+ <span class="key">dup </span>&gt;r extend-mem <span class="com">( anew awhole uwhole R: unew )</span>
<span class="line">   21 </span>    rot r&#64; fid read-file throw <span class="com">( awhole uwhole uread R: unew )</span>
<span class="line">   22 </span>    r&gt; <span class="num">2du</span>p =
<span class="line">   23 </span>    <span class="key">while </span><span class="com">( awhole uwhole uread unew )</span>
<span class="line">   24 </span>    <span class="num">2d</span>rop
<span class="line">   25 </span>    <span class="key">repeat
</span><span class="line">   26 </span><span class="key">    </span>- + <span class="key">dup </span>&gt;r resize throw r&gt; ;
<span class="line">   27 </span>
<span class="line">   28 </span>: bit-equiv <span class="com">( w1 w2 -- w3 )</span>
<span class="line">   29 </span>    <span class="com">\ w3=~w1^w2
</span><span class="line">   30 </span><span class="com"></span>    <span class="key">invert xor </span>;
<span class="line">   31 </span>
<span class="line">   32 </span>: set-complement <span class="com">( set1 -- set2 )</span>
<span class="line">   33 </span>    empty ['] bit-equiv binary-set-operation ;
<span class="line">   34 </span>
<span class="line">   35 </span><span class="key">variable input </span><span class="com">\ pointer to next character to be scanned
</span><span class="line">   36 </span><span class="com"></span><span class="key">variable </span>end-input <span class="com">\ pointer to end of input
</span><span class="line">   37 </span><span class="com"></span><span class="num">-1 </span><span class="key">constant </span>eof-char
<span class="line">   38 </span>
<span class="line">   39 </span>: start <span class="com">( -- addr )</span>
<span class="line">   40 </span>    <span class="key">input </span>&#64; ;
<span class="line">   41 </span>
<span class="line">   42 </span>: end <span class="com">( addr -- addr u )</span>
<span class="line">   43 </span>    <span class="key">input </span>&#64; <span class="key">over </span>- ;
<span class="line">   44 </span>
<span class="line">   45 </span>: get-input <span class="com">( -- c )</span>
<span class="line">   46 </span>    start end-input &#64; = <span class="key">if
</span><span class="line">   47 </span><span class="key">    </span>eof-char
<span class="line">   48 </span>    <span class="key">else
</span><span class="line">   49 </span><span class="key">    </span>start <span class="key">c&#64;
</span><span class="line">   50 </span><span class="key">    </span>endif ;
<span class="line">   51 </span>
<span class="line">   52 </span><span class="num">256 </span>max-member
<span class="line">   53 </span><span class="str">s&quot; scan failed&quot;</span> exception <span class="key">constant </span>scanfail
<span class="line">   54 </span>
<span class="line">   55 </span>: ?nextchar <span class="com">( f -- )</span>
<span class="line">   56 </span>    <span class="num">0</span>= scanfail <span class="key">and </span>throw
<span class="line">   57 </span>    <span class="num">1 </span><span class="key">chars input </span>+! ;
<span class="line">   58 </span>
<span class="line">   59 </span>: testchar? <span class="com">( set -- f )</span>
<span class="line">   60 </span>    get-input member? ;
<span class="line">   61 </span>' testchar? test-vector !
<span class="line">   62 </span>
<span class="line">   63 </span>: .. <span class="com">( c1 c2 -- set )</span>
<span class="line">   64 </span> <span class="com">( creates a set that includes the characters c, c1&lt;=c&lt;=c2 )</span>
<span class="line">   65 </span> empty copy-set
<span class="line">   66 </span> <span class="key">swap </span><span class="num">1</span>+ rot <span class="key">do
</span><span class="line">   67 </span><span class="key">  </span>i <span class="key">over </span>add-member
<span class="line">   68 </span> <span class="key">loop </span>;
<span class="line">   69 </span>
<span class="line">   70 </span>: ` <span class="com">( &quot;c&quot; -- terminal )</span>
<span class="line">   71 </span>    <span class="com">\ creates anonymous terminal for the character c )
</span><span class="line">   72 </span><span class="com"></span>    <span class="key">char </span>singleton ['] ?nextchar make-terminal ;
<span class="line">   73 </span>
<span class="line">   74 </span><span class="key">char </span><span class="num">0 </span><span class="key">char </span><span class="num">9 </span>.. <span class="key">dup  </span>' ?nextchar  terminal digit
<span class="line">   75 </span>set-complement        ' ?nextchar  terminal nondigit
<span class="line">   76 </span><span class="key">bl </span>singleton          ' ?nextchar  terminal lspace
<span class="line">   77 </span>
<span class="line">   78 </span><span class="num">2</span><span class="key">variable </span>areacode
<span class="line">   79 </span><span class="num">2</span><span class="key">variable </span>exchange
<span class="line">   80 </span><span class="num">2</span><span class="key">variable </span>last4
<span class="line">   81 </span>
<span class="line">   82 </span>(( {{ start }} digit digit digit {{ end areacode <span class="num">2</span>! }} ))
<span class="line">   83 </span>&lt;- area-code
<span class="line">   84 </span>
<span class="line">   85 </span>(( (( ` <span class="com">( area-code ` )</span> || area-code ))
<span class="line">   86 </span>   lspace {{ start }} digit digit digit {{ end exchange <span class="num">2</span>! }}
<span class="line">   87 </span>   (( lspace || ` - ))
<span class="line">   88 </span>   {{ start }} digit digit digit digit {{ end last4 <span class="num">2</span>! }}
<span class="line">   89 </span>   nondigit
<span class="line">   90 </span>)) &lt;- telnum <span class="com">( -- )</span>
<span class="line">   91 </span>
<span class="line">   92 </span>telnum parser scan-telnum <span class="com">( -- )</span>
<span class="line">   93 </span>
<span class="line">   94 </span>: scan-for-nondigit <span class="com">( addr1 -- addr2 )</span>
<span class="line">   95 </span>    <span class="key">begin
</span><span class="line">   96 </span><span class="key">    count </span><span class="com">( c&#64;+ )</span> &gt;r
<span class="line">   97 </span>    r&#64; '<span class="num">0 </span>&lt; r&#64; '<span class="num">9 </span>&gt; <span class="key">or  </span>r&gt; '<span class="com">( &lt;&gt;  and
</span><span class="line">   98 </span><span class="com">    over end-input &#64; u&gt;= or
</span><span class="line">   99 </span><span class="com">    until ;
</span><span class="line">  100 </span><span class="com">
</span><span class="line">  101 </span><span class="com">variable count  0 count !
</span><span class="line">  102 </span><span class="com">
</span><span class="line">  103 </span><span class="com">: scanfile ( addr u -- )</span>
<span class="line">  104 </span>    <span class="key">over </span>+ end-input !
<span class="line">  105 </span>    <span class="key">begin </span><span class="com">( addr1 )</span>
<span class="line">  106 </span>    <span class="key">dup input </span>!
<span class="line">  107 </span>    ['] scan-telnum catch
<span class="line">  108 </span>    <span class="key">dup dup </span>scanfail &lt;&gt; <span class="key">and </span>throw
<span class="line">  109 </span>    <span class="key">if </span><span class="com">( addr1 )</span>
<span class="line">  110 </span>        scan-for-nondigit
<span class="line">  111 </span>    <span class="key">else
</span><span class="line">  112 </span><span class="key">        </span><span class="num">1 </span><span class="key">count </span>+! <span class="key">count </span>&#64; <span class="num">1 </span>u.r <span class="str">.&quot; : &quot;</span>
<span class="line">  113 </span>        <span class="str">.&quot; (&quot;</span> areacode <span class="num">2</span>&#64; <span class="key">type </span><span class="str">.&quot; ) &quot;</span> exchange <span class="num">2</span>&#64; <span class="key">type </span><span class="str">.&quot; -&quot;</span> last4 <span class="num">2</span>&#64; <span class="key">type
</span><span class="line">  114 </span><span class="key">        cr
</span><span class="line">  115 </span><span class="key">        </span>end-input &#64; <span class="key">over </span>- #lf scan <span class="key">drop </span><span class="com">\ skip rest of line
</span><span class="line">  116 </span><span class="com"></span>    endif
<span class="line">  117 </span>    <span class="key">dup </span>end-input &#64; u&gt;=
<span class="line">  118 </span>    <span class="key">until
</span><span class="line">  119 </span><span class="key">    drop </span>;
<span class="line">  120 </span>
<span class="line">  121 </span>: mainloop <span class="com">( addr u -- )</span>
<span class="line">  122 </span>    ['] <span class="num">2d</span>rop [is] <span class="key">type
</span><span class="line">  123 </span><span class="key">    </span>NUM <span class="num">1 </span>+<span class="key">do
</span><span class="line">  124 </span><span class="key">    </span><span class="num">2du</span>p scanfile
<span class="line">  125 </span>    <span class="key">loop
</span><span class="line">  126 </span><span class="key">    </span>['] (type) [is] <span class="key">type
</span><span class="line">  127 </span><span class="key">    </span>scanfile ;
<span class="line">  128 </span>
<span class="line">  129 </span><span class="key">stdin </span>slurp-fid mainloop bye
<span class="line">  130 </span>
</pre>
</body>
</html>
<!--HTML generated by highlight 2.0-24, http://www.andre-simon.de/-->
