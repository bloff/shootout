<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<title>C:\Fulgham\Projects\shootout\bench\lists\lists.mlton</title>
	<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body>
<pre><span class="line">    1 </span><span class="com">(* -*- mode: sml -*-
</span><span class="line">    2 </span><span class="com"> * $Id: lists.mlton.html,v 1.1 2004-06-14 23:09:27 bfulgham Exp $
</span><span class="line">    3 </span><span class="com"> * http://www.bagley.org/~doug/shootout/
</span><span class="line">    4 </span><span class="com"> * from Stephen Weeks
</span><span class="line">    5 </span><span class="com"> *)</span>
<span class="line">    6 </span><span class="com">(* Translated from lists.ocaml. *)</span>
<span class="line">    7 </span>
<span class="line">    8 </span><span class="key">val </span>sub = Array.sub
<span class="line">    9 </span><span class="key">val </span>update = Array.update
<span class="line">   10 </span><span class="key">fun </span>for (start, stop, f) =
<span class="line">   11 </span>   <span class="key">let
</span><span class="line">   12 </span><span class="key">      fun </span>loop i =
<span class="line">   13 </span>     <span class="key">if </span>i &gt; stop
<span class="line">   14 </span>        <span class="key">then </span>()
<span class="line">   15 </span>     <span class="key">else </span>(f i; loop (i + <span class="num">1</span>))
<span class="line">   16 </span>   <span class="key">in
</span><span class="line">   17 </span><span class="key">      </span>loop start
<span class="line">   18 </span>   <span class="key">end
</span><span class="line">   19 </span><span class="key">fun </span>failwith s = <span class="key">raise </span>Fail s
<span class="line">   20 </span>
<span class="line">   21 </span><span class="key">structure </span>Deque:
<span class="line">   22 </span>  <span class="key">sig
</span><span class="line">   23 </span><span class="key">    type </span>'a t
<span class="line">   24 </span>    <span class="key">exception </span>Empty
<span class="line">   25 </span>
<span class="line">   26 </span>    <span class="key">val </span>make: <span class="typ">int </span>* 'a -&gt; 'a t
<span class="line">   27 </span>    <span class="key">val </span>iota: <span class="typ">int </span>-&gt; <span class="typ">int </span>t
<span class="line">   28 </span>
<span class="line">   29 </span>    <span class="key">val </span>is_empty: 'a t -&gt; <span class="typ">bool
</span><span class="line">   30 </span><span class="typ">    </span><span class="key">val </span>equal: ''a t * ''a t -&gt; <span class="typ">bool
</span><span class="line">   31 </span><span class="typ">    </span><span class="key">val </span>length: 'a t -&gt; <span class="typ">int
</span><span class="line">   32 </span><span class="typ">    </span><span class="key">val </span>nth: 'a t * <span class="typ">int </span>-&gt; 'a
<span class="line">   33 </span>
<span class="line">   34 </span>    <span class="key">val </span>push_front: 'a * 'a t -&gt; unit
<span class="line">   35 </span>    <span class="key">val </span>push_back: 'a t * 'a -&gt; unit
<span class="line">   36 </span>
<span class="line">   37 </span>    <span class="key">val </span>take_front: 'a t -&gt; 'a
<span class="line">   38 </span>    <span class="key">val </span>take_back: 'a t -&gt; 'a
<span class="line">   39 </span>
<span class="line">   40 </span>    <span class="key">val </span>copy: 'a t -&gt; 'a t
<span class="line">   41 </span>    <span class="key">val </span>reverse: 'a t -&gt; 'a t
<span class="line">   42 </span>  <span class="key">end </span>=
<span class="line">   43 </span>  <span class="key">struct
</span><span class="line">   44 </span><span class="key">     type </span>'a t = {size: <span class="typ">int </span>ref,
<span class="line">   45 </span>          first: <span class="typ">int </span>ref,
<span class="line">   46 </span>          last: <span class="typ">int </span>ref,
<span class="line">   47 </span>          field: 'a array ref,
<span class="line">   48 </span>          fill: 'a}
<span class="line">   49 </span>
<span class="line">   50 </span>     <span class="key">local
</span><span class="line">   51 </span><span class="key">    fun </span>make sel (d: 'a t) = sel d
<span class="line">   52 </span>     <span class="key">in
</span><span class="line">   53 </span><span class="key">    fun </span>fill z = make #fill z
<span class="line">   54 </span>     <span class="key">end
</span><span class="line">   55 </span><span class="key">
</span><span class="line">   56 </span><span class="key">     local
</span><span class="line">   57 </span><span class="key">    fun </span>make sel (d: 'a t) = !(sel d)
<span class="line">   58 </span>     <span class="key">in
</span><span class="line">   59 </span><span class="key">    fun </span>field z = make #field z
<span class="line">   60 </span>    <span class="key">fun </span>first z = make #first z
<span class="line">   61 </span>    <span class="key">fun </span>last z = make #last z
<span class="line">   62 </span>    <span class="key">fun </span>size z = make #size z
<span class="line">   63 </span>     <span class="key">end
</span><span class="line">   64 </span><span class="key">
</span><span class="line">   65 </span><span class="key">     exception </span>Empty
<span class="line">   66 </span>
<span class="line">   67 </span>     <span class="key">fun </span>make (n, dummy) =
<span class="line">   68 </span>    <span class="key">let
</span><span class="line">   69 </span><span class="key">       val </span>n = <span class="key">Int</span>.max (n, <span class="num">0</span>)
<span class="line">   70 </span>       <span class="key">val </span>nplus = <span class="key">Int</span>.max (<span class="num">1</span>, n)
<span class="line">   71 </span>    <span class="key">in
</span><span class="line">   72 </span><span class="key">       </span>{size = ref nplus,
<span class="line">   73 </span>        first = ref (<span class="key">Int</span>.quot (nplus, <span class="num">2</span>)),
<span class="line">   74 </span>        last = ref (<span class="key">Int</span>.quot (nplus, <span class="num">2</span>) <span class="num">- 1</span>),
<span class="line">   75 </span>        field = ref (Array.array (nplus, dummy)),
<span class="line">   76 </span>        fill = dummy}
<span class="line">   77 </span>    <span class="key">end
</span><span class="line">   78 </span><span class="key">
</span><span class="line">   79 </span><span class="key">     fun </span>iota i =
<span class="line">   80 </span>    <span class="key">let
</span><span class="line">   81 </span><span class="key">       val </span>i = <span class="key">Int</span>.max (<span class="num">0</span>, i)
<span class="line">   82 </span>       <span class="key">val </span>iplus = <span class="key">Int</span>.max (<span class="num">1</span>, i)
<span class="line">   83 </span>    <span class="key">in
</span><span class="line">   84 </span><span class="key">       </span>{size = ref iplus,
<span class="line">   85 </span>        first = ref <span class="num">0</span>,
<span class="line">   86 </span>        last = ref (i <span class="num">- 1</span>),
<span class="line">   87 </span>        field = ref (Array.tabulate (iplus, <span class="key">fn </span>n =&gt; n + <span class="num">1</span>)),
<span class="line">   88 </span>        fill = i}
<span class="line">   89 </span>    <span class="key">end
</span><span class="line">   90 </span><span class="key">
</span><span class="line">   91 </span><span class="key">     fun </span>length buf = last buf - first buf + <span class="num">1
</span><span class="line">   92 </span><span class="num">
</span><span class="line">   93 </span><span class="num">     </span><span class="key">fun </span>is_empty buf = last buf &lt; first buf
<span class="line">   94 </span>
<span class="line">   95 </span>     <span class="key">fun </span>array_eq (arr1, off1, arr2, off2, i) =
<span class="line">   96 </span>    <span class="key">let
</span><span class="line">   97 </span><span class="key">       fun </span>loop (off1, off2, i) =
<span class="line">   98 </span>          <span class="key">case </span>i <span class="key">of
</span><span class="line">   99 </span><span class="key">         </span><span class="num">0 </span>=&gt; <span class="key">true
</span><span class="line">  100 </span><span class="key">           </span>| n =&gt;
<span class="line">  101 </span>            sub (arr1, off1) = sub (arr2, off2)
<span class="line">  102 </span>            <span class="key">andalso </span>loop (off1 + <span class="num">1</span>, off2 + <span class="num">1</span>, n <span class="num">- 1</span>)
<span class="line">  103 </span>    <span class="key">in </span>loop (off1, off2, i)
<span class="line">  104 </span>    <span class="key">end
</span><span class="line">  105 </span><span class="key">
</span><span class="line">  106 </span><span class="key">     fun </span>equal (buf1, buf2) =
<span class="line">  107 </span>    <span class="key">let
</span><span class="line">  108 </span><span class="key">       val </span>len = length buf1
<span class="line">  109 </span>    <span class="key">in
</span><span class="line">  110 </span><span class="key">       </span>len = length buf2
<span class="line">  111 </span>       <span class="key">andalso </span>array_eq (field buf1, first buf1,
<span class="line">  112 </span>                 field buf2, first buf2,
<span class="line">  113 </span>                 len)
<span class="line">  114 </span>    <span class="key">end
</span><span class="line">  115 </span><span class="key">
</span><span class="line">  116 </span><span class="key">     fun </span>nth (buf, n) =
<span class="line">  117 </span>    <span class="key">if </span>n &lt; <span class="num">0 </span><span class="key">orelse </span>n &gt;= length buf
<span class="line">  118 </span>       <span class="key">then </span>failwith <span class="str">&quot;nth&quot;</span>
<span class="line">  119 </span>    <span class="key">else </span>sub (field buf, first buf + n)
<span class="line">  120 </span>
<span class="line">  121 </span>     <span class="key">fun </span>double_shift buf =
<span class="line">  122 </span>    <span class="key">let
</span><span class="line">  123 </span><span class="key">       val </span>new_size = size buf * <span class="num">2
</span><span class="line">  124 </span><span class="num">       </span><span class="key">val </span>len = length buf
<span class="line">  125 </span>       <span class="key">val </span>new_first = <span class="key">Int</span>.quot (new_size - len, <span class="num">2</span>)
<span class="line">  126 </span>       <span class="key">val </span>new_field = Array.array (new_size, fill buf)
<span class="line">  127 </span>       <span class="key">val </span>_ =
<span class="line">  128 </span>          ArraySlice.copy {src = ArraySlice.slice (field buf,
<span class="line">  129 </span>                               first buf,
<span class="line">  130 </span>                               SOME len),
<span class="line">  131 </span>                   dst = new_field,
<span class="line">  132 </span>                   di = new_first}
<span class="line">  133 </span>    <span class="key">in
</span><span class="line">  134 </span><span class="key">       </span>#size buf := new_size;
<span class="line">  135 </span>       #field buf := new_field;
<span class="line">  136 </span>       #first buf := new_first;
<span class="line">  137 </span>       #last buf := new_first + len <span class="num">- 1
</span><span class="line">  138 </span><span class="num">    </span><span class="key">end
</span><span class="line">  139 </span><span class="key">
</span><span class="line">  140 </span><span class="key">     fun </span>push_front (elem, buf) =
<span class="line">  141 </span>    <span class="key">let
</span><span class="line">  142 </span><span class="key">       val </span>_ = <span class="key">if </span>first buf = <span class="num">0 </span><span class="key">then </span>double_shift buf <span class="key">else </span>()
<span class="line">  143 </span>       <span class="key">val </span>new_first = first buf <span class="num">- 1
</span><span class="line">  144 </span><span class="num">    </span><span class="key">in
</span><span class="line">  145 </span><span class="key">       </span>update (field buf, new_first, elem);
<span class="line">  146 </span>       #first buf := new_first
<span class="line">  147 </span>    <span class="key">end
</span><span class="line">  148 </span><span class="key">
</span><span class="line">  149 </span><span class="key">     fun </span>push_back (buf, elem) =
<span class="line">  150 </span>    <span class="key">let
</span><span class="line">  151 </span><span class="key">       val </span>_ = <span class="key">if </span>last buf = size buf <span class="num">- 1 </span><span class="key">then </span>double_shift buf <span class="key">else </span>()
<span class="line">  152 </span>       <span class="key">val </span>new_last = last buf + <span class="num">1
</span><span class="line">  153 </span><span class="num">    </span><span class="key">in
</span><span class="line">  154 </span><span class="key">       </span>update (field buf, new_last, elem);
<span class="line">  155 </span>       #last buf := new_last
<span class="line">  156 </span>    <span class="key">end
</span><span class="line">  157 </span><span class="key">
</span><span class="line">  158 </span><span class="key">     fun </span>take_front buf =
<span class="line">  159 </span>    <span class="key">if </span>is_empty buf
<span class="line">  160 </span>       <span class="key">then raise </span>Empty
<span class="line">  161 </span>    <span class="key">else
</span><span class="line">  162 </span><span class="key">       let
</span><span class="line">  163 </span><span class="key">          val </span>old_first = first buf
<span class="line">  164 </span>       <span class="key">in
</span><span class="line">  165 </span><span class="key">          </span>#first buf := old_first + <span class="num">1</span>;
<span class="line">  166 </span>          sub (field buf, old_first)
<span class="line">  167 </span>       <span class="key">end
</span><span class="line">  168 </span><span class="key">
</span><span class="line">  169 </span><span class="key">     fun </span>take_back buf =
<span class="line">  170 </span>    <span class="key">if </span>is_empty buf
<span class="line">  171 </span>       <span class="key">then raise </span>Empty
<span class="line">  172 </span>    <span class="key">else
</span><span class="line">  173 </span><span class="key">       let
</span><span class="line">  174 </span><span class="key">          val </span>old_last = last buf
<span class="line">  175 </span>       <span class="key">in
</span><span class="line">  176 </span><span class="key">          </span>#last buf := old_last <span class="num">- 1</span>;
<span class="line">  177 </span>          sub (field buf, old_last)
<span class="line">  178 </span>       <span class="key">end
</span><span class="line">  179 </span><span class="key">
</span><span class="line">  180 </span><span class="key">     fun </span>copy buf =
<span class="line">  181 </span>    <span class="key">let
</span><span class="line">  182 </span><span class="key">       val </span>len = length buf
<span class="line">  183 </span>       <span class="key">val </span>new_buf = make (len, fill buf)
<span class="line">  184 </span>       <span class="key">val </span>_ =
<span class="line">  185 </span>          ArraySlice.copy {src = ArraySlice.slice (field buf,
<span class="line">  186 </span>                               first buf,
<span class="line">  187 </span>                               SOME len),
<span class="line">  188 </span>                   dst = field new_buf,
<span class="line">  189 </span>                   di = <span class="num">0</span>}
<span class="line">  190 </span>    <span class="key">in
</span><span class="line">  191 </span><span class="key">       </span>#first new_buf := <span class="num">0</span>;
<span class="line">  192 </span>       #last new_buf := len <span class="num">- 1</span>;
<span class="line">  193 </span>       new_buf
<span class="line">  194 </span>    <span class="key">end
</span><span class="line">  195 </span><span class="key">
</span><span class="line">  196 </span><span class="key">     fun </span>reverse buf =
<span class="line">  197 </span>    <span class="key">let
</span><span class="line">  198 </span><span class="key">       val </span>len = length buf
<span class="line">  199 </span>       <span class="key">val </span>fst = first buf
<span class="line">  200 </span>       <span class="key">val </span>fld = field buf
<span class="line">  201 </span>       <span class="key">val </span>new_buf = make (len, fill buf)
<span class="line">  202 </span>       <span class="key">val </span>new_fld = field new_buf
<span class="line">  203 </span>       <span class="key">val </span>_ =
<span class="line">  204 </span>          for (<span class="num">0</span>, len <span class="num">- 1</span>, <span class="key">fn </span>i =&gt;
<span class="line">  205 </span>           update (new_fld, len - i <span class="num">- 1</span>, sub (fld, fst + i)))
<span class="line">  206 </span>    <span class="key">in
</span><span class="line">  207 </span><span class="key">       </span>#first new_buf := <span class="num">0</span>;
<span class="line">  208 </span>       #last new_buf := len <span class="num">- 1</span>;
<span class="line">  209 </span>       new_buf
<span class="line">  210 </span>    <span class="key">end
</span><span class="line">  211 </span><span class="key">end
</span><span class="line">  212 </span><span class="key">
</span><span class="line">  213 </span><span class="key">open </span>Deque
<span class="line">  214 </span>
<span class="line">  215 </span><span class="key">fun </span>empty () = iota <span class="num">0
</span><span class="line">  216 </span><span class="num">
</span><span class="line">  217 </span><span class="num"></span><span class="key">val </span>size = <span class="num">10000
</span><span class="line">  218 </span><span class="num">
</span><span class="line">  219 </span><span class="num"></span><span class="key">fun </span>test_lists () =
<span class="line">  220 </span>  <span class="key">let
</span><span class="line">  221 </span><span class="key">     val </span>d1 = iota size
<span class="line">  222 </span>     <span class="key">val </span>d2 = copy d1
<span class="line">  223 </span>     <span class="key">val </span>d3 = empty ()
<span class="line">  224 </span>     <span class="key">val </span>_ = for (<span class="num">1</span>, length d2, <span class="key">fn </span>_ =&gt; push_back (d3, take_front d2))
<span class="line">  225 </span>     <span class="key">val </span>_ = for (<span class="num">1</span>, length d3, <span class="key">fn </span>_ =&gt; push_back (d2, take_back d3))
<span class="line">  226 </span>     <span class="key">val </span>d1 = reverse d1
<span class="line">  227 </span>     <span class="key">val </span>_ = <span class="key">if </span>size &lt;&gt; nth (d1, <span class="num">0</span>) <span class="key">then </span>failwith <span class="str">&quot;First test failed&quot;</span> <span class="key">else
</span><span class="line">  228 </span><span class="key">             </span>()
<span class="line">  229 </span>     <span class="key">val </span>_ = <span class="key">if </span>length d1 &lt;&gt; length d2 <span class="key">then </span>failwith <span class="str">&quot;Second test failed&quot;</span>
<span class="line">  230 </span>             <span class="key">else </span>()
<span class="line">  231 </span>     <span class="key">val </span>_ = <span class="key">if </span>not (equal (d1, d2)) <span class="key">then </span>failwith <span class="str">&quot;Third test failed&quot;</span>
<span class="line">  232 </span>             <span class="key">else </span>()
<span class="line">  233 </span>  <span class="key">in
</span><span class="line">  234 </span><span class="key">     </span>length d1
<span class="line">  235 </span>  <span class="key">end
</span><span class="line">  236 </span><span class="key">
</span><span class="line">  237 </span><span class="key">fun </span>main (name, args) =
<span class="line">  238 </span>  <span class="key">let
</span><span class="line">  239 </span><span class="key">     val </span>n =
<span class="line">  240 </span>    <span class="key">case Int</span>.fromString (hd (args &#64; [<span class="str">&quot;1&quot;</span>])) <span class="key">of
</span><span class="line">  241 </span><span class="key">       </span>NONE =&gt; <span class="num">1
</span><span class="line">  242 </span><span class="num">     </span>| SOME n =&gt; n
<span class="line">  243 </span>     <span class="key">val </span>result = ref <span class="num">0
</span><span class="line">  244 </span><span class="num">     </span><span class="key">val </span>_ = for (<span class="num">1</span>, n, <span class="key">fn </span>_ =&gt; result := test_lists ())
<span class="line">  245 </span>  <span class="key">in
</span><span class="line">  246 </span><span class="key">     </span>print (concat [<span class="key">Int</span>.toString (!result), <span class="str">&quot;</span><span class="esc">\n</span><span class="str">&quot;</span>]);
<span class="line">  247 </span>     OS.Process.success
<span class="line">  248 </span>  <span class="key">end
</span><span class="line">  249 </span><span class="key">
</span><span class="line">  250 </span><span class="key">val </span>_ = main( CommandLine.name(), CommandLine.arguments() )
</pre>
</body>
</html>
<!--HTML generated by highlight 2.0-24, http://www.andre-simon.de/-->
