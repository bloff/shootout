<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<title>C:\Fulgham\Projects\shootout\bench\heapsort\heapsort.mlton</title>
	<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body>
<pre><span class="line">    1 </span><span class="com">(* -*- mode: sml -*-
</span><span class="line">    2 </span><span class="com"> * $Id: heapsort.mlton.html,v 1.1 2004-06-14 23:09:27 bfulgham Exp $
</span><span class="line">    3 </span><span class="com"> * http://www.bagley.org/~doug/shootout/
</span><span class="line">    4 </span><span class="com"> * Based on cdoe from Stephen Weeks, improved by Henry Cejtin.
</span><span class="line">    5 </span><span class="com">*)</span>
<span class="line">    6 </span>
<span class="line">    7 </span><span class="key">val </span>sub = Array.sub
<span class="line">    8 </span><span class="key">val </span>update = Array.update
<span class="line">    9 </span>
<span class="line">   10 </span><span class="key">local
</span><span class="line">   11 </span><span class="key">   val </span>im = <span class="num">139968
</span><span class="line">   12 </span><span class="num">   </span><span class="key">val </span>ia =   <span class="num">3877
</span><span class="line">   13 </span><span class="num">   </span><span class="key">val </span>ic =  <span class="num">29573
</span><span class="line">   14 </span><span class="num">   </span><span class="key">val </span>last = ref <span class="num">42
</span><span class="line">   15 </span><span class="num">   </span><span class="key">val </span>scale = <span class="num">1.0 </span>/ <span class="key">Real</span>.fromInt im
<span class="line">   16 </span><span class="key">in
</span><span class="line">   17 </span><span class="key">   fun </span>gen_random max =
<span class="line">   18 </span>      <span class="key">let val </span>last' = (! last * ia + ic) mod im
<span class="line">   19 </span>      <span class="key">in </span>last := last';
<span class="line">   20 </span>         max * scale * <span class="key">Real</span>.fromInt last'
<span class="line">   21 </span>      <span class="key">end
</span><span class="line">   22 </span><span class="key">end
</span><span class="line">   23 </span><span class="key">
</span><span class="line">   24 </span><span class="key">fun </span>heapSort (n, ra: <span class="typ">real </span>array) =
<span class="line">   25 </span>       <span class="key">let fun </span>inner (l, ir, rra) =
<span class="line">   26 </span>                  <span class="key">let fun </span>loop (i, j) =
<span class="line">   27 </span>                             <span class="key">if </span>j &lt;= ir
<span class="line">   28 </span>                                <span class="key">then let val </span>j =
<span class="line">   29 </span>                                                <span class="key">if </span>j &lt; ir
<span class="line">   30 </span>                                                <span class="key">andalso </span>sub (ra, j) &lt; sub (
<span class="line">   31 </span>                                                             ra, j + <span class="num">1</span>)
<span class="line">   32 </span>                                                   <span class="key">then </span>j + <span class="num">1
</span><span class="line">   33 </span><span class="num">                                                   </span><span class="key">else </span>j
<span class="line">   34 </span>                                         <span class="key">val </span>(i, j) =
<span class="line">   35 </span>                                                <span class="key">if </span>rra &lt; sub (ra, j)
<span class="line">   36 </span>                                                   <span class="key">then </span>(update (ra, i,
<span class="line">   37 </span>                                                         sub (ra, j));
<span class="line">   38 </span>                                                         (j, j + j))
<span class="line">   39 </span>                                                   <span class="key">else </span>(i, ir + <span class="num">1</span>)
<span class="line">   40 </span>                                     <span class="key">in </span>loop (i, j)
<span class="line">   41 </span>                                     <span class="key">end
</span><span class="line">   42 </span><span class="key">                                else </span>update (ra, i, rra)
<span class="line">   43 </span>                  <span class="key">in </span>loop (l, l + l)
<span class="line">   44 </span>                  <span class="key">end
</span><span class="line">   45 </span><span class="key">           fun </span>outer1 l =
<span class="line">   46 </span>                  <span class="key">let val </span>l' = l <span class="num">- 1
</span><span class="line">   47 </span><span class="num">                  </span><span class="key">in if </span>l' &gt; <span class="num">0
</span><span class="line">   48 </span><span class="num">                        </span><span class="key">then </span>(inner (l', n, sub (ra, l'));
<span class="line">   49 </span>                              outer1 l')
<span class="line">   50 </span>                        <span class="key">else </span>()
<span class="line">   51 </span>                  <span class="key">end
</span><span class="line">   52 </span><span class="key">           fun </span>outer2 ir =
<span class="line">   53 </span>                  <span class="key">let val </span>rra = sub (ra, ir)
<span class="line">   54 </span>                      <span class="key">val </span>_ = update (ra, ir, sub (ra, <span class="num">1</span>))
<span class="line">   55 </span>                      <span class="key">val </span>ir = ir <span class="num">- 1
</span><span class="line">   56 </span><span class="num">                  </span><span class="key">in if </span>ir = <span class="num">1
</span><span class="line">   57 </span><span class="num">                        </span><span class="key">then </span>update (ra, <span class="num">1</span>, rra)
<span class="line">   58 </span>                        <span class="key">else </span>(inner (<span class="num">1</span>, ir, rra);
<span class="line">   59 </span>                              outer2 ir)
<span class="line">   60 </span>                  <span class="key">end
</span><span class="line">   61 </span><span class="key">       in </span>outer1 (n div <span class="num">2 </span>+ <span class="num">1</span>);
<span class="line">   62 </span>          outer2 n
<span class="line">   63 </span>       <span class="key">end
</span><span class="line">   64 </span><span class="key">
</span><span class="line">   65 </span><span class="key">fun </span>atoi s = <span class="key">case Int</span>.fromString s <span class="key">of </span>SOME num =&gt; num | NONE =&gt; <span class="num">0</span>;
<span class="line">   66 </span><span class="key">fun </span>printl [] = print <span class="str">&quot;</span><span class="esc">\n</span><span class="str">&quot;</span> | printl(h::t) = ( print h ; printl t );
<span class="line">   67 </span>
<span class="line">   68 </span><span class="key">fun </span>main (name, args) =
<span class="line">   69 </span>       <span class="key">let val </span>n = atoi (hd (args &#64; [<span class="str">&quot;1&quot;</span>]))
<span class="line">   70 </span>       <span class="key">val </span>ary = Array.tabulate (n + <span class="num">1</span>, <span class="key">fn </span>_ =&gt; gen_random <span class="num">1.0</span>)
<span class="line">   71 </span>       <span class="key">in </span>heapSort (n, ary);
<span class="line">   72 </span>      print (concat [<span class="key">Real</span>.fmt (<span class="key">StringCvt</span>.FIX (SOME <span class="num">10</span>)) (sub (ary, n)),
<span class="line">   73 </span>             <span class="str">&quot;</span><span class="esc">\n</span><span class="str">&quot;</span>])
<span class="line">   74 </span>       <span class="key">end
</span><span class="line">   75 </span><span class="key">
</span><span class="line">   76 </span><span class="key">val </span>_ = main( CommandLine.name(), CommandLine.arguments() )
</pre>
</body>
</html>
<!--HTML generated by highlight 2.0-24, http://www.andre-simon.de/-->
