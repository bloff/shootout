#!/usr/bin/python -OO
# The Computer Language Benchmarks Game
# $Id: csv2new,v 1.4 2008-08-02 05:57:54 igouy-guest Exp $

"""
One off conversion of data from old format data.csv and ndata.csv
to new headers and columns expected by new webpages.
"""

from __future__ import with_statement

__author__ =  'Isaac Gouy'

import os
from sys import argv
from domain import Record
from contextlib import nested
from os.path import join, isdir, getatime, getmtime


def main():
   if argv and (argv[1]=='data.csv' or argv[1]=='ndata.csv'):

      tmpdir = join('csv2new_tmp')
      if not isdir(tmpdir): os.mkdir(tmpdir)
      oldpath = join(argv[1])
      newpath = join(tmpdir,argv[1])

      with nested( open(oldpath, 'r'),
                   open(newpath, 'w')) as (oldf,newf):

         rows = [s.rstrip('\n') for s in oldf.readlines()]
         rows = rows[1:] # discard the old header row
         newf.write('name,lang,id,n,size(B),cpu(s),mem(KB),status,load,elapsed(s)\n')

         for each in rows:
            oldrow = each.split(',')
            # old format = test,lang,id,iter,secs-startup,secs,kb,lines,date
            newf.write('%s,%s,%s,' % (oldrow[0],oldrow[1],oldrow[2]))

            r = Record()
            r.arg = int(oldrow[3]) if oldrow[3] else 0
            r.gz = int(oldrow[4]) if oldrow[4] else 0
            r.userSysTime = float(oldrow[5]) if float(oldrow[5]) >= 0.0 else 0.0
            r.maxMem = int(oldrow[6]) if int(oldrow[6]) > 0 else 0
            r.status = 0 if float(oldrow[5]) >= 0.0 else int(oldrow[5])
            r.cpuLoad = '%'
            r.elapsed = 0.0

            newf.write(str(r)); newf.write('\n')


      at = getatime(oldpath)
      mt = getmtime(oldpath)
      os.utime(newpath, (at,mt) )


if __name__ == "__main__":
   main()
