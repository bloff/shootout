#!/usr/bin/python -OO
# The Computer Language Benchmarks Game
# $Id: csv2new,v 1.1 2008-08-02 03:03:30 igouy-guest Exp $

from __future__ import with_statement

__author__ =  'Isaac Gouy'


from sys import argv
from domain import Record
from contextlib import nested
from os.path import join


def main():
   if argv and (argv[1]=='data.csv' or argv[1]=='ndata.csv'):

      with nested( open( join(argv[1]), 'r'),
                   open( join(argv[1],'_new'), 'w')) as (oldf,newf):

         rows = [s.rstrip('\n') for s in oldf.readlines()]
         rows = rows[1:] # discard the old header row
         newf.write('name,lang,id,n,size(B),cpu(s),mem(KB),status,load,elapsed(s)\n')

         for each in rows:
            oldrow = each.split(',')
            # old format = test,lang,id,iter,secs-startup,secs,kb,lines,date
            newf.write('%s,%s,%s,' % (oldrow[0],oldrow[1],oldrow[2]))

            r = Record()
            r.arg = oldrow[3]
            r.gz = oldrow[4]
            r.userSysTime = float(oldrow[5]) if float(oldrow[5]) >= 0.0 else 0.0
            r.maxMem = int(oldrow[6]) if int(oldrow[6]) > 0 else 0
            r.status = 0 if float(oldrow[5]) >= 0.0 else int(oldrow[5])
            r.cpuLoad = '%'
            r.elapsed = 0.0
            newf.write(str(r)); newf.write('\n')


if __name__ == "__main__":
   main()