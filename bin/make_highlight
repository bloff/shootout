#!/usr/bin/perl
# to be run in top directory

# Generates beautiful, highlighted source code for viewing
# via Web Browsers
#
# Note:  Requires the Highlight program by André Simon <andre.simon1@gmx.de>
# See http://www.andre-simon.de/
#
use File::Basename;

BEGIN {
    require "langs.pl";
}

sub genfile ($$$) {
    my ($benchdir, $benchmark, $impl) = @_;
    my $source = "bench/$benchdir/$benchmark.$impl";

    return unless -s $source;
    
    my $dest = "lang/$impl/" . basename($source) . ".html";
    my $lang = $::LANG{$impl}->{Lang};
    my $ext = $::LANG{$impl}->{Ext};

    # Check that file needs to be generated
    my ($sdev, $sino, $smode, $snlink, $suid, $sgid, $srdev, $ssize,
    	$satime, $smtime, $sctime, $sblksize, $sblocks)
	= stat $source;
    my ($ddev, $dino, $dmode, $dnlink, $duid, $dgid, $drdev, $dsize,
    	$datime, $dmtime, $dctime, $dblksize, $dblocks)
	= stat $dest;

    return 0 if ($dmtime >= $smtime);

    my $command = "highlight -i $source -o $dest -S $ext -s typical -c /css/highlight.css";
    #print "Trying $command\n";
    unlink($dest);
    system($command) == 0
    	or print "$command failed: $1";
    return 1;
}

sub main {

    print "Starting to generate HTML...\n";
    opendir BENCHDIR, "bench" or die "Couldn't open benchmark directory: $!\n";
    @allfiles = readdir BENCHDIR;
    shift @allfiles;	# Drop the . directory
    shift @allfiles;	# Drop the .. directory
    closedir BENCHDIR;
    my $implcount = 0;
    foreach my $impl (keys %LANG) {

	unless (-d "lang/$impl") {
	    mkdir("lang/$impl");
	}

	#
	#  For each directory in the bench directory, generate
	#  HTML-ized source code and place in the appropriate lang
	#  directory.
	#
	my $header = "Processing $impl...\nbench: ";
	my $count = 0;
	foreach my $benchmark (@allfiles) {

	    my $benchdir = $benchmark;

	    next unless -d "bench/$benchdir";
	    
	    next if ($benchdir =~ /\.\./);
	    next if ($benchdir =~ /\./);
	    next if ($benchdir =~ /Include/);
	    next if ($benchdir =~ /CVS/);

	    if ($count == 0) {
                print $header;
            }
            $count++;

            if ( genfile($benchdir, $benchmark, $impl) ) {
                print "$benchmark ";
		$implcount++;
            }

	    if ($benchdir eq "plugin") {
	        my @ends = ( "_2", "_3" );
		foreach $end (@ends) {
		    my $bmk = $benchmark . $end;
		    my $file = "bench/$benchdir/$bmk" . ".$impl";
		    next unless -s $file;
		    if ( genfile($benchdir, $bmk, $impl) ) {
                        print "$bmk ";
                        $implcount++;
                    }
		}
            }

	}
	print "\n" if ($count > 0);
    }
    print "No updates needed.\n" if ($implcount == 0);
    print "Finished.\n";
}

main();
