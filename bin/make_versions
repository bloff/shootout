#!/usr/bin/perl
# to be run in top directory

BEGIN {
    foreach my $d qw(. .. ../.. ../../..) {
	my $file = "$d/langs.pl";
	if (-f $file) {
	    require $file;
	    last;
	}
    }
}

sub init_php_file {
    local *INCFILE = shift;
    print INCFILE "<?php\n\n";
    print INCFILE "    # Autogenerated file.  Do not hand-edit\n\n";
    print INCFILE "\$LANGS = array(\n";
    print INCFILE "    # Implementation =>\n";
    print INCFILE "    #{ 'Lang' => 'Language',\n";
    print INCFILE "    #  'Home' => 'URL of homepage',\n";
    print INCFILE "    #  'Down' => 'URL of download page',\n";
    print INCFILE "    #  'Type' => native compiled/interpreted bytecode\n";
    print INCFILE "    #}";	# Don't terminate yet
}

sub emit_php_file {
    local *INCFILE = shift;
    my $impl = shift;
    my $lref = shift;
    my $ver = shift;
    print INCFILE ",\n\n";
    print INCFILE "    '$impl' => array(\n";
    print INCFILE "      'Lang'    => '$lref->{Lang}',\n";
    print INCFILE "      'Home'    => '$lref->{Home}',\n";
    print INCFILE "      'Down'    => '$lref->{Down}',\n";
    print INCFILE "      'Type'    => '$lref->{Type}',\n";
    print INCFILE "      'Version' => '$ver'\n";
    print INCFILE "    )";	# Don't end this with a comma yet...
}

sub init_nav_file {
    local *LANGNAVOUT = shift;
    print LANGNAVOUT qq{<!-- Autogenerated file.  Do not hand-edit -->\n};
    print LANGNAVOUT qq{<td id="leftcol" width="20%">\n};
    print LANGNAVOUT qq{ <div id="navcolumn">\n};
    print LANGNAVOUT qq{   <div id="projecttools" class="toolgroup">\n};
    print LANGNAVOUT qq{      <div class="label"><strong>Languages</strong></div>\n};
    print LANGNAVOUT qq{      <div class="body">\n};
}

sub emit_nav_file {
    local *LANGNAVOUT = shift;
    my $lang_type = shift;
    my $impl = shift;
    my $navimpllink = $lang_type;
    if (-d "lang/$impl") {
        $navimpllink = qq{<a href="../../lang/$impl/">$lang_type</a>};
    }
    print LANGNAVOUT qq{        <div>$navimpllink</div>\n};
}

sub emit_version_table {
    $impl = shift;
    $lang = shift;
    $ver = shift;
    $home = shift;
    $down = shift;
    local *OUT;
    
    my $file = "lang/$impl/version.php";
    unless (open(OUT, ">$file")) {
        warn "Warning, can't open $file for output ($!)\n";
	return 1;
    }

    print OUT qq{<td>\n  <div id="bodycol">
    <div class="app" id="lang">
      <div class="h3"><h3>$lang</h3></div>
        <table border="1" cellspacing="2">
          <tr><th align="right">Tested Version</th><td><strong>$ver</strong></td></tr>
	  <tr><th align="right">Home Page</th><td><a href="$home"home</a></td></tr>
          <tr><th align="right">Download</th><td><a href="$down">$down</a></td></tr>
          <tr><th align="right">Build Info:</th>
	    <td>
<!--#if expr="\$BUILD" -->
<!--#echo var="BUILD" -->
<!--#else -->
              <a href="build.$impl">View Build Script</a>
<!--#endif -->
            </td>
          </tr>
          <tr><th colspan="2"><a href="allsrc.php">View All Source Code For $lang</a></th></tr>
        </table>
      </div>};
    close(OUT);
    return 0;
}

sub end_nav_file {
    local *LANGNAVOUT = shift;
    print LANGNAVOUT qq{      </div>
    </div>
    <div class="strut">&nbsp;</div></div></td>};
}

sub end_php_file {
    local *INCFILE = shift;
    print INCFILE "\n);\n";
}

sub main {
    # Create the PHP include file
    my $include_file = "langs.inc";
    unless (open(INCFILE, ">$include_file")) {
        warn "Warning, can't open $include_file for output ($!)\n";
    }
    init_php_file(INCFILE);

    # Create the navigation bar
    my $langnav = "html/langnav.php";
    unless (open(LANGNAVOUT, ">$langnav")) {
        warn "Warning, can't open $langnav for output ($!)\n";
    }
    init_nav_file(LANGNAVOUT);

    # The main version table
    print <<EOF;
<div class="app">
  <div class="h3"><h3>Language List</h3></div>
  <table border="1" cellspacing="2" cellpadding="3">
    <tr>
      <th colspan="2">Language</th>
      <th>Imple-<br>mentation<br><small>(local&nbsp;summary)</small></th>
      <th>Version<br><small>(Official&nbsp;Homepage)</small></th>
    </tr>
EOF
    my $count = 1;
    
    foreach my $impl (sort { $::LANG{$a}->{Lang} cmp $::LANG{$b}->{Lang} } keys %LANG) {
	my $lref = $::LANG{$impl};
	my $ver = $lref->{Verfun}();
	unless ($ver =~ /\d\.?\d/) {
	    print STDERR "Warning Version for $impl may be incorrect: ($ver)\n";
	}

	my $lang = $lref->{Lang};
	my $home = $lref->{Home};
	my $note = $lref->{Note};
	my $lang_type = ($lref->{Type} =~ /native compiled/) ?
	    qq{<b><i>$impl</i></b>} : qq{$impl};

	my $impllink = $lang_type;
	$impllink = qq{<a href="lang/$impl/">$lang_type</a>} if (-d "lang/$impl");
	# Add language to the navbar
	emit_nav_file(LANGNAVOUT, $lang_type, $impl);
	
	$note = ' &nbsp; ' . $note if ($note);
	my $ab = ($count % 2) ? "a" : "b";
	print qq{    <tr class="$ab">
      <td align="right">$count.</td>
      <td>$lang</td>
      <td>$impllink</td>
      <td><a href="$home">$ver</a>$note</td></tr>\n};
	$count++;

	# Include language in the PHP Include file
	emit_php_file(INCFILE, $impl, $lref, $ver);

	# now print out lang version table
	if (emit_version_table($impl, $lang, $ver, $home, $lref->{Down})) {
	    next;
	}
    }

    print qq{    <tr><td colspan="4"><p class="infomark">Languages that compile to native code are in <i><b>Bold Italics</b></i>.</p></td></tr></table></div></div>\n};

    end_nav_file(LANGNAVOUT);
    end_php_file(INCFILE);
    close LANGNAVOUT;
    close INCFILE;
}

main();


