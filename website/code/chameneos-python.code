<span class="slc"># The Computer Language Shootout</span>
<span class="slc"># http://shootout.alioth.debian.org/</span>

<span class="slc"># contributed by Greg Reynolds</span>

<span class="kwc">import</span> sys

n_meetings <span class="sym">=</span> <span class="num">5000</span>

<span class="kwb">if</span> <span class="kwa">len</span><span class="sym">(</span>sys<span class="sym">.</span>argv<span class="sym">) ==</span> <span class="num">2</span><span class="sym">:</span>
    n_meetings <span class="sym">=</span> <span class="kwa">eval</span><span class="sym">(</span>sys<span class="sym">.</span>argv<span class="sym">[</span><span class="num">1</span><span class="sym">])</span>

<span class="kwc">import</span> thread
<span class="kwc">from</span>  threading <span class="kwc">import</span> Thread
<span class="kwc">import</span> mutex

<span class="kwa">class</span> MeetingPlace<span class="sym">:</span>
    <span class="kwb">def</span> <span class="kwd">__init__</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">,</span>n_meetings<span class="sym">):</span>
        <span class="kwc">self</span><span class="sym">.</span>n_meetings <span class="sym">=</span> n_meetings
        <span class="kwc">self</span><span class="sym">.</span>lock <span class="sym">=</span> thread<span class="sym">.</span><span class="kwd">allocate_lock</span><span class="sym">()</span>
        <span class="kwc">self</span><span class="sym">.</span>waiter <span class="sym">=</span> None

    <span class="kwb">def</span> <span class="kwd">request_meeting</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">,</span>c<span class="sym">):</span>
        <span class="kwc">self</span><span class="sym">.</span>lock<span class="sym">.</span><span class="kwd">acquire</span><span class="sym">()</span>
        <span class="kwb">if</span> <span class="kwc">self</span><span class="sym">.</span>n_meetings <span class="sym">&gt;</span> <span class="num">0</span><span class="sym">:</span>
            <span class="kwb">if</span> <span class="kwc">self</span><span class="sym">.</span>waiter <span class="sym">==</span> None<span class="sym">:</span>
                <span class="kwc">self</span><span class="sym">.</span>waiter <span class="sym">=</span> c
            <span class="kwb">elif</span> <span class="kwc">self</span><span class="sym">.</span>waiter <span class="sym">!=</span> c<span class="sym">:</span>
                c<span class="sym">.</span>n_meetings <span class="sym">=</span> c<span class="sym">.</span>n_meetings <span class="sym">+</span> <span class="num">1</span>
                <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>n_meetings <span class="sym">=</span> <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>n_meetings <span class="sym">+</span> <span class="num">1</span>
                <span class="kwc">self</span><span class="sym">.</span>n_meetings <span class="sym">=</span> <span class="kwc">self</span><span class="sym">.</span>n_meetings <span class="sym">-</span> <span class="num">1</span>
                <span class="kwb">if</span> <span class="kwc">self</span><span class="sym">.</span>n_meetings <span class="sym">==</span> <span class="num">0</span><span class="sym">:</span>
                    <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>FADED
                    c<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>FADED
                <span class="kwb">else</span><span class="sym">:</span>
                    <span class="kwb">if</span> c<span class="sym">.</span>colour <span class="sym">!=</span> <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour<span class="sym">:</span>
                        <span class="kwb">if</span> c<span class="sym">.</span>colour<span class="sym">==</span>Chameneos<span class="sym">.</span>BLUE <span class="kwb">and</span> <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">==</span> Chameneos<span class="sym">.</span>YELLOW<span class="sym">:</span>
                            c<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>RED
                            <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>RED
                        <span class="kwb">elif</span> c<span class="sym">.</span>colour<span class="sym">==</span>Chameneos<span class="sym">.</span>BLUE <span class="kwb">and</span> <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">==</span> Chameneos<span class="sym">.</span>RED<span class="sym">:</span>
                            c<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>YELLOW
                            <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>YELLOW
                        <span class="kwb">elif</span> c<span class="sym">.</span>colour<span class="sym">==</span>Chameneos<span class="sym">.</span>RED <span class="kwb">and</span> <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">==</span> Chameneos<span class="sym">.</span>BLUE<span class="sym">:</span>
                            c<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>YELLOW
                            <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>YELLOW
                        <span class="kwb">elif</span> c<span class="sym">.</span>colour<span class="sym">==</span>Chameneos<span class="sym">.</span>RED <span class="kwb">and</span> <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">==</span> Chameneos<span class="sym">.</span>YELLOW<span class="sym">:</span>
                            c<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>BLUE
                            <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>BLUE
                        <span class="kwb">elif</span> c<span class="sym">.</span>colour<span class="sym">==</span>Chameneos<span class="sym">.</span>YELLOW <span class="kwb">and</span> <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour<span class="sym">==</span> Chameneos<span class="sym">.</span>BLUE<span class="sym">:</span>
                            c<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>RED
                            <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>RED
                        <span class="kwb">elif</span> c<span class="sym">.</span>colour<span class="sym">==</span>Chameneos<span class="sym">.</span>YELLOW <span class="kwb">and</span> <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">==</span> Chameneos<span class="sym">.</span>RED<span class="sym">:</span>
                            c<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>BLUE
                            <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>BLUE
                        <span class="kwb">else</span><span class="sym">:</span>
                            c<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>FADED
                            <span class="kwc">self</span><span class="sym">.</span>waiter<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>FADED

                <span class="kwc">self</span><span class="sym">.</span>waiter <span class="sym">=</span> None
        <span class="kwb">else</span><span class="sym">:</span>
            c<span class="sym">.</span>colour <span class="sym">=</span> Chameneos<span class="sym">.</span>FADED
        <span class="kwc">self</span><span class="sym">.</span>lock<span class="sym">.</span><span class="kwd">release</span><span class="sym">()</span>


<span class="kwa">class</span> <span class="kwd">Chameneos</span><span class="sym">(</span>Thread<span class="sym">):</span>
    YELLOW <span class="sym">=</span> <span class="num">0</span>
    BLUE   <span class="sym">=</span> <span class="num">1</span>
    RED    <span class="sym">=</span> <span class="num">2</span>
    FADED  <span class="sym">=</span> <span class="num">3</span>

    <span class="kwb">def</span> <span class="kwd">__init__</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">,</span>colour<span class="sym">,</span>meeting_place<span class="sym">):</span>
        Thread<span class="sym">.</span><span class="kwd">__init__</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">)</span>
        <span class="kwc">self</span><span class="sym">.</span>colour <span class="sym">=</span> colour
        <span class="kwc">self</span><span class="sym">.</span>meeting_place <span class="sym">=</span> meeting_place
        <span class="kwc">self</span><span class="sym">.</span>n_meetings <span class="sym">=</span> <span class="num">0</span>

    <span class="kwb">def</span> <span class="kwd">run</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">):</span>
        <span class="kwb">while</span> <span class="kwc">self</span><span class="sym">.</span>colour <span class="sym">!=</span> Chameneos<span class="sym">.</span>FADED<span class="sym">:</span>
            <span class="kwc">self</span><span class="sym">.</span>meeting_place<span class="sym">.</span><span class="kwd">request_meeting</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">)</span>

mp <span class="sym">=</span> <span class="kwd">MeetingPlace</span><span class="sym">(</span>n_meetings<span class="sym">)</span>
c_list <span class="sym">= []</span>
<span class="kwb">for</span> colour <span class="kwb">in</span> <span class="sym">[</span>Chameneos<span class="sym">.</span>BLUE<span class="sym">,</span> Chameneos<span class="sym">.</span>RED<span class="sym">,</span> Chameneos<span class="sym">.</span>YELLOW<span class="sym">,</span> Chameneos<span class="sym">.</span>BLUE<span class="sym">]:</span>
    c_list<span class="sym">.</span><span class="kwd">append</span><span class="sym">(</span><span class="kwd">Chameneos</span><span class="sym">(</span>colour<span class="sym">,</span>mp<span class="sym">))</span>

<span class="kwb">for</span> c <span class="kwb">in</span> c_list<span class="sym">:</span>
    c<span class="sym">.</span><span class="kwd">start</span><span class="sym">()</span>

<span class="kwb">for</span> c <span class="kwb">in</span> c_list<span class="sym">:</span>
    c<span class="sym">.</span><span class="kwd">join</span><span class="sym">()</span>

<span class="kwb">print</span> <span class="kwa">reduce</span><span class="sym">(</span><span class="kwa">lambda</span> x<span class="sym">,</span> y<span class="sym">:</span> x <span class="sym">+</span> y<span class="sym">.</span>n_meetings<span class="sym">,</span>c_list<span class="sym">,</span><span class="num">0</span><span class="sym">)</span>





