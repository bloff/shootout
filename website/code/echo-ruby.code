<table width="100%" border="0" cellpadding="5" cellspacing="0"><tr><td bgcolor="#FFFFFF"><pre>
<I><FONT COLOR="#B22222">#!/usr/bin/ruby
</FONT></I><I><FONT COLOR="#B22222"># -*- mode: ruby -*-
</FONT></I><I><FONT COLOR="#B22222"># $Id: echo-ruby.code,v 1.2 2004-11-08 08:15:12 bfulgham Exp $
</FONT></I><I><FONT COLOR="#B22222"># http://www.bagley.org/~doug/shootout/
</FONT></I>
<B><FONT COLOR="#5F9EA0">require</FONT></B> <B><FONT COLOR="#BC8F8F">&quot;socket&quot;</FONT></B>

DATA = <B><FONT COLOR="#BC8F8F">&quot;Hello there sailor\n&quot;</FONT></B>

<B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">echo_client</FONT></B>(n, port)
    sock = TCPsocket.open(<B><FONT COLOR="#BC8F8F">'127.0.0.1'</FONT></B>, port)
    n.times <B><FONT COLOR="#A020F0">do</FONT></B>
	sock.write(DATA)
	ans = sock.readline
	<B><FONT COLOR="#A020F0">if</FONT></B> ans <B><FONT COLOR="#5F9EA0">!=</FONT></B> DATA <B><FONT COLOR="#A020F0">then</FONT></B>
	    <B><FONT COLOR="#5F9EA0">raise</FONT></B> sprintf(<B><FONT COLOR="#BC8F8F">&quot;client: \&quot;%s\&quot; \&quot;%s\&quot;&quot;</FONT></B>, DATA, ans)
	<B><FONT COLOR="#A020F0">end</FONT></B>
    <B><FONT COLOR="#A020F0">end</FONT></B>
    sock.close
<B><FONT COLOR="#A020F0">end</FONT></B>


<B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">echo_server</FONT></B>(n)
    ssock = TCPserver.open(<B><FONT COLOR="#BC8F8F">'127.0.0.1'</FONT></B>, 0)
    port = ssock.addr[1]
    <B><FONT COLOR="#A020F0">if</FONT></B> pid = fork <B><FONT COLOR="#A020F0">then</FONT></B>
	<I><FONT COLOR="#B22222"># parent is server
</FONT></I>	csock = ssock.accept
	n = 0
	<B><FONT COLOR="#A020F0">while</FONT></B> str = csock.gets
	    n += csock.write(str)
	<B><FONT COLOR="#A020F0">end</FONT></B>
	Process.wait
        printf <B><FONT COLOR="#BC8F8F">&quot;server processed %d bytes\n&quot;</FONT></B>, n
    <B><FONT COLOR="#A020F0">else</FONT></B>
	<I><FONT COLOR="#B22222"># child is client
</FONT></I>	echo_client(n, port)
    <B><FONT COLOR="#A020F0">end</FONT></B>
<B><FONT COLOR="#A020F0">end</FONT></B>

echo_server(Integer(ARGV.shift || 1))</pre></td></tr></table>
