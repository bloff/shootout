<table width="100%" border="0" cellpadding="5" cellspacing="0"><tr><td bgcolor="#FFFFFF"><pre>
<B><FONT COLOR="#BC8F8F">&quot;  The Great Computer Language Shootout
   contributed by Paolo Bonzini

   To run: gst -QI /usr/local/share/smalltalk/gst.im prodcons.st -a 100000 
&quot;</FONT></B>

| mutex empty full data consumed produced n <B><FONT COLOR="#A020F0">join</FONT></B> |
n := Smalltalk arguments isEmpty
   ifTrue: [ 10000 ]
   ifFalse: [ 1 max: Smalltalk arguments first asInteger ].

mutex := Semaphore forMutualExclusion.
empty := Semaphore <B><FONT COLOR="#A020F0">new</FONT></B>.
full := Semaphore <B><FONT COLOR="#A020F0">new</FONT></B>.
consumed := produced := 0.

<B><FONT COLOR="#A020F0">join</FONT></B> := Semaphore <B><FONT COLOR="#A020F0">new</FONT></B>.

empty signal.

[
   | i |
   i := 0.
   [
      full <B><FONT COLOR="#A020F0">wait</FONT></B>.
      mutex <B><FONT COLOR="#A020F0">wait</FONT></B>.
      i := data.
      mutex signal.
      empty signal.
      consumed := consumed + 1.
      i = n
    ] whileFalse.

    <B><FONT COLOR="#A020F0">join</FONT></B> signal.
] <B><FONT COLOR="#A020F0">fork</FONT></B>.


[
   1 to: n <B><FONT COLOR="#A020F0">do</FONT></B>: [ :i |
      empty <B><FONT COLOR="#A020F0">wait</FONT></B>.
      mutex <B><FONT COLOR="#A020F0">wait</FONT></B>.
      data := i.
      mutex signal.
      full signal.
      produced := produced + 1.
   ].

   <B><FONT COLOR="#A020F0">join</FONT></B> signal.
] <B><FONT COLOR="#A020F0">fork</FONT></B>.

<B><FONT COLOR="#A020F0">join</FONT></B> <B><FONT COLOR="#A020F0">wait</FONT></B>.
<B><FONT COLOR="#A020F0">join</FONT></B> <B><FONT COLOR="#A020F0">wait</FONT></B>.

(<B><FONT COLOR="#BC8F8F">'%1 %2'</FONT></B> bindWith: produced with: consumed) displayNl !</pre></td></tr></table>
