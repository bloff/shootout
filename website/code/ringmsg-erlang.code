<table width="100%" border="0" cellpadding="5" cellspacing="0"><tr><td bgcolor="#FFFFFF"><pre>
<I><FONT COLOR="#B22222">%%% -*- mode: erlang -*-
</FONT></I><I><FONT COLOR="#B22222">%%% $Id: ringmsg-erlang.code,v 1.1 2004-11-02 08:53:24 bfulgham Exp $
</FONT></I><I><FONT COLOR="#B22222">%%% http://shootout.alioth.debian.org/
</FONT></I>
<B><FONT COLOR="#5F9EA0">-module</FONT></B>(ringmsg).
<B><FONT COLOR="#5F9EA0">-export</FONT></B>([main/0, main/1]).

<B><FONT COLOR="#5F9EA0">-define</FONT></B>( <B><FONT COLOR="#DA70D6">WORK_HARD</FONT></B>, 10).
<B><FONT COLOR="#5F9EA0">-define</FONT></B>( <B><FONT COLOR="#DA70D6">NUMBER_OF_PROCESSES</FONT></B>, 8192).

<B><FONT COLOR="#0000FF">main</FONT></B>() -&gt; main([<B><FONT COLOR="#BC8F8F">'1'</FONT></B>]).
<B><FONT COLOR="#0000FF">main</FONT></B>([<FONT COLOR="#B8860B">Arg1</FONT>]) -&gt;
	<FONT COLOR="#B8860B">Number_of_Messages</FONT> = atom_to_integer( <FONT COLOR="#B8860B">Arg1</FONT> ),
	<FONT COLOR="#B8860B">Last_Message</FONT> = ring( ?<B><FONT COLOR="#DA70D6">NUMBER_OF_PROCESSES</FONT></B>, <FONT COLOR="#B8860B">Number_of_Messages</FONT> ),
	io:fwrite( <B><FONT COLOR="#BC8F8F">&quot;~w\n&quot;</FONT></B>, [<FONT COLOR="#B8860B">Last_Message</FONT>] ),
	erlang:<B><FONT COLOR="#A020F0">halt</FONT></B>().


<B><FONT COLOR="#0000FF">atom_to_integer</FONT></B>( <FONT COLOR="#B8860B">Atom</FONT> ) -&gt;
	erlang:<B><FONT COLOR="#A020F0">list_to_integer</FONT></B>(erlang:<B><FONT COLOR="#A020F0">atom_to_list</FONT></B>(<FONT COLOR="#B8860B">Atom</FONT>)).


<B><FONT COLOR="#0000FF">ring</FONT></B>( <FONT COLOR="#B8860B">N</FONT>, <FONT COLOR="#B8860B">Number_of_Messages</FONT> ) -&gt;
	<FONT COLOR="#B8860B">First_Pid</FONT> = erlang:<B><FONT COLOR="#A020F0">self</FONT></B>(),
	<FONT COLOR="#B8860B">Second_Pid</FONT> = erlang:<B><FONT COLOR="#A020F0">spawn</FONT></B>( <B><FONT COLOR="#A020F0">fun</FONT></B>() -&gt; init_process(<FONT COLOR="#B8860B">N</FONT>, <FONT COLOR="#B8860B">First_Pid</FONT>, <FONT COLOR="#B8860B">First_Pid</FONT>) <B><FONT COLOR="#A020F0">end</FONT></B> ),
	first_process_loop(<FONT COLOR="#B8860B">Number_of_Messages</FONT>, <FONT COLOR="#B8860B">Second_Pid</FONT>, the_ring, asd, ?<B><FONT COLOR="#DA70D6">WORK_HARD</FONT></B>).


<B><FONT COLOR="#0000FF">init_process</FONT></B>( 0, <FONT COLOR="#B8860B">Previous_Pid</FONT>, <FONT COLOR="#B8860B">First_Pid</FONT> ) -&gt;
	loop( <FONT COLOR="#B8860B">Previous_Pid</FONT>,  erlang:<B><FONT COLOR="#A020F0">self</FONT></B>(), <FONT COLOR="#B8860B">First_Pid</FONT>, ?<B><FONT COLOR="#DA70D6">WORK_HARD</FONT></B> );
<B><FONT COLOR="#0000FF">init_process</FONT></B>( <FONT COLOR="#B8860B">N</FONT>,  <FONT COLOR="#B8860B">Previous_Pid</FONT>, <FONT COLOR="#B8860B">First_Pid</FONT> ) -&gt;
	<FONT COLOR="#B8860B">My_Pid</FONT> = erlang:<B><FONT COLOR="#A020F0">self</FONT></B>(),
	<FONT COLOR="#B8860B">Next_Pid</FONT> = erlang:<B><FONT COLOR="#A020F0">spawn</FONT></B>( <B><FONT COLOR="#A020F0">fun</FONT></B>() -&gt; init_process(<FONT COLOR="#B8860B">N</FONT>-1, <FONT COLOR="#B8860B">My_Pid</FONT>, <FONT COLOR="#B8860B">First_Pid</FONT>) <B><FONT COLOR="#A020F0">end</FONT></B> ),
	loop( <FONT COLOR="#B8860B">Previous_Pid</FONT>,  <FONT COLOR="#B8860B">My_Pid</FONT>, <FONT COLOR="#B8860B">Next_Pid</FONT>, ?<B><FONT COLOR="#DA70D6">WORK_HARD</FONT></B> ).


<B><FONT COLOR="#0000FF">loop</FONT></B>( <FONT COLOR="#B8860B">Previous_Pid</FONT>, <FONT COLOR="#B8860B">My_Pid</FONT>, <FONT COLOR="#B8860B">Next_Pid</FONT>, 0 ) -&gt;
	<B><FONT COLOR="#A020F0">receive</FONT></B>
	low_priority_message -&gt;
		loop( <FONT COLOR="#B8860B">Previous_Pid</FONT>,  <FONT COLOR="#B8860B">My_Pid</FONT>, <FONT COLOR="#B8860B">Next_Pid</FONT>, 0 )
	<B><FONT COLOR="#A020F0">after</FONT></B> 0 -&gt;
		loop( <FONT COLOR="#B8860B">Previous_Pid</FONT>,  <FONT COLOR="#B8860B">My_Pid</FONT>, <FONT COLOR="#B8860B">Next_Pid</FONT>, ?<B><FONT COLOR="#DA70D6">WORK_HARD</FONT></B> )
	<B><FONT COLOR="#A020F0">end</FONT></B>;
<B><FONT COLOR="#0000FF">loop</FONT></B>( <FONT COLOR="#B8860B">Previous_Pid</FONT>, <FONT COLOR="#B8860B">My_Pid</FONT>, <FONT COLOR="#B8860B">Next_Pid</FONT>, <FONT COLOR="#B8860B">Work</FONT> ) -&gt;
	<B><FONT COLOR="#A020F0">receive</FONT></B>
	{<FONT COLOR="#B8860B">Previous_Pid</FONT>, <FONT COLOR="#B8860B">Message</FONT>} -&gt;
		<FONT COLOR="#B8860B">Next_Pid</FONT> ! {<FONT COLOR="#B8860B">My_Pid</FONT>, <FONT COLOR="#B8860B">Message</FONT>},
		<FONT COLOR="#B8860B">Next_Pid</FONT> ! low_priority_message,
		loop( <FONT COLOR="#B8860B">Previous_Pid</FONT>,  <FONT COLOR="#B8860B">My_Pid</FONT>, <FONT COLOR="#B8860B">Next_Pid</FONT>, <FONT COLOR="#B8860B">Work</FONT> - 1 )
	<B><FONT COLOR="#A020F0">end</FONT></B>.


<B><FONT COLOR="#0000FF">first_process_loop</FONT></B>( 0, <FONT COLOR="#B8860B">_First_Pid</FONT>, <FONT COLOR="#B8860B">_Send_Message</FONT>, <FONT COLOR="#B8860B">Receive_Message</FONT>, <FONT COLOR="#B8860B">_Work</FONT>) -&gt;
	<FONT COLOR="#B8860B">Receive_Message</FONT>;
<B><FONT COLOR="#0000FF">first_process_loop</FONT></B>( <FONT COLOR="#B8860B">N</FONT>, <FONT COLOR="#B8860B">First_Pid</FONT>, <FONT COLOR="#B8860B">Message</FONT>, <FONT COLOR="#B8860B">Previous_In</FONT>, 0) -&gt;
	<B><FONT COLOR="#A020F0">receive</FONT></B>
	low_priority_message -&gt;
		first_process_loop(<FONT COLOR="#B8860B">N</FONT>, <FONT COLOR="#B8860B">First_Pid</FONT>, <FONT COLOR="#B8860B">Message</FONT>, <FONT COLOR="#B8860B">Previous_In</FONT>, 0)
	<B><FONT COLOR="#A020F0">after</FONT></B> 0 -&gt;
		first_process_loop( <FONT COLOR="#B8860B">N</FONT>, <FONT COLOR="#B8860B">First_Pid</FONT>, <FONT COLOR="#B8860B">Message</FONT>, <FONT COLOR="#B8860B">Previous_In</FONT>, ?<B><FONT COLOR="#DA70D6">WORK_HARD</FONT></B> )
	<B><FONT COLOR="#A020F0">end</FONT></B>;
<B><FONT COLOR="#0000FF">first_process_loop</FONT></B>( <FONT COLOR="#B8860B">N</FONT>, <FONT COLOR="#B8860B">First_Pid</FONT>, <FONT COLOR="#B8860B">Message</FONT>, <FONT COLOR="#B8860B">_Previous_In</FONT>, <FONT COLOR="#B8860B">Work</FONT>) -&gt;
	<FONT COLOR="#B8860B">First_Pid</FONT> ! {erlang:<B><FONT COLOR="#A020F0">self</FONT></B>(), <FONT COLOR="#B8860B">Message</FONT>},
	<FONT COLOR="#B8860B">First_Pid</FONT> ! low_priority_message,
	<B><FONT COLOR="#A020F0">receive</FONT></B>
	{<FONT COLOR="#B8860B">_Last_Pid</FONT>, <FONT COLOR="#B8860B">Input</FONT>} -&gt;
		first_process_loop( <FONT COLOR="#B8860B">N</FONT>-1, <FONT COLOR="#B8860B">First_Pid</FONT>, <FONT COLOR="#B8860B">Message</FONT>, <FONT COLOR="#B8860B">Input</FONT>, <FONT COLOR="#B8860B">Work</FONT> - 1)
	<B><FONT COLOR="#A020F0">end</FONT></B>.</pre></td></tr></table>
