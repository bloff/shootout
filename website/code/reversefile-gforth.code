<table width="100%" border="0" cellpadding="5" cellspacing="0"><tr><td bgcolor="#FFFFFF"><pre>
<I><FONT COLOR="#B22222">\ -*- mode: forth -*-
</FONT></I><I><FONT COLOR="#B22222">\ $Id: reversefile-gforth.code,v 1.1 2004-11-02 08:52:54 bfulgham Exp $
</FONT></I><I><FONT COLOR="#B22222">\ http://www.bagley.org/~doug/shootout/
</FONT></I>
<I><FONT COLOR="#B22222">\ TBD - we still need to start the size at 4096 and grow only
</FONT></I><I><FONT COLOR="#B22222">\ when necessary.
</FONT></I>
<B><FONT COLOR="#A020F0">variable</FONT></B> size    2000000                  size <B><FONT COLOR="#5F9EA0">!</FONT></B>
<B><FONT COLOR="#A020F0">variable</FONT></B> sbuf    size @ allocate <B><FONT COLOR="#5F9EA0">throw</FONT></B>    sbuf <B><FONT COLOR="#5F9EA0">!</FONT></B>

10   <B><FONT COLOR="#A020F0">constant</FONT></B>  nl_ch
4096 <B><FONT COLOR="#A020F0">constant</FONT></B>  MAXREAD

<B><FONT COLOR="#A020F0">: </FONT></B><B><FONT COLOR="#0000FF"><B><I><FONT COLOR="#000000">add_terminal_newline</FONT></I></B></FONT></B> ( addr <B><FONT COLOR="#5F9EA0">-</FONT></B><B><FONT COLOR="#5F9EA0">-</FONT></B> addr )
    <B><FONT COLOR="#5F9EA0">dup</FONT></B> c@ nl_ch <B><FONT COLOR="#5F9EA0">&lt;&gt;</FONT></B>
    <B><FONT COLOR="#A020F0">if</FONT></B>
	<B><FONT COLOR="#5F9EA0">dup</FONT></B> nl_ch <B><FONT COLOR="#5F9EA0">swap</FONT></B> c<B><FONT COLOR="#5F9EA0">!</FONT></B>
	1 <B><FONT COLOR="#5F9EA0">+</FONT></B>
    <B><FONT COLOR="#A020F0">endif</FONT></B> ;

<B><FONT COLOR="#A020F0">: </FONT></B><B><FONT COLOR="#0000FF"><B><I><FONT COLOR="#000000">reversefile</FONT></I></B></FONT></B> ( <B><FONT COLOR="#5F9EA0">-</FONT></B><B><FONT COLOR="#5F9EA0">-</FONT></B> )
     nl_ch sbuf @ c<B><FONT COLOR="#5F9EA0">!</FONT></B>
    sbuf @ 1 <B><FONT COLOR="#5F9EA0">+</FONT></B>
    <B><FONT COLOR="#5F9EA0">dup</FONT></B> <B><FONT COLOR="#5F9EA0">dup</FONT></B>
    <B><FONT COLOR="#A020F0">begin</FONT></B>
        MAXREAD stdin read<B><FONT COLOR="#5F9EA0">-</FONT></B>file <B><FONT COLOR="#5F9EA0">throw</FONT></B> <B><FONT COLOR="#5F9EA0">dup</FONT></B>
    <B><FONT COLOR="#A020F0">while</FONT></B>
	<I><FONT COLOR="#B22222">\ add number of bytes read to current buffer position
</FONT></I>	<B><FONT COLOR="#5F9EA0">+</FONT></B> <B><FONT COLOR="#5F9EA0">dup</FONT></B>
	<I><FONT COLOR="#B22222">\ now stack has start-of-buffer end-of-buffer addresses
</FONT></I>    <B><FONT COLOR="#A020F0">repeat</FONT></B>
    <B><FONT COLOR="#5F9EA0">drop</FONT></B>
    <I><FONT COLOR="#B22222">\ stack: start-of-buffer end-of-buffer
</FONT></I>
    <I><FONT COLOR="#B22222">\ if input didn't end in a newline, then add one
</FONT></I>    add_terminal_newline

    <I><FONT COLOR="#B22222">\ adjust end pointer
</FONT></I>    2 <B><FONT COLOR="#5F9EA0">-</FONT></B>

    <I><FONT COLOR="#B22222">\ adjust start pointer
</FONT></I>    <B><FONT COLOR="#5F9EA0">swap</FONT></B> 2 <B><FONT COLOR="#5F9EA0">-</FONT></B> <B><FONT COLOR="#5F9EA0">swap</FONT></B>

    <I><FONT COLOR="#B22222">\ now scan the buffer backwards, printing out the lines
</FONT></I>    <B><FONT COLOR="#5F9EA0">tuck</FONT></B>
    <B><FONT COLOR="#5F9EA0">-</FONT></B><B><FONT COLOR="#A020F0">do</FONT></B>
	<I><FONT COLOR="#B22222">\ stack: pointer to end of buffer
</FONT></I>	i c@ nl_ch =
	<B><FONT COLOR="#A020F0">if</FONT></B>
	    <B><FONT COLOR="#5F9EA0">dup</FONT></B> i 1 <B><FONT COLOR="#5F9EA0">+</FONT></B> <B><FONT COLOR="#5F9EA0">swap</FONT></B> i <B><FONT COLOR="#5F9EA0">-</FONT></B>
	    stdout write<B><FONT COLOR="#5F9EA0">-</FONT></B>file <B><FONT COLOR="#5F9EA0">throw</FONT></B>
	    <B><FONT COLOR="#5F9EA0">drop</FONT></B>
	    i
	<B><FONT COLOR="#A020F0">endif</FONT></B>
    1 <B><FONT COLOR="#5F9EA0">-</FONT></B><B><FONT COLOR="#A020F0">loop</FONT></B>
    ;

reversefile

<B><FONT COLOR="#5F9EA0">bye</FONT></B> <I><FONT COLOR="#B22222">\ th-th-that's all folks!
</FONT></I></pre></td></tr></table>
