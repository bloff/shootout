<span class="slc">% ----------------------------------------------------------------------</span>
<span class="slc">% The Computer Language Shootout</span>
<span class="slc">% http://shootout.alioth.debian.org/</span>
<span class="slc">%</span>
<span class="slc">% Contributed by Anthony Borla [with thanks to Kevin Glynn]</span>
<span class="slc">% Further modified by YANG Shouxun</span>
<span class="slc">% ----------------------------------------------------------------------</span>

<span class="kwa">functor</span>

<span class="kwa">import</span>
  System<span class="sym">(</span>showInfo<span class="sym">)</span> Application<span class="sym">(</span>exit<span class="sym">)</span> Open<span class="sym">(</span>file text<span class="sym">)</span>
  Regex <span class="kwb">at</span> <span class="str">'x-oz://contrib/regex'</span>

<span class="kwb">define</span>

<span class="slc">% ------------- %</span>

  VARIANTS <span class="sym">= [</span>
    <span class="str">&quot;agggtaaa|tttaccct&quot;</span> <span class="str">&quot;[cgt]gggtaaa|tttaccc[acg]&quot;</span>
    <span class="str">&quot;a[act]ggtaaa|tttacc[agt]t&quot;</span> <span class="str">&quot;ag[act]gtaaa|tttac[agt]ct&quot;</span>
    <span class="str">&quot;agg[act]taaa|ttta[agt]cct&quot;</span> <span class="str">&quot;aggg[acg]aaa|ttt[cgt]ccct&quot;</span>
    <span class="str">&quot;agggt[cgt]aa|tt[acg]accct&quot;</span> <span class="str">&quot;agggta[cgt]a|t[acg]taccct&quot;</span>
    <span class="str">&quot;agggtaa[cgt]|[acg]ttaccct&quot;</span><span class="sym">]</span>

  IUBS <span class="sym">= [</span><span class="str">&quot;B&quot;</span>#<span class="str">&quot;(c|g|t)&quot;</span> <span class="str">&quot;D&quot;</span>#<span class="str">&quot;(a|g|t)&quot;</span> <span class="str">&quot;H&quot;</span>#<span class="str">&quot;(a|c|t)&quot;</span> <span class="str">&quot;K&quot;</span>#<span class="str">&quot;(g|t)&quot;</span>
	  <span class="str">&quot;M&quot;</span>#<span class="str">&quot;(a|c)&quot;</span> <span class="str">&quot;N&quot;</span>#<span class="str">&quot;(a|c|g|t)&quot;</span> <span class="str">&quot;R&quot;</span>#<span class="str">&quot;(a|g)&quot;</span> <span class="str">&quot;S&quot;</span>#<span class="str">&quot;(c|g)&quot;</span>
	  <span class="str">&quot;V&quot;</span>#<span class="str">&quot;(a|c|g)&quot;</span> <span class="str">&quot;W&quot;</span>#<span class="str">&quot;(a|t)&quot;</span> <span class="str">&quot;Y&quot;</span>#<span class="str">&quot;(c|t)&quot;</span><span class="sym">]</span>

  LF <span class="sym">=</span> <span class="str">&quot;</span><span class="esc">\n</span><span class="str">&quot;</span>

<span class="slc">% ------------- %</span>

  <span class="kwa">class</span> TextFile_
    <span class="kwb">from</span> Open.file Open.text
  <span class="kwb">end</span>

<span class="slc">% ------------- %</span>

  Initial_Length Code_Length SEQ <span class="sym">= {</span>NewCell <span class="kwa">nil</span><span class="sym">}</span>

<span class="slc">% ------------- %</span>

<span class="kwb">in</span>
  <span class="slc">% Load file as a list and record its length</span>
  SEQ <span class="sym">:= {{</span>New TextFile_ init<span class="sym">(</span>name<span class="sym">:</span>stdin<span class="sym">)}</span> read<span class="sym">(</span>list<span class="sym">:</span>$ size<span class="sym">:</span>all<span class="sym">)}</span>
  Initial_Length <span class="sym">= {</span>Length &#64;SEQ<span class="sym">}</span>

  <span class="slc">% Remove newline and segment divider line occurrences</span>
  SEQ <span class="sym">:= {</span>Regex.replace &#64;SEQ <span class="sym">{</span>Regex.make <span class="str">&quot;(&gt;.*</span><span class="esc">\n</span><span class="str">)|(</span><span class="esc">\n</span><span class="str">)&quot;</span><span class="sym">}</span> <span class="kwb">fun</span> <span class="sym">{</span>$ X Y<span class="sym">}</span> <span class="str">&quot;&quot;</span> <span class="kwb">end</span><span class="sym">}</span>
  Code_Length <span class="sym">= {</span>ByteString.length &#64;SEQ<span class="sym">}</span>

  <span class="slc">% Perform regexp counts</span>
  <span class="kwb">for</span> Item <span class="kwb">in</span> VARIANTS <span class="kwb">do</span>
    <span class="sym">{</span>System.showInfo Item # <span class="str">&quot; &quot;</span> # <span class="sym">{</span>Length <span class="sym">{</span>Regex.allMatches <span class="sym">{</span>Regex.compile Item <span class="sym">[</span>icase extended<span class="sym">]}</span> &#64;SEQ<span class="sym">}}}</span>
  <span class="kwb">end</span>

  <span class="slc">% Perform replacements</span>
  <span class="kwb">for</span> Key#S <span class="kwb">in</span> IUBS <span class="kwb">do</span>
     SEQ <span class="sym">:= {</span>Regex.replace &#64;SEQ <span class="sym">{</span>Regex.compile Key <span class="sym">[</span>icase<span class="sym">]}</span> <span class="kwb">fun</span> <span class="sym">{</span>$ X Y<span class="sym">}</span> S <span class="kwb">end</span><span class="sym">}</span>
  <span class="kwb">end</span>

  <span class="slc">% Print statistics</span>
  <span class="sym">{</span>System.showInfo LF # Initial_Length # LF # Code_Length # LF # <span class="sym">{</span>ByteString.length &#64;SEQ<span class="sym">}}</span>

  <span class="sym">{</span>Application.exit <span class="num">0</span><span class="sym">}</span>
<span class="kwb">end</span>
