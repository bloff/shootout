<span class="line">    1 </span><span class="slc">#!/usr/bin/perl
</span><span class="line">    2 </span><span class="slc"></span><span class="slc"># $Id: echo-perl.code,v 1.4 2004-11-13 07:41:30 bfulgham Exp $
</span><span class="line">    3 </span><span class="slc"></span><span class="slc"># http://www.bagley.org/~doug/shootout/
</span><span class="line">    4 </span><span class="slc"></span>
<span class="line">    5 </span><span class="kwa">use</span> Socket<span class="sym">;
</span><span class="line">    6 </span><span class="sym">
</span><span class="line">    7 </span><span class="sym"></span><span class="kwc">my</span> <span class="kwb">$DATA</span> <span class="sym">=</span> <span class="str">&quot;Hello there sailor</span><span class="esc">\n</span><span class="str">&quot;</span><span class="sym">;
</span><span class="line">    8 </span><span class="sym">
</span><span class="line">    9 </span><span class="sym"></span><span class="kwa">sub</span> server_sock <span class="sym">{
</span><span class="line">   10 </span><span class="sym"></span>    local <span class="sym">*</span>SS<span class="sym">;
</span><span class="line">   11 </span><span class="sym"></span>    socket<span class="sym">(</span>SS<span class="sym">,</span> PF_INET<span class="sym">,</span> SOCK_STREAM<span class="sym">,</span> <span class="num">0</span><span class="sym">)</span> <span class="kwa">or
</span><span class="line">   12 </span><span class="kwa"></span>        die <span class="str">&quot;server/socket ($!)&quot;</span><span class="sym">;
</span><span class="line">   13 </span><span class="sym"></span>    setsockopt<span class="sym">(</span>SS<span class="sym">,</span> SOL_SOCKET<span class="sym">,</span> SO_REUSEADDR<span class="sym">,</span> pack<span class="sym">(</span><span class="str">&quot;l&quot;</span><span class="sym">,</span> <span class="num">1</span><span class="sym">))</span> <span class="kwa">or
</span><span class="line">   14 </span><span class="kwa"></span>        die <span class="str">&quot;server/setsockopt ($!)&quot;</span><span class="sym">;
</span><span class="line">   15 </span><span class="sym"></span>    bind<span class="sym">(</span>SS<span class="sym">,</span> sockaddr_in<span class="sym">(</span><span class="num">0</span><span class="sym">,</span> INADDR_LOOPBACK<span class="sym">))</span> <span class="kwa">or
</span><span class="line">   16 </span><span class="kwa"></span>        die <span class="str">&quot;server/bind ($!)&quot;</span><span class="sym">;
</span><span class="line">   17 </span><span class="sym"></span>    listen<span class="sym">(</span>SS<span class="sym">,</span> <span class="num">2</span><span class="sym">);
</span><span class="line">   18 </span><span class="sym"></span>    <span class="kwa">return</span><span class="sym">(*</span>SS<span class="sym">);
</span><span class="line">   19 </span><span class="sym">}
</span><span class="line">   20 </span><span class="sym">
</span><span class="line">   21 </span><span class="sym"></span><span class="kwa">sub</span> get_port <span class="sym">{
</span><span class="line">   22 </span><span class="sym"></span>    local <span class="sym">*</span>SK <span class="sym">=</span> shift<span class="sym">;
</span><span class="line">   23 </span><span class="sym">    (</span>sockaddr_in<span class="sym">(</span>getsockname<span class="sym">(</span>SK<span class="sym">)))[</span><span class="num">0</span><span class="sym">];
</span><span class="line">   24 </span><span class="sym">}
</span><span class="line">   25 </span><span class="sym">
</span><span class="line">   26 </span><span class="sym"></span><span class="kwa">sub</span> client_sock <span class="sym">{
</span><span class="line">   27 </span><span class="sym"></span>    <span class="kwc">my</span> <span class="kwb">$port</span> <span class="sym">=</span> shift<span class="sym">;
</span><span class="line">   28 </span><span class="sym"></span>    local <span class="sym">*</span>CS<span class="sym">;
</span><span class="line">   29 </span><span class="sym"></span>    socket<span class="sym">(</span>CS<span class="sym">,</span> PF_INET<span class="sym">,</span> SOCK_STREAM<span class="sym">,</span> getprotobyname<span class="sym">(</span><span class="str">'tcp'</span><span class="sym">))</span> <span class="kwa">or
</span><span class="line">   30 </span><span class="kwa"></span>        die <span class="str">&quot;client/socket ($!)&quot;</span><span class="sym">;
</span><span class="line">   31 </span><span class="sym"></span>    connect<span class="sym">(</span>CS<span class="sym">,</span> sockaddr_in<span class="sym">(</span><span class="kwb">$port</span><span class="sym">,</span> INADDR_LOOPBACK<span class="sym">))</span> <span class="kwa">or
</span><span class="line">   32 </span><span class="kwa"></span>        die <span class="str">&quot;client/connect ($!)&quot;</span><span class="sym">;
</span><span class="line">   33 </span><span class="sym"></span>    <span class="kwa">return</span><span class="sym">(*</span>CS<span class="sym">);
</span><span class="line">   34 </span><span class="sym">}
</span><span class="line">   35 </span><span class="sym">
</span><span class="line">   36 </span><span class="sym"></span><span class="kwa">sub</span> echo_client <span class="sym">{
</span><span class="line">   37 </span><span class="sym"></span>    <span class="kwc">my</span><span class="sym">(</span><span class="kwb">$N</span><span class="sym">,</span> <span class="kwb">$port</span><span class="sym">) =</span> &#64;_<span class="sym">;
</span><span class="line">   38 </span><span class="sym"></span>    local <span class="sym">*</span>SOCK <span class="sym">=</span> client_sock<span class="sym">(</span><span class="kwb">$port</span><span class="sym">);
</span><span class="line">   39 </span><span class="sym"></span>    select<span class="sym">(</span>SOCK<span class="sym">);
</span><span class="line">   40 </span><span class="sym"></span>    <span class="kwb">$</span><span class="sym">| =</span> <span class="num">1</span><span class="sym">;
</span><span class="line">   41 </span><span class="sym"></span>    <span class="kwa">for</span> <span class="kwc">my</span> <span class="kwb">$i</span> <span class="sym">(</span><span class="num">0</span>..<span class="sym">(</span><span class="kwb">$N</span><span class="num">-1</span><span class="sym">)) {
</span><span class="line">   42 </span><span class="sym"></span>        print <span class="kwb">$DATA</span><span class="sym">;
</span><span class="line">   43 </span><span class="sym"></span>        <span class="kwc">my</span> <span class="kwb">$ans</span> <span class="sym">= &lt;</span>SOCK<span class="sym">&gt;;
</span><span class="line">   44 </span><span class="sym">        (</span><span class="kwb">$ans</span> <span class="kwa">eq</span> <span class="kwb">$DATA</span><span class="sym">)</span> <span class="kwa">or</span> die qq<span class="sym">{</span>client<span class="sym">:</span> <span class="str">&quot;$DATA&quot;</span> <span class="kwa">ne</span> <span class="str">&quot;$ans&quot;</span><span class="sym">};
</span><span class="line">   45 </span><span class="sym">    }
</span><span class="line">   46 </span><span class="sym"></span>    close SOCK<span class="sym">;
</span><span class="line">   47 </span><span class="sym">}
</span><span class="line">   48 </span><span class="sym">
</span><span class="line">   49 </span><span class="sym"></span><span class="kwa">sub</span> echo_server <span class="sym">{
</span><span class="line">   50 </span><span class="sym"></span>    <span class="kwc">my</span><span class="sym">(</span><span class="kwb">$N</span><span class="sym">) =</span> &#64;_<span class="sym">;
</span><span class="line">   51 </span><span class="sym"></span>    local <span class="sym">*</span>SSOCK <span class="sym">=</span> server_sock<span class="sym">();
</span><span class="line">   52 </span><span class="sym"></span>    <span class="kwc">my</span> <span class="kwb">$port</span> <span class="sym">=</span> get_port<span class="sym">(*</span>SSOCK<span class="sym">);
</span><span class="line">   53 </span><span class="sym"></span>    <span class="kwc">my</span> <span class="kwb">$pid</span> <span class="sym">=</span> fork<span class="sym">;
</span><span class="line">   54 </span><span class="sym"></span>    defined <span class="kwb">$pid</span> <span class="kwa">or</span> die <span class="str">&quot;server/fork ($!)&quot;</span><span class="sym">;
</span><span class="line">   55 </span><span class="sym"></span>    <span class="kwa">if</span> <span class="sym">(</span><span class="kwb">$pid</span><span class="sym">) {
</span><span class="line">   56 </span><span class="sym"></span>        <span class="slc"># parent is server
</span><span class="line">   57 </span><span class="slc"></span>        local <span class="sym">*</span>CSOCK<span class="sym">;
</span><span class="line">   58 </span><span class="sym"></span>        accept<span class="sym">(</span>CSOCK<span class="sym">,</span> SSOCK<span class="sym">)</span> <span class="kwa">or</span> die <span class="str">&quot;server/accept ($!)&quot;</span><span class="sym">;
</span><span class="line">   59 </span><span class="sym"></span>        select<span class="sym">(</span>CSOCK<span class="sym">);
</span><span class="line">   60 </span><span class="sym"></span>        <span class="kwb">$</span><span class="sym">| =</span> <span class="num">1</span><span class="sym">;
</span><span class="line">   61 </span><span class="sym"></span>        <span class="kwc">my</span> <span class="kwb">$n</span> <span class="sym">=</span> <span class="num">0</span><span class="sym">;
</span><span class="line">   62 </span><span class="sym"></span>        <span class="kwa">while</span> <span class="sym">(&lt;</span>CSOCK<span class="sym">&gt;) {
</span><span class="line">   63 </span><span class="sym"></span>            print <span class="kwb">$_</span><span class="sym">;
</span><span class="line">   64 </span><span class="sym"></span>            <span class="kwb">$n</span> <span class="sym">+=</span> length<span class="sym">(</span><span class="kwb">$_</span><span class="sym">);
</span><span class="line">   65 </span><span class="sym">        }
</span><span class="line">   66 </span><span class="sym"></span>        select<span class="sym">(</span>STDOUT<span class="sym">);
</span><span class="line">   67 </span><span class="sym"></span>        print <span class="str">&quot;server processed $n bytes</span><span class="esc">\n</span><span class="str">&quot;</span><span class="sym">;
</span><span class="line">   68 </span><span class="sym">    }</span> <span class="kwa">else</span> <span class="sym">{
</span><span class="line">   69 </span><span class="sym"></span>        <span class="slc"># child is client
</span><span class="line">   70 </span><span class="slc"></span>        echo_client<span class="sym">(</span><span class="kwb">$N</span><span class="sym">,</span> <span class="kwb">$port</span><span class="sym">);
</span><span class="line">   71 </span><span class="sym">    }
</span><span class="line">   72 </span><span class="sym"></span>    wait<span class="sym">();
</span><span class="line">   73 </span><span class="sym">}
</span><span class="line">   74 </span><span class="sym">
</span><span class="line">   75 </span><span class="sym"></span><span class="kwa">sub</span> main <span class="sym">{
</span><span class="line">   76 </span><span class="sym"></span>    <span class="kwc">my</span> <span class="kwb">$N</span> <span class="sym">=</span> <span class="kwb">$ARGV</span><span class="sym">[</span><span class="num">0</span><span class="sym">] ||</span> <span class="num">1</span><span class="sym">;
</span><span class="line">   77 </span><span class="sym"></span>    echo_server<span class="sym">(</span><span class="kwb">$N</span><span class="sym">);
</span><span class="line">   78 </span><span class="sym"></span>    exit<span class="sym">(</span><span class="num">0</span><span class="sym">);
</span><span class="line">   79 </span><span class="sym">}
</span><span class="line">   80 </span><span class="sym">
</span><span class="line">   81 </span><span class="sym"></span>main<span class="sym">();</span>
