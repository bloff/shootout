<span class="slc">% The Computer Language Shootout</span>
<span class="slc">% http://shootout.alioth.debian.org/</span>
<span class="slc">% contributed by Isaac Gouy</span>

<span class="kwa">functor</span>
<span class="kwa">import</span>
   System Application
   S <span class="kwb">at</span> <span class="str">'../../Include/oz/shootout.ozf'</span>

<span class="kwb">define</span>
   Pi <span class="sym">=</span> <span class="num">3.141592653589793</span>
   SolarMass <span class="sym">=</span> <span class="num">4.0</span> <span class="sym">*</span> Pi <span class="sym">*</span> Pi
   DaysPerYear <span class="sym">=</span> <span class="num">365.24</span>


   <span class="kwa">class</span> Body
      <span class="kwa">attr</span> x y z vx vy vz mass

      <span class="kwb">meth</span> init<span class="sym">(</span>X Y Z Vx Vy Vz Mass<span class="sym">)</span>
         x <span class="sym">:=</span> X
         y <span class="sym">:=</span> Y
         z <span class="sym">:=</span> Z
         vx <span class="sym">:=</span> Vx
         vy <span class="sym">:=</span> Vy
         vz <span class="sym">:=</span> Vz
         mass <span class="sym">:=</span> Mass
      <span class="kwb">end</span>

      <span class="kwb">meth</span> x<span class="sym">(</span>$<span class="sym">)</span> &#64;x <span class="kwb">end</span>
      <span class="kwb">meth</span> y<span class="sym">(</span>$<span class="sym">)</span> &#64;y <span class="kwb">end</span>
      <span class="kwb">meth</span> z<span class="sym">(</span>$<span class="sym">)</span> &#64;z <span class="kwb">end</span>
      <span class="kwb">meth</span> mass<span class="sym">(</span>$<span class="sym">)</span> &#64;mass <span class="kwb">end</span>

      <span class="kwb">meth</span> kineticEnergy<span class="sym">(</span>$<span class="sym">)</span> <span class="num">0.5</span> <span class="sym">*</span> &#64;mass <span class="sym">* (</span>&#64;vx<span class="sym">*</span>&#64;vx <span class="sym">+</span> &#64;vy<span class="sym">*</span>&#64;vy <span class="sym">+</span> &#64;vz<span class="sym">*</span>&#64;vz<span class="sym">)</span> <span class="kwb">end</span>

      <span class="kwb">meth</span> potentialEnergy<span class="sym">(</span>B $<span class="sym">)</span>
         <span class="kwa">local</span> Dx Dy Dz Distance <span class="kwb">in</span>
            Dx <span class="sym">=</span> &#64;x <span class="sym">- {</span>B x<span class="sym">(</span>$<span class="sym">)}</span>
            Dy <span class="sym">=</span> &#64;y <span class="sym">- {</span>B y<span class="sym">(</span>$<span class="sym">)}</span>
            Dz <span class="sym">=</span> &#64;z <span class="sym">- {</span>B z<span class="sym">(</span>$<span class="sym">)}</span>
            Distance <span class="sym">= {</span>Sqrt <span class="sym">(</span>Dx<span class="sym">*</span>Dx <span class="sym">+</span> Dy<span class="sym">*</span>Dy <span class="sym">+</span> Dz<span class="sym">*</span>Dz<span class="sym">)}</span>
            <span class="sym">(</span>&#64;mass <span class="sym">* {</span>B mass<span class="sym">(</span>$<span class="sym">)}) /</span> Distance
         <span class="kwb">end</span>
      <span class="kwb">end</span>

      <span class="kwb">meth</span> increaseVelocity<span class="sym">(</span>Dx Dy Dz M<span class="sym">)</span>
         vx <span class="sym">:=</span> &#64;vx <span class="sym">+</span> Dx<span class="sym">*</span>M
         vy <span class="sym">:=</span> &#64;vy <span class="sym">+</span> Dy<span class="sym">*</span>M
         vz <span class="sym">:=</span> &#64;vz <span class="sym">+</span> Dz<span class="sym">*</span>M
      <span class="kwb">end</span>

      <span class="kwb">meth</span> decreaseVelocity<span class="sym">(</span>Dx Dy Dz M<span class="sym">)</span>
         vx <span class="sym">:=</span> &#64;vx <span class="sym">-</span> Dx<span class="sym">*</span>M
         vy <span class="sym">:=</span> &#64;vy <span class="sym">-</span> Dy<span class="sym">*</span>M
         vz <span class="sym">:=</span> &#64;vz <span class="sym">-</span> Dz<span class="sym">*</span>M
      <span class="kwb">end</span>

      <span class="kwb">meth</span> addMomentumTo<span class="sym">(</span>?A<span class="sym">)</span>
         A<span class="num">.1</span> <span class="sym">:=</span> A<span class="num">.1</span> <span class="sym">+</span> &#64;vx<span class="sym">*</span>&#64;mass
         A<span class="num">.2</span> <span class="sym">:=</span> A<span class="num">.2</span> <span class="sym">+</span> &#64;vy<span class="sym">*</span>&#64;mass
         A<span class="num">.3</span> <span class="sym">:=</span> A<span class="num">.3</span> <span class="sym">+</span> &#64;vz<span class="sym">*</span>&#64;mass
      <span class="kwb">end</span>

      <span class="kwb">meth</span> offsetMomentum<span class="sym">(</span>A<span class="sym">)</span>
         vx <span class="sym">:=</span> ~ A<span class="num">.1</span> <span class="sym">/</span> SolarMass
         vy <span class="sym">:=</span> ~ A<span class="num">.2</span> <span class="sym">/</span> SolarMass
         vz <span class="sym">:=</span> ~ A<span class="num">.3</span> <span class="sym">/</span> SolarMass
      <span class="kwb">end</span>

      <span class="kwb">meth</span> updatePositionAfter<span class="sym">(</span>Dt<span class="sym">)</span>
         x <span class="sym">:=</span> &#64;x <span class="sym">+</span> Dt<span class="sym">*</span>&#64;vx
         y <span class="sym">:=</span> &#64;y <span class="sym">+</span> Dt<span class="sym">*</span>&#64;vy
         z <span class="sym">:=</span> &#64;z <span class="sym">+</span> Dt<span class="sym">*</span>&#64;vz
      <span class="kwb">end</span>

      <span class="kwb">meth</span> updateVelocitiesAfter<span class="sym">(</span>Dt ?B<span class="sym">)</span>
         <span class="kwa">local</span> Dx Dy Dz Distance Magnitude <span class="kwb">in</span>
            Dx <span class="sym">=</span> &#64;x <span class="sym">- {</span>B x<span class="sym">(</span>$<span class="sym">)}</span>
            Dy <span class="sym">=</span> &#64;y <span class="sym">- {</span>B y<span class="sym">(</span>$<span class="sym">)}</span>
            Dz <span class="sym">=</span> &#64;z <span class="sym">- {</span>B z<span class="sym">(</span>$<span class="sym">)}</span>

            Distance <span class="sym">= {</span>Sqrt <span class="sym">(</span>Dx<span class="sym">*</span>Dx <span class="sym">+</span> Dy<span class="sym">*</span>Dy <span class="sym">+</span> Dz<span class="sym">*</span>Dz<span class="sym">)}</span>
            Magnitude <span class="sym">=</span> Dt <span class="sym">/ (</span>Distance <span class="sym">*</span> Distance <span class="sym">*</span> Distance<span class="sym">)</span>

            <span class="sym">{</span>self decreaseVelocity<span class="sym">(</span>Dx Dy Dz <span class="sym">({</span>B mass<span class="sym">(</span>$<span class="sym">)} *</span> Magnitude<span class="sym">))}</span>
            <span class="sym">{</span>B increaseVelocity<span class="sym">(</span>Dx Dy Dz <span class="sym">(</span>&#64;mass <span class="sym">*</span> Magnitude<span class="sym">))}</span>
         <span class="kwb">end</span>
      <span class="kwb">end</span>
   <span class="kwb">end</span>


   Sun <span class="sym">= {</span>New Body init<span class="sym">(</span><span class="num">0.0 0.0 0.0 0.0 0.0 0.0</span> SolarMass<span class="sym">)}</span>

   Jupiter <span class="sym">= {</span>New Body init<span class="sym">(</span>
      <span class="num">4.84143144246472090</span>e00
      ~<span class="num">1.16032004402742839</span>e00
      ~<span class="num">1.03622044471123109</span>e~<span class="num">01</span>
      <span class="num">1.66007664274403694</span>e~<span class="num">03</span> <span class="sym">*</span> DaysPerYear
      <span class="num">7.69901118419740425</span>e~<span class="num">03</span> <span class="sym">*</span> DaysPerYear
      ~<span class="num">6.90460016972063023</span>e~<span class="num">05</span> <span class="sym">*</span> DaysPerYear
      <span class="num">9.54791938424326609</span>e~<span class="num">04</span> <span class="sym">*</span> SolarMass
      <span class="sym">)}</span>

   Saturn <span class="sym">= {</span>New Body init<span class="sym">(</span>
      <span class="num">8.34336671824457987</span>e00
      <span class="num">4.12479856412430479</span>e00
      ~<span class="num">4.03523417114321381</span>e~<span class="num">01</span>
      ~<span class="num">2.76742510726862411</span>e~<span class="num">03</span> <span class="sym">*</span> DaysPerYear
      <span class="num">4.99852801234917238</span>e~<span class="num">03</span> <span class="sym">*</span> DaysPerYear
      <span class="num">2.30417297573763929</span>e~<span class="num">05</span> <span class="sym">*</span> DaysPerYear
      <span class="num">2.85885980666130812</span>e~<span class="num">04</span> <span class="sym">*</span> SolarMass
      <span class="sym">)}</span>

   Uranus <span class="sym">= {</span>New Body init<span class="sym">(</span>
      <span class="num">1.28943695621391310</span>e01
      ~<span class="num">1.51111514016986312</span>e01
      ~<span class="num">2.23307578892655734</span>e~<span class="num">01</span>
      <span class="num">2.96460137564761618</span>e~<span class="num">03</span> <span class="sym">*</span> DaysPerYear
      <span class="num">2.37847173959480950</span>e~<span class="num">03</span> <span class="sym">*</span> DaysPerYear
      ~<span class="num">2.96589568540237556</span>e~<span class="num">05</span> <span class="sym">*</span> DaysPerYear
      <span class="num">4.36624404335156298</span>e~<span class="num">05</span> <span class="sym">*</span> SolarMass
      <span class="sym">)}</span>

   Neptune <span class="sym">= {</span>New Body init<span class="sym">(</span>
      <span class="num">1.53796971148509165</span>e01
      ~<span class="num">2.59193146099879641</span>e01
      <span class="num">1.79258772950371181</span>e~<span class="num">01</span>
      <span class="num">2.68067772490389322</span>e~<span class="num">03</span> <span class="sym">*</span> DaysPerYear
      <span class="num">1.62824170038242295</span>e~<span class="num">03</span> <span class="sym">*</span> DaysPerYear
      ~<span class="num">9.51592254519715870</span>e~<span class="num">05</span> <span class="sym">*</span> DaysPerYear
      <span class="num">5.15138902046611451</span>e~<span class="num">05</span> <span class="sym">*</span> SolarMass
      <span class="sym">)}</span>


   <span class="kwa">class</span> NBodySystem
      <span class="kwa">attr</span> bodies

      <span class="kwb">meth</span> init<span class="sym">()</span>
         bodies <span class="sym">:= {</span>Tuple.toArray Sun # Jupiter # Saturn # Uranus # Neptune<span class="sym">}</span>
         <span class="kwa">local</span>
            A <span class="sym">= {</span>Tuple.toArray <span class="num">0.0</span> # <span class="num">0.0</span> # <span class="num">0.0</span><span class="sym">}</span>
            N <span class="sym">= {</span>Array.high &#64;bodies<span class="sym">}</span>
         <span class="kwb">in</span>
            <span class="kwb">for</span> I <span class="kwb">in</span> <span class="num">1</span>..N <span class="kwb">do</span> <span class="sym">{</span>&#64;bodies.I addMomentumTo<span class="sym">(</span>A<span class="sym">)}</span> <span class="kwb">end</span>
            <span class="sym">{</span>&#64;bodies<span class="num">.1</span> offsetMomentum<span class="sym">(</span>A<span class="sym">)}</span>
         <span class="kwb">end</span>
      <span class="kwb">end</span>

      <span class="kwb">meth</span> after<span class="sym">(</span>Dt<span class="sym">)</span>
         <span class="kwa">local</span> N <span class="sym">= {</span>Array.high &#64;bodies<span class="sym">}</span> <span class="kwb">in</span>
            <span class="kwb">for</span> I <span class="kwb">in</span> <span class="num">1</span>..N <span class="kwb">do</span>
               <span class="kwb">for</span> J <span class="kwb">in</span> I<span class="sym">+</span><span class="num">1</span>..N <span class="kwb">do</span>
                  <span class="sym">{</span>&#64;bodies.I updateVelocitiesAfter<span class="sym">(</span>Dt &#64;bodies.J<span class="sym">)}</span>
               <span class="kwb">end</span>
            <span class="kwb">end</span>
            <span class="kwb">for</span> I <span class="kwb">in</span> <span class="num">1</span>..N <span class="kwb">do</span> <span class="sym">{</span>&#64;bodies.I updatePositionAfter<span class="sym">(</span>Dt<span class="sym">)}</span> <span class="kwb">end</span>
         <span class="kwb">end</span>
      <span class="kwb">end</span>

      <span class="kwb">meth</span> energy<span class="sym">(</span>$<span class="sym">)</span>
         <span class="kwa">local</span>
            E <span class="sym">= {</span>NewCell <span class="num">0.0</span><span class="sym">}</span>
            N <span class="sym">= {</span>Array.high &#64;bodies<span class="sym">}</span>
         <span class="kwb">in</span>
            <span class="kwb">for</span> I <span class="kwb">in</span> <span class="num">1</span>..N <span class="kwb">do</span>
               E <span class="sym">:=</span> &#64;E <span class="sym">+ {</span>&#64;bodies.I kineticEnergy<span class="sym">(</span>$<span class="sym">)}</span>
               <span class="kwb">for</span> J <span class="kwb">in</span> I<span class="sym">+</span><span class="num">1</span>..N <span class="kwb">do</span>
                  E <span class="sym">:=</span> &#64;E <span class="sym">- {</span>&#64;bodies.I potentialEnergy<span class="sym">(</span>&#64;bodies.J $<span class="sym">)}</span>
               <span class="kwb">end</span>
            <span class="kwb">end</span>
            &#64;E
         <span class="kwb">end</span>
      <span class="kwb">end</span>
   <span class="kwb">end</span>

   NBody <span class="sym">= {</span>New NBodySystem init<span class="sym">}</span>

   <span class="sym">[</span>Arg<span class="sym">] = {</span>Application.getArgs plain<span class="sym">}</span>
   N <span class="sym">= {</span>String.toInt Arg<span class="sym">}</span>

<span class="kwb">in</span>
   <span class="sym">{</span>System.showInfo <span class="sym">{</span>S.floatToString <span class="sym">{</span>NBody energy<span class="sym">(</span>$<span class="sym">)}</span> <span class="num">9</span><span class="sym">}}</span>
   <span class="kwb">for</span> I <span class="kwb">in</span> <span class="num">1</span>..N <span class="kwb">do</span> <span class="sym">{</span>NBody after<span class="sym">(</span><span class="num">0.01</span><span class="sym">)}</span> <span class="kwb">end</span>
   <span class="sym">{</span>System.showInfo <span class="sym">{</span>S.floatToString <span class="sym">{</span>NBody energy<span class="sym">(</span>$<span class="sym">)}</span> <span class="num">9</span><span class="sym">}}</span>
   <span class="sym">{</span>Application.exit <span class="num">0</span><span class="sym">}</span>
<span class="kwb">end</span>
