<span class="com">&quot;*  The Great Computer Language Shootout</span>
<span class="com">   http://shootout.alioth.debian.org/</span>
<span class="com"></span>
<span class="com">   contributed by Isaac Gouy</span>
<span class="com"></span>
<span class="com">   To run: gst -QI /usr/share/gnu-smalltalk/gst.im spectralnorm.st -a 100</span>
<span class="com">*&quot;</span>

<span class="sym">!</span>Integer methodsFor<span class="sym">:</span> <span class="str">'spectral-norm'</span><span class="sym">!</span>

matrixA<span class="sym">:</span> anInteger
<span class="com">&quot;* fixup one-based indexing to zero-based indexing - cleanup later *&quot;</span>
   <span class="sym">|</span> i j <span class="sym">|</span>
   i <span class="sym">:=</span> <span class="kwa">self</span> <span class="sym">-</span> <span class="num">1</span><span class="sym">.</span>
   j <span class="sym">:=</span> anInteger <span class="sym">-</span> <span class="num">1</span><span class="sym">.</span>
   <span class="sym">^</span><span class="num">1.0</span>d <span class="sym">/ (</span>i <span class="sym">+</span> j <span class="sym">* (</span>i <span class="sym">+</span> j <span class="sym">+</span> <span class="num">1</span><span class="sym">) /</span><span class="num">2</span>  <span class="sym">+</span> i <span class="sym">+</span> <span class="num">1</span><span class="sym">)</span> asFloatD <span class="sym">! !</span>


<span class="sym">!</span>Array methodsFor<span class="sym">:</span> <span class="str">'spectral-norm'</span><span class="sym">!</span>

multiplyAv
   <span class="sym">|</span> n av <span class="sym">|</span>
   n <span class="sym">:=</span> <span class="kwa">self</span> size<span class="sym">.</span>
   av <span class="sym">:=</span> Array new<span class="sym">:</span> n withAll<span class="sym">:</span> <span class="num">0.0</span>d<span class="sym">.</span>
   <span class="num">1</span> to<span class="sym">:</span> n do<span class="sym">: [:</span>i<span class="sym">|</span>
      <span class="num">1</span> to<span class="sym">:</span> n do<span class="sym">: [:</span>j<span class="sym">|</span>
         av at<span class="sym">:</span> i put<span class="sym">: (</span>av at<span class="sym">:</span> i<span class="sym">) + ((</span>i matrixA<span class="sym">:</span> j<span class="sym">) * (</span><span class="kwa">self</span> at<span class="sym">:</span> j<span class="sym">)) ]].</span>
   <span class="sym">^</span>av <span class="sym">!</span>

multiplyAtv
   <span class="sym">|</span> n atv <span class="sym">|</span>
   n <span class="sym">:=</span> <span class="kwa">self</span> size<span class="sym">.</span>
   atv <span class="sym">:=</span> Array new<span class="sym">:</span> n withAll<span class="sym">:</span> <span class="num">0.0</span>d<span class="sym">.</span>
   <span class="num">1</span> to<span class="sym">:</span> n do<span class="sym">: [:</span>i<span class="sym">|</span>
      <span class="num">1</span> to<span class="sym">:</span> n do<span class="sym">: [:</span>j<span class="sym">|</span>
         atv at<span class="sym">:</span> i put<span class="sym">: (</span>atv at<span class="sym">:</span> i<span class="sym">) + ((</span>j matrixA<span class="sym">:</span> i<span class="sym">) * (</span><span class="kwa">self</span> at<span class="sym">:</span> j<span class="sym">)) ]].</span>
   <span class="sym">^</span>atv <span class="sym">!</span>

multiplyAtAv
   <span class="sym">^(</span><span class="kwa">self</span> multiplyAv<span class="sym">)</span> multiplyAtv <span class="sym">! !</span>


<span class="sym">!</span>Float methodsFor<span class="sym">:</span> <span class="str">'printing'</span><span class="sym">!</span>

printStringRoundedTo<span class="sym">:</span> anInteger
   <span class="sym">|</span> n s <span class="sym">|</span>
   n <span class="sym">:=</span> <span class="num">0.5</span>d <span class="sym">* (</span><span class="num">10</span> raisedToInteger<span class="sym">:</span> anInteger negated<span class="sym">).</span>
   s <span class="sym">:= ((</span><span class="kwa">self</span> sign <span class="sym">&lt;</span> <span class="num">0</span><span class="sym">)</span> ifTrue<span class="sym">: [</span><span class="kwa">self</span> <span class="sym">-</span> n<span class="sym">]</span> ifFalse<span class="sym">: [</span><span class="kwa">self</span> <span class="sym">+</span> n<span class="sym">])</span> printString<span class="sym">.</span>
   <span class="sym">^</span>s copyFrom<span class="sym">:</span> <span class="num">1</span> to<span class="sym">: (</span>s indexOf<span class="sym">: $.) +</span> anInteger <span class="sym">! !</span>


<span class="sym">|</span> n u v vBv vv <span class="sym">|</span>
n <span class="sym">:=</span> Smalltalk arguments first asInteger<span class="sym">.</span>
u <span class="sym">:=</span> Array new<span class="sym">:</span> n withAll<span class="sym">:</span> <span class="num">1.0</span>d<span class="sym">.</span>
v <span class="sym">:=</span> Array new<span class="sym">:</span> n withAll<span class="sym">:</span> <span class="num">0.0</span>d<span class="sym">.</span>

<span class="num">10</span> timesRepeat<span class="sym">: [</span>
   v <span class="sym">:=</span> u multiplyAtAv<span class="sym">.</span>
   u <span class="sym">:=</span> v multiplyAtAv<span class="sym">.</span>
<span class="sym">].</span>

vBv <span class="sym">:=</span> <span class="num">0.0</span>d<span class="sym">.</span>
vv <span class="sym">:=</span> <span class="num">0.0</span>d<span class="sym">.</span>
<span class="num">1</span> to<span class="sym">:</span> n do<span class="sym">: [:</span>i<span class="sym">|</span>
   vBv <span class="sym">:=</span> vBv <span class="sym">+ ((</span>u at<span class="sym">:</span> i<span class="sym">) * (</span>v at<span class="sym">:</span> i<span class="sym">)).</span>
   vv <span class="sym">:=</span> vv <span class="sym">+ ((</span>v at<span class="sym">:</span> i<span class="sym">) * (</span>v at<span class="sym">:</span> i<span class="sym">)).</span>
<span class="sym">].</span>

<span class="sym">((</span>vBv<span class="sym">/</span>vv<span class="sym">)</span> sqrt printStringRoundedTo<span class="sym">:</span> <span class="num">9</span><span class="sym">)</span> displayNl <span class="sym">!</span>
