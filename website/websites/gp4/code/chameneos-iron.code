<span class="hl slc"># The Computer Language Shootout</span>
<span class="hl slc"># http://shootout.alioth.debian.org/</span>

<span class="hl slc"># contributed by Greg Reynolds</span>

<span class="hl kwa">import</span> sys

n_meetings <span class="hl sym">=</span> <span class="hl num">5000</span>

<span class="hl kwa">if</span> <span class="hl kwb">len</span><span class="hl sym">(</span>sys<span class="hl sym">.</span>argv<span class="hl sym">) ==</span> <span class="hl num">2</span><span class="hl sym">:</span>
    n_meetings <span class="hl sym">=</span> <span class="hl kwb">eval</span><span class="hl sym">(</span>sys<span class="hl sym">.</span>argv<span class="hl sym">[</span><span class="hl num">1</span><span class="hl sym">])</span>

<span class="hl kwa">import</span> thread
<span class="hl kwa">from</span>  threading <span class="hl kwa">import</span> Thread
<span class="hl kwa">import</span> mutex

<span class="hl kwa">class</span> MeetingPlace<span class="hl sym">:</span>
    <span class="hl kwa">def</span> <span class="hl kwd">__init__</span><span class="hl sym">(</span>self<span class="hl sym">,</span>n_meetings<span class="hl sym">):</span>
        self<span class="hl sym">.</span>n_meetings <span class="hl sym">=</span> n_meetings
        self<span class="hl sym">.</span>lock <span class="hl sym">=</span> thread<span class="hl sym">.</span><span class="hl kwd">allocate_lock</span><span class="hl sym">()</span>
        self<span class="hl sym">.</span>waiter <span class="hl sym">=</span> <span class="hl kwa">None</span>

    <span class="hl kwa">def</span> <span class="hl kwd">request_meeting</span><span class="hl sym">(</span>self<span class="hl sym">,</span>c<span class="hl sym">):</span>
        self<span class="hl sym">.</span>lock<span class="hl sym">.</span><span class="hl kwd">acquire</span><span class="hl sym">()</span>
        <span class="hl kwa">if</span> self<span class="hl sym">.</span>n_meetings <span class="hl sym">&gt;</span> <span class="hl num">0</span><span class="hl sym">:</span>
            <span class="hl kwa">if</span> self<span class="hl sym">.</span>waiter <span class="hl sym">==</span> <span class="hl kwa">None</span><span class="hl sym">:</span>
                self<span class="hl sym">.</span>waiter <span class="hl sym">=</span> c
            <span class="hl kwa">elif</span> self<span class="hl sym">.</span>waiter <span class="hl sym">!=</span> c<span class="hl sym">:</span>
                c<span class="hl sym">.</span>n_meetings <span class="hl sym">=</span> c<span class="hl sym">.</span>n_meetings <span class="hl sym">+</span> <span class="hl num">1</span>
                self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>n_meetings <span class="hl sym">=</span> self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>n_meetings <span class="hl sym">+</span> <span class="hl num">1</span>
                self<span class="hl sym">.</span>n_meetings <span class="hl sym">=</span> self<span class="hl sym">.</span>n_meetings <span class="hl sym">-</span> <span class="hl num">1</span>
                <span class="hl kwa">if</span> self<span class="hl sym">.</span>n_meetings <span class="hl sym">==</span> <span class="hl num">0</span><span class="hl sym">:</span>
                    self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>FADED
                    c<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>FADED
                <span class="hl kwa">else</span><span class="hl sym">:</span>
                    <span class="hl kwa">if</span> c<span class="hl sym">.</span>colour <span class="hl sym">!=</span> self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour<span class="hl sym">:</span>
                        <span class="hl kwa">if</span> c<span class="hl sym">.</span>colour<span class="hl sym">==</span>Chameneos<span class="hl sym">.</span>BLUE <span class="hl kwa">and</span> self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">==</span> Chameneos<span class="hl sym">.</span>YELLOW<span class="hl sym">:</span>
                            c<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>RED
                            self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>RED
                        <span class="hl kwa">elif</span> c<span class="hl sym">.</span>colour<span class="hl sym">==</span>Chameneos<span class="hl sym">.</span>BLUE <span class="hl kwa">and</span> self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">==</span> Chameneos<span class="hl sym">.</span>RED<span class="hl sym">:</span>
                            c<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>YELLOW
                            self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>YELLOW
                        <span class="hl kwa">elif</span> c<span class="hl sym">.</span>colour<span class="hl sym">==</span>Chameneos<span class="hl sym">.</span>RED <span class="hl kwa">and</span> self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">==</span> Chameneos<span class="hl sym">.</span>BLUE<span class="hl sym">:</span>
                            c<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>YELLOW
                            self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>YELLOW
                        <span class="hl kwa">elif</span> c<span class="hl sym">.</span>colour<span class="hl sym">==</span>Chameneos<span class="hl sym">.</span>RED <span class="hl kwa">and</span> self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">==</span> Chameneos<span class="hl sym">.</span>YELLOW<span class="hl sym">:</span>
                            c<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>BLUE
                            self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>BLUE
                        <span class="hl kwa">elif</span> c<span class="hl sym">.</span>colour<span class="hl sym">==</span>Chameneos<span class="hl sym">.</span>YELLOW <span class="hl kwa">and</span> self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour<span class="hl sym">==</span> Chameneos<span class="hl sym">.</span>BLUE<span class="hl sym">:</span>
                            c<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>RED
                            self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>RED
                        <span class="hl kwa">elif</span> c<span class="hl sym">.</span>colour<span class="hl sym">==</span>Chameneos<span class="hl sym">.</span>YELLOW <span class="hl kwa">and</span> self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">==</span> Chameneos<span class="hl sym">.</span>RED<span class="hl sym">:</span>
                            c<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>BLUE
                            self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>BLUE
                        <span class="hl kwa">else</span><span class="hl sym">:</span>
                            c<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>FADED
                            self<span class="hl sym">.</span>waiter<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>FADED

                self<span class="hl sym">.</span>waiter <span class="hl sym">=</span> <span class="hl kwa">None</span>
        <span class="hl kwa">else</span><span class="hl sym">:</span>
            c<span class="hl sym">.</span>colour <span class="hl sym">=</span> Chameneos<span class="hl sym">.</span>FADED
        self<span class="hl sym">.</span>lock<span class="hl sym">.</span><span class="hl kwd">release</span><span class="hl sym">()</span>


<span class="hl kwa">class</span> <span class="hl kwd">Chameneos</span><span class="hl sym">(</span>Thread<span class="hl sym">):</span>
    YELLOW <span class="hl sym">=</span> <span class="hl num">0</span>
    BLUE   <span class="hl sym">=</span> <span class="hl num">1</span>
    RED    <span class="hl sym">=</span> <span class="hl num">2</span>
    FADED  <span class="hl sym">=</span> <span class="hl num">3</span>

    <span class="hl kwa">def</span> <span class="hl kwd">__init__</span><span class="hl sym">(</span>self<span class="hl sym">,</span>colour<span class="hl sym">,</span>meeting_place<span class="hl sym">):</span>
        Thread<span class="hl sym">.</span><span class="hl kwd">__init__</span><span class="hl sym">(</span>self<span class="hl sym">)</span>
        self<span class="hl sym">.</span>colour <span class="hl sym">=</span> colour
        self<span class="hl sym">.</span>meeting_place <span class="hl sym">=</span> meeting_place
        self<span class="hl sym">.</span>n_meetings <span class="hl sym">=</span> <span class="hl num">0</span>

    <span class="hl kwa">def</span> <span class="hl kwd">run</span><span class="hl sym">(</span>self<span class="hl sym">):</span>
        <span class="hl kwa">while</span> self<span class="hl sym">.</span>colour <span class="hl sym">!=</span> Chameneos<span class="hl sym">.</span>FADED<span class="hl sym">:</span>
            self<span class="hl sym">.</span>meeting_place<span class="hl sym">.</span><span class="hl kwd">request_meeting</span><span class="hl sym">(</span>self<span class="hl sym">)</span>

mp <span class="hl sym">=</span> <span class="hl kwd">MeetingPlace</span><span class="hl sym">(</span>n_meetings<span class="hl sym">)</span>
c_list <span class="hl sym">= []</span>
<span class="hl kwa">for</span> colour <span class="hl kwa">in</span> <span class="hl sym">[</span>Chameneos<span class="hl sym">.</span>BLUE<span class="hl sym">,</span> Chameneos<span class="hl sym">.</span>RED<span class="hl sym">,</span> Chameneos<span class="hl sym">.</span>YELLOW<span class="hl sym">,</span> Chameneos<span class="hl sym">.</span>BLUE<span class="hl sym">]:</span>
    c_list<span class="hl sym">.</span><span class="hl kwd">append</span><span class="hl sym">(</span><span class="hl kwd">Chameneos</span><span class="hl sym">(</span>colour<span class="hl sym">,</span>mp<span class="hl sym">))</span>

<span class="hl kwa">for</span> c <span class="hl kwa">in</span> c_list<span class="hl sym">:</span>
    c<span class="hl sym">.</span><span class="hl kwd">start</span><span class="hl sym">()</span>

<span class="hl kwa">for</span> c <span class="hl kwa">in</span> c_list<span class="hl sym">:</span>
    c<span class="hl sym">.</span><span class="hl kwd">join</span><span class="hl sym">()</span>

<span class="hl kwa">print</span> <span class="hl kwb">reduce</span><span class="hl sym">(</span><span class="hl kwa">lambda</span> x<span class="hl sym">,</span> y<span class="hl sym">:</span> x <span class="hl sym">+</span> y<span class="hl sym">.</span>n_meetings<span class="hl sym">,</span>c_list<span class="hl sym">,</span><span class="hl num">0</span><span class="hl sym">)</span>





