<span class="hl com">(**</span>
<span class="hl com"> * The Computer Language Benchmarks Game</span>
<span class="hl com"> * http://shootout.alioth.debian.org/</span>
<span class="hl com"> *</span>
<span class="hl com"> * Contributed by David Teller</span>
<span class="hl com"> *</span>
<span class="hl com"> * Inspired from the Python version</span>
<span class="hl com"> *)</span>

<span class="hl kwa">type</span> color <span class="hl sym">=</span> Blue <span class="hl sym">|</span> Red <span class="hl sym">|</span> Yellow

<span class="hl kwa">type</span> <span class="hl str">'a coroutine =</span>
<span class="hl str">  | Done    of '</span>a
  <span class="hl sym">|</span> Yield <span class="hl kwa">of</span> <span class="hl sym">(</span><span class="hl kwb">unit</span> <span class="hl sym">-&gt;</span> <span class="hl str">'a coroutine)</span>
<span class="hl str"></span>
<span class="hl str">let remaining_meetings      = ref 0</span>
<span class="hl str">let first_seat, second_seat = ref None, ref None</span>
<span class="hl str"></span>
<span class="hl str">let complement_color a b = match a,b with</span>
<span class="hl str">  | Blue, Red    | Red,    Blue -&gt; Yellow</span>
<span class="hl str">  | Blue, Yellow | Yellow, Blue -&gt; Red</span>
<span class="hl str">  | Red,  Yellow | Yellow, Red  -&gt; Blue</span>
<span class="hl str">  | _                           -&gt; a</span>
<span class="hl str"></span>
<span class="hl str">let creature =</span>
<span class="hl str">  let rec come_to_meeting met color  = match !second_seat with</span>
<span class="hl str">      | Some _ -&gt;                                  (*Both seats are taken, wait until meeting place clears*)</span>
<span class="hl str">	  Yield (fun () -&gt; come_to_meeting met color)</span>
<span class="hl str">      | None   -&gt;                                  (*At least one seat available.                         *)</span>
<span class="hl str">	  match !first_seat with</span>
<span class="hl str">	    | None when !remaining_meetings &lt;=0 -&gt; (*Oh, wait, everybody'</span>s gone <span class="hl sym">!</span>                         *)
		Done met
	    <span class="hl sym">|</span> None <span class="hl sym">-&gt;</span>
		first_seat <span class="hl sym">:=</span> Some color<span class="hl sym">;</span>
		<span class="hl kwa">let rec</span> <span class="hl kwd">loop</span> <span class="hl sym">() =</span>
		  <span class="hl kwa">match</span> <span class="hl sym">!</span>second_seat <span class="hl kwa">with</span>
		    <span class="hl sym">|</span> None       <span class="hl sym">-&gt;</span> <span class="hl kwd">Yield</span> <span class="hl sym">(</span><span class="hl kwa">fun</span> <span class="hl sym">() -&gt;</span> <span class="hl kwd">loop</span> <span class="hl sym">())</span>
		    <span class="hl sym">|</span> Some other <span class="hl sym">-&gt;</span>
			  second_seat <span class="hl sym">:=</span> None<span class="hl sym">;</span>     <span class="hl com">(*Yeah, that's a meeting                               *)</span>
			  first_seat  <span class="hl sym">:=</span> None<span class="hl sym">;</span>
			  decr remaining_meetings<span class="hl sym">;</span>
			  <span class="hl kwd">come_to_meeting</span> <span class="hl sym">(</span>met <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">) (</span>complement_color color other<span class="hl sym">)</span>
		<span class="hl kwa">in</span> <span class="hl kwd">loop</span> <span class="hl sym">()</span>
	    <span class="hl sym">|</span> Some other <span class="hl sym">-&gt;</span>
		second_seat <span class="hl sym">:=</span> Some color<span class="hl sym">;</span>
		<span class="hl kwd">Yield</span> <span class="hl sym">(</span><span class="hl kwa">fun</span> <span class="hl sym">() -&gt;</span> <span class="hl kwd">come_to_meeting</span> <span class="hl sym">(</span>met <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">) (</span>complement_color color other<span class="hl sym">))</span>
  <span class="hl kwa">in</span>
    come_to_meeting <span class="hl num">0</span>

<span class="hl kwa">let rec</span> schedule current next total <span class="hl sym">=</span>
  <span class="hl kwa">match</span> current <span class="hl kwa">with</span>
    <span class="hl sym">| []</span> <span class="hl kwa">when</span> next <span class="hl sym">= [] -&gt;</span> print_int total<span class="hl sym">;</span> <span class="hl kwd">print_newline</span> <span class="hl sym">()</span>
    <span class="hl sym">| []                -&gt;</span> schedule next <span class="hl sym">[]</span> total
    <span class="hl sym">|</span> Done d<span class="hl sym">::</span>t         <span class="hl sym">-&gt;</span> schedule t    <span class="hl kwd">next</span> <span class="hl sym">(</span>total <span class="hl sym">+</span> d<span class="hl sym">)</span>
    <span class="hl sym">| (</span>Yield h<span class="hl sym">)::</span>t      <span class="hl sym">-&gt;</span> schedule <span class="hl kwd">t</span>    <span class="hl sym">(</span><span class="hl kwd">h</span> <span class="hl sym">()::</span>next<span class="hl sym">)</span> total


<span class="hl kwa">let</span> <span class="hl sym">() =</span>
  <span class="hl sym">(</span>remaining_meetings <span class="hl sym">:=</span>  <span class="hl kwa">try</span> <span class="hl kwd">int_of_string</span><span class="hl sym">(</span>Array.get Sys.argv <span class="hl num">1</span><span class="hl sym">)</span> <span class="hl kwa">with</span> _ <span class="hl sym">-&gt;</span> <span class="hl num">100</span><span class="hl sym">);</span>
  schedule <span class="hl sym">[</span>creature Blue<span class="hl sym">;</span> creature Red<span class="hl sym">;</span> creature Yellow<span class="hl sym">;</span> creature Blue<span class="hl sym">] []</span> <span class="hl num">0</span>





<span class="hl com">(*</span>
<span class="hl com"># Trivial round-robin scheduler.</span>
<span class="hl com">def schedule(threads):</span>
<span class="hl com">    while 1:</span>
<span class="hl com">        for thread in threads:</span>
<span class="hl com">            thread()</span>
<span class="hl com"></span>
<span class="hl com"># A bunch of colorful creatures.</span>
<span class="hl com">threads = [</span>
<span class="hl com">    creature(BLUE).next,</span>
<span class="hl com">    creature(RED).next,</span>
<span class="hl com">    creature(YELLOW).next,</span>
<span class="hl com">    creature(BLUE).next]</span>
<span class="hl com"></span>
<span class="hl com">schedule(threads)</span>
<span class="hl com">*)</span>
