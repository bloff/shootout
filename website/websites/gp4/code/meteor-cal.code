<span class="hl com">/**</span>
<span class="hl com"> * The Computer Language Benchmarks Game</span>
<span class="hl com"> * Based on the CAL Open Quark version</span>
<span class="hl com"> * Contributed by Magnus Byne.</span>
<span class="hl com"> */</span>
<span class="hl kwa">module</span> Meteor<span class="hl sym">;</span>

<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Core<span class="hl sym">.</span>Prelude <span class="hl kwa">using</span>
    <span class="hl kwa">typeClass</span> <span class="hl sym">=</span> Enum<span class="hl sym">,</span> Inputable<span class="hl sym">,</span> IntEnum<span class="hl sym">,</span> Outputable<span class="hl sym">;</span>
    <span class="hl kwa">typeConstructor</span> <span class="hl sym">=</span> Boolean<span class="hl sym">,</span> Int<span class="hl sym">,</span> Long<span class="hl sym">,</span> String<span class="hl sym">;</span>
    <span class="hl kwa">dataConstructor</span> <span class="hl sym">=</span> False<span class="hl sym">,</span> True<span class="hl sym">;</span>
    <span class="hl kwa">function</span> <span class="hl sym">=</span> eager<span class="hl sym">,</span> fromInt<span class="hl sym">,</span> iff<span class="hl sym">,</span> seq<span class="hl sym">,</span> stringToInt<span class="hl sym">;</span>
    <span class="hl sym">;</span>
<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Core<span class="hl sym">.</span>Debug <span class="hl kwa">using</span>
    <span class="hl kwa">typeClass</span> <span class="hl sym">=</span> Show<span class="hl sym">;</span>
    <span class="hl kwa">function</span> <span class="hl sym">=</span> show<span class="hl sym">;</span>
    <span class="hl sym">;</span>
<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Core<span class="hl sym">.</span>Bits <span class="hl kwa">using</span>
    <span class="hl kwa">function</span> <span class="hl sym">=</span> bitwiseAnd<span class="hl sym">,</span> bitwiseOr<span class="hl sym">,</span> shiftL<span class="hl sym">,</span> shiftRUnsigned<span class="hl sym">;</span>
    <span class="hl sym">;</span>
<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Collections<span class="hl sym">.</span>List <span class="hl kwa">using</span>
    <span class="hl kwa">function</span> <span class="hl sym">=</span> foldLeftStrict<span class="hl sym">,</span> head<span class="hl sym">,</span> map<span class="hl sym">;</span>
    <span class="hl sym">;</span>
<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Collections<span class="hl sym">.</span>Array <span class="hl kwa">using</span>
    <span class="hl kwa">typeConstructor</span> <span class="hl sym">=</span> Array<span class="hl sym">;</span>
    <span class="hl sym">;</span>
<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>IO<span class="hl sym">.</span>Console <span class="hl kwa">using</span>
    <span class="hl kwa">function</span> <span class="hl sym">=</span> printLine<span class="hl sym">;</span>
    <span class="hl sym">;</span>


<span class="hl kwa">data foreign unsafe import jvm</span> <span class="hl str">&quot;long[]&quot;</span>
    JLongArray <span class="hl kwa">deriving</span> Inputable<span class="hl sym">,</span> Outputable<span class="hl sym">,</span> Show<span class="hl sym">;</span>

<span class="hl kwa">foreign unsafe import jvm</span> <span class="hl str">&quot;newArray&quot;</span> longArray_new <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> JLongArray<span class="hl sym">;</span>

<span class="hl kwa">foreign unsafe import jvm</span> <span class="hl str">&quot;lengthArray&quot;</span> longArray_length <span class="hl sym">::</span> JLongArray <span class="hl sym">-&gt;</span> Int<span class="hl sym">;</span>

<span class="hl kwa">foreign unsafe import jvm</span> <span class="hl str">&quot;subscriptArray&quot;</span>
    longArray_subscript <span class="hl sym">::</span> JLongArray <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> Long<span class="hl sym">;</span>

<span class="hl kwa">foreign unsafe import jvm</span> <span class="hl str">&quot;updateArray&quot;</span>
    longArray_update <span class="hl sym">::</span> JLongArray <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> Long<span class="hl sym">;</span>

<span class="hl com">/** build an array from a list*/</span>
jLongArrayfromList <span class="hl sym">:: [</span>Long<span class="hl sym">] -&gt;</span> JLongArray<span class="hl sym">;</span>
jLongArrayfromList <span class="hl sym">!</span>input <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        array <span class="hl sym">::</span> JLongArray<span class="hl sym">;</span>
        array <span class="hl sym">=</span> eager $ longArray_new <span class="hl sym">(</span>List<span class="hl sym">.</span>length input<span class="hl sym">);</span>
    <span class="hl kwa">in</span>
        array
        <span class="hl sym">`</span>seq<span class="hl sym">`</span>
        foldLeftStrict
            <span class="hl sym">(</span>
                \<span class="hl sym">!</span>index <span class="hl sym">!</span>value <span class="hl sym">-&gt;</span>
                    longArray_update array index value
                    <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                    <span class="hl sym">(</span>index <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
            <span class="hl sym">)</span>
            <span class="hl num">0</span>
            input
        <span class="hl sym">`</span>seq<span class="hl sym">`</span>
        array
    <span class="hl sym">;</span>

<span class="hl kwa">data</span> Direction <span class="hl sym">=</span>
    E <span class="hl sym">|</span> SE <span class="hl sym">|</span> SW <span class="hl sym">|</span> W <span class="hl sym">|</span> NW <span class="hl sym">|</span> NE
    <span class="hl kwa">deriving</span> Enum<span class="hl sym">,</span> IntEnum
    <span class="hl sym">;</span>

<span class="hl com">/** the puzzle pieces*/</span>
pieces <span class="hl sym">:: [[</span>Direction<span class="hl sym">]];</span>
pieces <span class="hl sym">=</span>
    <span class="hl sym">[</span>
        <span class="hl sym">[</span>E<span class="hl sym">,</span> E<span class="hl sym">,</span> E<span class="hl sym">,</span> SE<span class="hl sym">],</span>
        <span class="hl sym">[</span>SE<span class="hl sym">,</span> SW<span class="hl sym">,</span> W<span class="hl sym">,</span> SW<span class="hl sym">],</span>
        <span class="hl sym">[</span>W<span class="hl sym">,</span> W<span class="hl sym">,</span> SW<span class="hl sym">,</span> SE<span class="hl sym">],</span>
        <span class="hl sym">[</span>E<span class="hl sym">,</span> E<span class="hl sym">,</span> SW<span class="hl sym">,</span> SE<span class="hl sym">],</span>
        <span class="hl sym">[</span>NW<span class="hl sym">,</span> W<span class="hl sym">,</span> NW<span class="hl sym">,</span> SE<span class="hl sym">,</span> SW<span class="hl sym">],</span>
        <span class="hl sym">[</span>E<span class="hl sym">,</span> E<span class="hl sym">,</span> NE<span class="hl sym">,</span> W<span class="hl sym">],</span>
        <span class="hl sym">[</span>NW<span class="hl sym">,</span> NE<span class="hl sym">,</span> NE<span class="hl sym">,</span> W<span class="hl sym">],</span>
        <span class="hl sym">[</span>NE<span class="hl sym">,</span> SE<span class="hl sym">,</span> E<span class="hl sym">,</span> NE<span class="hl sym">],</span>
        <span class="hl sym">[</span>SE<span class="hl sym">,</span> SE<span class="hl sym">,</span> E<span class="hl sym">,</span> SE<span class="hl sym">],</span>
        <span class="hl sym">[</span>E<span class="hl sym">,</span> NW<span class="hl sym">,</span> NW<span class="hl sym">,</span> NW<span class="hl sym">]</span>
    <span class="hl sym">]</span>
    <span class="hl sym">;</span>

width <span class="hl sym">::</span> Int<span class="hl sym">;</span>
width <span class="hl sym">=</span> <span class="hl num">5</span><span class="hl sym">;</span>

height <span class="hl sym">::</span> Int<span class="hl sym">;</span>
height <span class="hl sym">=</span> <span class="hl num">10</span><span class="hl sym">;</span>

<span class="hl com">/** rotate a puzzle piece clockwise */</span>
rotatePiece <span class="hl sym">:: [</span>Direction<span class="hl sym">] -&gt; [</span>Direction<span class="hl sym">];</span>
rotatePiece <span class="hl sym">!</span>piece <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        rotate <span class="hl sym">::</span> Direction <span class="hl sym">-&gt;</span> Direction<span class="hl sym">;</span>
        rotate <span class="hl sym">!</span>direction <span class="hl sym">=</span>
            <span class="hl kwa">case</span> direction <span class="hl kwa">of</span>
            E <span class="hl sym">-&gt;</span> SE<span class="hl sym">;</span>
            SE <span class="hl sym">-&gt;</span> SW<span class="hl sym">;</span>
            SW <span class="hl sym">-&gt;</span> W<span class="hl sym">;</span>
            W <span class="hl sym">-&gt;</span> NW<span class="hl sym">;</span>
            NW <span class="hl sym">-&gt;</span> NE<span class="hl sym">;</span>
            NE <span class="hl sym">-&gt;</span> E<span class="hl sym">;</span>
            <span class="hl sym">;</span>
    <span class="hl kwa">in</span>
        map rotate piece
    <span class="hl sym">;</span>

<span class="hl com">/** flip a piece about it's vertical axis*/</span>
flipPiece <span class="hl sym">:: [</span>Direction<span class="hl sym">] -&gt; [</span>Direction<span class="hl sym">];</span>
flipPiece <span class="hl sym">!</span>piece <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        flip <span class="hl sym">::</span> Direction <span class="hl sym">-&gt;</span> Direction<span class="hl sym">;</span>
        flip <span class="hl sym">!</span>direction <span class="hl sym">=</span>
            <span class="hl kwa">case</span> direction <span class="hl kwa">of</span>
            E <span class="hl sym">-&gt;</span> W<span class="hl sym">;</span>
            SE <span class="hl sym">-&gt;</span> SW<span class="hl sym">;</span>
            SW <span class="hl sym">-&gt;</span> SE<span class="hl sym">;</span>
            W <span class="hl sym">-&gt;</span> E<span class="hl sym">;</span>
            NW <span class="hl sym">-&gt;</span> NE<span class="hl sym">;</span>
            NE <span class="hl sym">-&gt;</span> NW<span class="hl sym">;</span>
            <span class="hl sym">;</span>
    <span class="hl kwa">in</span>
        map flip piece
    <span class="hl sym">;</span>

<span class="hl com">/**</span>
<span class="hl com"> * the puzzle board is represented as a 64 long. The positions on the board,</span>
<span class="hl com"> * from the top left, row by row, to the bottom right are represented</span>
<span class="hl com"> * by bits highbit to lowbit inclusive. A set bit means the position is occupied.</span>
<span class="hl com"> * An unset bit means the bit is not occupied.</span>
<span class="hl com"> */</span>
highBit <span class="hl sym">::</span> Long<span class="hl sym">;</span>
highBit <span class="hl sym">=</span> <span class="hl num">4611686018427387904</span><span class="hl sym">;</span>

lowBit <span class="hl sym">::</span> Long<span class="hl sym">;</span>
lowBit <span class="hl sym">=</span> <span class="hl num">8192</span><span class="hl sym">;</span>

fullBoard <span class="hl sym">::</span> Long<span class="hl sym">;</span>
fullBoard <span class="hl sym">=</span> <span class="hl num">9223372036854767616</span><span class="hl sym">;</span>

<span class="hl com">/**</span>
<span class="hl com"> * an array with one mask for each position on the board. The set bits in the mask</span>
<span class="hl com"> * correspond to positions on the board that are adjacent.</span>
<span class="hl com"> */</span>
adjacentSquares <span class="hl sym">::</span> JLongArray<span class="hl sym">;</span>
adjacentSquares <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        adjacent <span class="hl sym">:: [</span>Direction<span class="hl sym">];</span>
        <span class="hl slc">//route of steps to surround the square</span>
        adjacent <span class="hl sym">= [</span>E<span class="hl sym">,</span> SW<span class="hl sym">,</span> W<span class="hl sym">,</span> NW<span class="hl sym">,</span> NE<span class="hl sym">,</span> E<span class="hl sym">];</span>
    <span class="hl kwa">in</span>
        jLongArrayfromList
            <span class="hl sym">(</span>List<span class="hl sym">.</span>mapIndexed
                <span class="hl sym">(</span>
                    \<span class="hl sym">!</span>a <span class="hl sym">!</span>i <span class="hl sym">-&gt;</span>
                        toBits
                        $ validCoords
                        $ List<span class="hl sym">.</span>tail
                        $ toCoords adjacent <span class="hl sym">(</span>i <span class="hl sym">%</span> width<span class="hl sym">) (</span>i <span class="hl sym">/</span> width<span class="hl sym">)</span>
                <span class="hl sym">)</span>
                <span class="hl sym">(</span>List<span class="hl sym">.</span>replicate <span class="hl sym">(</span>width <span class="hl sym">*</span> height<span class="hl sym">) (</span><span class="hl num">0</span> <span class="hl sym">::</span> Int<span class="hl sym">))</span>
            <span class="hl sym">)</span>
    <span class="hl sym">;</span>

<span class="hl com">/**</span>
<span class="hl com"> * returns the board position 0 .. 49 of the first occuipied square</span>
<span class="hl com"> */</span>
getFirstSetBit <span class="hl sym">::</span> Long <span class="hl sym">-&gt;</span> Int<span class="hl sym">;</span>
getFirstSetBit <span class="hl sym">!</span>word <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        helper <span class="hl sym">::</span> Long <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> Int<span class="hl sym">;</span>
        helper <span class="hl sym">!</span>word <span class="hl sym">!</span>bit <span class="hl sym">!</span>i <span class="hl sym">=</span>
            <span class="hl kwa">if</span> bitwiseAnd word bit <span class="hl sym">!=</span> <span class="hl num">0</span> <span class="hl kwa">then</span>
                i
            <span class="hl kwa">else</span>
                helper word <span class="hl sym">(</span>shiftRUnsigned bit <span class="hl num">1</span><span class="hl sym">) (</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
            <span class="hl sym">;</span>
    <span class="hl kwa">in</span>
        helper word highBit <span class="hl num">0</span>
    <span class="hl sym">;</span>

<span class="hl com">/**</span>
<span class="hl com"> * return the number of bits that are set in a mask</span>
<span class="hl com"> */</span>
countBits <span class="hl sym">::</span> Long <span class="hl sym">-&gt;</span> Int<span class="hl sym">;</span>
countBits <span class="hl sym">!</span>word <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        helper <span class="hl sym">::</span> Long <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> Int<span class="hl sym">;</span>
        helper <span class="hl sym">!</span>word <span class="hl sym">!</span>count <span class="hl sym">=</span>
            <span class="hl kwa">if</span> word <span class="hl sym">==</span> <span class="hl num">0</span> <span class="hl kwa">then</span>
                count
            <span class="hl kwa">else</span>
                helper <span class="hl sym">(</span>bitwiseAnd word <span class="hl sym">(</span>word <span class="hl sym">-</span> <span class="hl num">1</span><span class="hl sym">)) (</span>count <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
            <span class="hl sym">;</span>
    <span class="hl kwa">in</span>
        eager $ helper word <span class="hl num">0</span>
    <span class="hl sym">;</span>

<span class="hl com">/**</span>
<span class="hl com"> * returns true if the board mask has an island of fewer than five positions -</span>
<span class="hl com"> * used to prune positions tha have 'holes' that no piece could fit into</span>
<span class="hl com"> * (as all pieces are of size 5)</span>
<span class="hl com"> */</span>
hasSmallIslands <span class="hl sym">::</span> Long <span class="hl sym">-&gt;</span> Boolean<span class="hl sym">;</span>
hasSmallIslands <span class="hl sym">!</span>board <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        fill <span class="hl sym">::</span> Long <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> Long<span class="hl sym">;</span>
        fill <span class="hl sym">!</span>board <span class="hl sym">!</span>filled <span class="hl sym">!</span>seeds <span class="hl sym">=</span>
            <span class="hl kwa">if</span> seeds <span class="hl sym">==</span> <span class="hl num">0</span> <span class="hl kwa">then</span>
                filled
            <span class="hl kwa">else</span>
                <span class="hl kwa">let</span>
                    highestSeed <span class="hl sym">::</span> Int<span class="hl sym">;</span>
                    highestSeed <span class="hl sym">=</span> eager $ getFirstSetBit seeds<span class="hl sym">;</span>

                    newSeeds <span class="hl sym">::</span> Long<span class="hl sym">;</span>
                    newSeeds <span class="hl sym">=</span>
                        eager
                        $ bitwiseAnd
                            <span class="hl sym">(</span>longArray_subscript adjacentSquares highestSeed<span class="hl sym">)</span>
                            <span class="hl sym">(</span>Bits<span class="hl sym">.</span>complement $ bitwiseOr filled board<span class="hl sym">)</span>
                        <span class="hl sym">;</span>
                <span class="hl kwa">in</span>
                    fill
                        board
                        <span class="hl sym">(</span>bitwiseOr filled <span class="hl sym">(</span>bitwiseOr seeds newSeeds<span class="hl sym">))</span>
                        <span class="hl sym">(</span>bitwiseAnd
                            <span class="hl sym">(</span>bitwiseOr seeds newSeeds<span class="hl sym">)</span>
                            <span class="hl sym">(</span>
                                Bits<span class="hl sym">.</span>complement
                                $ Bits<span class="hl sym">.</span>shiftR highBit <span class="hl sym">(</span>fromInt highestSeed<span class="hl sym">)</span>
                            <span class="hl sym">)</span>
                        <span class="hl sym">)</span>
            <span class="hl sym">;</span>
    <span class="hl kwa">in</span>

        <span class="hl kwa">if</span> bitwiseAnd board fullBoard <span class="hl sym">==</span> fullBoard <span class="hl kwa">then</span>
            False
        <span class="hl kwa">else</span>
            <span class="hl kwa">let</span>
                island <span class="hl sym">::</span> Long<span class="hl sym">;</span>
                island <span class="hl sym">=</span>
                    eager
                    $ fill
                        board
                        <span class="hl num">0</span>
                        <span class="hl sym">(</span>
                            Bits<span class="hl sym">.</span>highestBitMask
                            $ bitwiseAnd fullBoard <span class="hl sym">(</span>Bits<span class="hl sym">.</span>complement board<span class="hl sym">)</span>
                        <span class="hl sym">)</span>
                    <span class="hl sym">;</span>
            <span class="hl kwa">in</span>
                <span class="hl kwa">if</span> countBits island <span class="hl sym">&lt;</span> <span class="hl num">5</span> <span class="hl kwa">then</span>
                    True
                <span class="hl kwa">else</span>
                    hasSmallIslands <span class="hl sym">(</span>bitwiseOr board island<span class="hl sym">)</span>
    <span class="hl sym">;</span>

<span class="hl com">/**</span>
<span class="hl com"> * take a solution and make the reverse - a second solution that is a rotation of the first.</span>
<span class="hl com"> */</span>
makeReverseSolution <span class="hl sym">::</span> JLongArray <span class="hl sym">-&gt;</span> JLongArray <span class="hl sym">-&gt;</span> JLongArray<span class="hl sym">;</span>
makeReverseSolution <span class="hl sym">!</span>solution <span class="hl sym">!</span>reversed <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        reverseMask <span class="hl sym">::</span> Long <span class="hl sym">-&gt;</span> Long<span class="hl sym">;</span>
        reverseMask <span class="hl sym">!</span>board <span class="hl sym">=</span>
            <span class="hl kwa">let</span>
                reverse <span class="hl sym">::</span> Long <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> Long<span class="hl sym">;</span>
                reverse <span class="hl sym">!</span>board <span class="hl sym">!</span>res <span class="hl sym">!</span>fromBit <span class="hl sym">!</span>toBit <span class="hl sym">=</span>
                    <span class="hl kwa">if</span> fromBit <span class="hl sym">&lt;</span> lowBit <span class="hl kwa">then</span>
                        res
                    <span class="hl kwa">else if</span> bitwiseAnd fromBit board <span class="hl sym">!=</span> <span class="hl num">0</span> <span class="hl kwa">then</span>
                        reverse
                            board
                            <span class="hl sym">(</span>bitwiseOr res toBit<span class="hl sym">)</span>
                            <span class="hl sym">(</span>shiftRUnsigned fromBit <span class="hl num">1</span><span class="hl sym">)</span>
                            <span class="hl sym">(</span>shiftL toBit <span class="hl num">1</span><span class="hl sym">)</span>
                    <span class="hl kwa">else</span>
                        reverse
                            board
                            res
                            <span class="hl sym">(</span>shiftRUnsigned fromBit <span class="hl num">1</span><span class="hl sym">)</span>
                            <span class="hl sym">(</span>shiftL toBit <span class="hl num">1</span><span class="hl sym">)</span>
                    <span class="hl sym">;</span>
            <span class="hl kwa">in</span>
                reverse board <span class="hl sym">(</span>bitwiseAnd board <span class="hl num">15</span><span class="hl sym">)</span> highBit lowBit
            <span class="hl sym">;</span>

        len <span class="hl sym">::</span> Int<span class="hl sym">;</span>
        len <span class="hl sym">=</span> eager $ longArray_length solution<span class="hl sym">;</span>

        loop <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> JLongArray<span class="hl sym">;</span>
        loop <span class="hl sym">!</span>i <span class="hl sym">=</span>
            <span class="hl kwa">if</span> i <span class="hl sym">&lt;</span> len <span class="hl kwa">then</span>
                longArray_update
                    reversed
                    i
                    <span class="hl sym">(</span>reverseMask $ longArray_subscript solution i<span class="hl sym">)</span>
                <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                loop <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
            <span class="hl kwa">else</span>
                reversed
            <span class="hl sym">;</span>
    <span class="hl kwa">in</span>
        loop <span class="hl num">1</span>
    <span class="hl sym">;</span>

<span class="hl com">/** true if the coord is on the board*/</span>
validCoord <span class="hl sym">:: (</span>Int<span class="hl sym">,</span> Int<span class="hl sym">) -&gt;</span> Boolean<span class="hl sym">;</span>
validCoord <span class="hl sym">!</span>coord <span class="hl sym">=</span>
    <span class="hl kwa">case</span> coord <span class="hl kwa">of</span>
    <span class="hl sym">(</span>x<span class="hl sym">,</span> y<span class="hl sym">) -&gt;</span> x <span class="hl sym">&gt;=</span> <span class="hl num">0</span> <span class="hl sym">&amp;&amp;</span> x <span class="hl sym">&lt;</span> width <span class="hl sym">&amp;&amp;</span> y <span class="hl sym">&gt;=</span> <span class="hl num">0</span> <span class="hl sym">&amp;&amp;</span> y <span class="hl sym">&lt;</span> height<span class="hl sym">;</span>
    <span class="hl sym">;</span>

<span class="hl com">/** filter a list of corrds and return only those that fit on the board*/</span>
validCoords <span class="hl sym">:: [(</span>Int<span class="hl sym">,</span> Int<span class="hl sym">)] -&gt; [(</span>Int<span class="hl sym">,</span> Int<span class="hl sym">)];</span>
validCoords <span class="hl sym">!</span>coords <span class="hl sym">=</span> List<span class="hl sym">.</span>filter validCoord coords<span class="hl sym">;</span>

<span class="hl com">/** convert a piece to a list of coords*/</span>
toCoords <span class="hl sym">:: [</span>Direction<span class="hl sym">] -&gt;</span> Int <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt; [(</span>Int<span class="hl sym">,</span> Int<span class="hl sym">)];</span>
toCoords <span class="hl sym">!</span>piece <span class="hl sym">!</span>x <span class="hl sym">!</span>y <span class="hl sym">=</span>
    <span class="hl kwa">case</span> piece <span class="hl kwa">of</span>
    head <span class="hl sym">:</span> tail <span class="hl sym">-&gt;</span>
        <span class="hl kwa">case</span> head <span class="hl kwa">of</span>
        E <span class="hl sym">-&gt; (</span>x<span class="hl sym">,</span> y<span class="hl sym">) :</span> toCoords tail <span class="hl sym">(</span>x <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span> y<span class="hl sym">;</span>
        SE <span class="hl sym">-&gt; (</span>x<span class="hl sym">,</span> y<span class="hl sym">) :</span> toCoords tail <span class="hl sym">(</span>x <span class="hl sym">+</span> bitwiseAnd y <span class="hl num">1</span><span class="hl sym">) (</span>y <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">);</span>
        SW <span class="hl sym">-&gt;</span>
            <span class="hl sym">(</span>x<span class="hl sym">,</span> y<span class="hl sym">) :</span> toCoords tail <span class="hl sym">(</span>x <span class="hl sym">- (</span><span class="hl num">1</span> <span class="hl sym">-</span> bitwiseAnd y <span class="hl num">1</span><span class="hl sym">)) (</span>y <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">);</span>
        W <span class="hl sym">-&gt; (</span>x<span class="hl sym">,</span> y<span class="hl sym">) :</span> toCoords tail <span class="hl sym">(</span>x <span class="hl sym">-</span> <span class="hl num">1</span><span class="hl sym">)</span> y<span class="hl sym">;</span>
        NW <span class="hl sym">-&gt;</span>
            <span class="hl sym">(</span>x<span class="hl sym">,</span> y<span class="hl sym">) :</span> toCoords tail <span class="hl sym">(</span>x <span class="hl sym">- (</span><span class="hl num">1</span> <span class="hl sym">-</span> bitwiseAnd y <span class="hl num">1</span><span class="hl sym">)) (</span>y <span class="hl sym">-</span> <span class="hl num">1</span><span class="hl sym">);</span>
        NE <span class="hl sym">-&gt; (</span>x<span class="hl sym">,</span> y<span class="hl sym">) :</span> toCoords tail <span class="hl sym">(</span>x <span class="hl sym">+</span> bitwiseAnd y <span class="hl num">1</span><span class="hl sym">) (</span>y <span class="hl sym">-</span> <span class="hl num">1</span><span class="hl sym">);</span>
        <span class="hl sym">;</span>
    <span class="hl sym">[] -&gt; [(</span>x<span class="hl sym">,</span> y<span class="hl sym">)];</span>
    <span class="hl sym">;</span>

getValueAtbit <span class="hl sym">::</span> JLongArray <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> Long<span class="hl sym">;</span>
getValueAtbit <span class="hl sym">!</span>solution <span class="hl sym">!</span>bit <span class="hl sym">!</span>i <span class="hl sym">=</span>
    <span class="hl kwa">if</span> bitwiseAnd bit <span class="hl sym">(</span>longArray_subscript solution i<span class="hl sym">) !=</span> <span class="hl num">0</span> <span class="hl kwa">then</span>
        bitwiseAnd <span class="hl sym">(</span>longArray_subscript solution i<span class="hl sym">)</span> <span class="hl num">15</span>
    <span class="hl kwa">else</span>
        getValueAtbit solution bit <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
    <span class="hl sym">;</span>

copy <span class="hl sym">::</span> JLongArray <span class="hl sym">-&gt;</span> JLongArray <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt; ();</span>
copy <span class="hl sym">!</span>solution1 <span class="hl sym">!</span>solution2 <span class="hl sym">!</span>i <span class="hl sym">=</span>
    <span class="hl kwa">if</span> i <span class="hl sym">&lt;</span> <span class="hl num">11</span> <span class="hl kwa">then</span>
        longArray_update solution1 i <span class="hl sym">(</span>longArray_subscript solution2 i<span class="hl sym">)</span>
        <span class="hl sym">`</span>seq<span class="hl sym">`</span>
        copy solution1 solution2 <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
    <span class="hl kwa">else</span>
        <span class="hl sym">()</span>
    <span class="hl sym">;</span>

<span class="hl com">/**</span>
<span class="hl com"> * set solution 2 to the max of solution 2 and solution 1.</span>
<span class="hl com"> */</span>
updateMaxSolution <span class="hl sym">::</span> JLongArray <span class="hl sym">-&gt;</span> JLongArray <span class="hl sym">-&gt; ();</span>
updateMaxSolution <span class="hl sym">!</span>solution1 <span class="hl sym">!</span>solution2 <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        greaterThan <span class="hl sym">::</span> JLongArray <span class="hl sym">-&gt;</span> JLongArray <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> Boolean<span class="hl sym">;</span>
        greaterThan <span class="hl sym">!</span>solution1 <span class="hl sym">!</span>solution2 <span class="hl sym">!</span>bit <span class="hl sym">=</span>
            <span class="hl kwa">let</span>
                v1 <span class="hl sym">::</span> Long<span class="hl sym">;</span>
                v1 <span class="hl sym">=</span> eager $ getValueAtbit solution1 bit <span class="hl num">1</span><span class="hl sym">;</span>

                v2 <span class="hl sym">::</span> Long<span class="hl sym">;</span>
                v2 <span class="hl sym">=</span> eager $ getValueAtbit solution2 bit <span class="hl num">1</span><span class="hl sym">;</span>
            <span class="hl kwa">in</span>
                <span class="hl kwa">if</span> v1 <span class="hl sym">==</span> v2 <span class="hl kwa">then</span>
                    greaterThan solution1 solution2 <span class="hl sym">(</span>shiftRUnsigned bit <span class="hl num">1</span><span class="hl sym">)</span>
                <span class="hl kwa">else</span>
                    v1 <span class="hl sym">&lt;</span> v2
            <span class="hl sym">;</span>
    <span class="hl kwa">in</span>

        <span class="hl kwa">if</span> greaterThan solution1 solution2 highBit <span class="hl kwa">then</span>
            copy solution1 solution2 <span class="hl num">0</span>
        <span class="hl kwa">else</span>
            <span class="hl sym">()</span>
    <span class="hl sym">;</span>

<span class="hl com">/**</span>
<span class="hl com"> * set solution 2 to the minimum of solution 2 and solution 1.</span>
<span class="hl com"> */</span>
updateMinSolution <span class="hl sym">::</span> JLongArray <span class="hl sym">-&gt;</span> JLongArray <span class="hl sym">-&gt; ();</span>
updateMinSolution <span class="hl sym">!</span>solution1 <span class="hl sym">!</span>solution2 <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        lessThan <span class="hl sym">::</span> JLongArray <span class="hl sym">-&gt;</span> JLongArray <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> Boolean<span class="hl sym">;</span>
        lessThan <span class="hl sym">!</span>solution1 <span class="hl sym">!</span>solution2 <span class="hl sym">!</span>bit <span class="hl sym">=</span>
            <span class="hl kwa">let</span>
                v1 <span class="hl sym">::</span> Long<span class="hl sym">;</span>
                v1 <span class="hl sym">=</span> eager $ getValueAtbit solution1 bit <span class="hl num">1</span><span class="hl sym">;</span>

                v2 <span class="hl sym">::</span> Long<span class="hl sym">;</span>
                v2 <span class="hl sym">=</span> eager $ getValueAtbit solution2 bit <span class="hl num">1</span><span class="hl sym">;</span>
            <span class="hl kwa">in</span>
                <span class="hl kwa">if</span> v1 <span class="hl sym">==</span> v2 <span class="hl kwa">then</span>
                    lessThan solution1 solution2 <span class="hl sym">(</span>shiftRUnsigned bit <span class="hl num">1</span><span class="hl sym">)</span>
                <span class="hl kwa">else</span>
                    v1 <span class="hl sym">&gt;</span> v2
            <span class="hl sym">;</span>
    <span class="hl kwa">in</span>

        <span class="hl kwa">if</span> lessThan solution1 solution2 highBit <span class="hl kwa">then</span>
            copy solution1 solution2 <span class="hl num">0</span>
        <span class="hl kwa">else</span>
            <span class="hl sym">()</span>
    <span class="hl sym">;</span>

<span class="hl com">/** true if the list of coords all fit on the board*/</span>
fits <span class="hl sym">:: [(</span>Int<span class="hl sym">,</span> Int<span class="hl sym">)] -&gt;</span> Boolean<span class="hl sym">;</span>
fits <span class="hl sym">!</span>coords <span class="hl sym">=</span> List<span class="hl sym">.</span>all validCoord coords<span class="hl sym">;</span>

<span class="hl com">/** convert a coord to a bit mask*/</span>
toBit <span class="hl sym">:: (</span>Int<span class="hl sym">,</span> Int<span class="hl sym">) -&gt;</span> Long<span class="hl sym">;</span>
toBit <span class="hl sym">!</span>coord <span class="hl sym">=</span> shiftRUnsigned highBit <span class="hl sym">(</span>fromInt <span class="hl sym">(</span>coord<span class="hl sym">.</span>#<span class="hl num">1</span> <span class="hl sym">+</span> coord<span class="hl sym">.</span>#<span class="hl num">2</span> <span class="hl sym">*</span> <span class="hl num">5</span><span class="hl sym">));</span>

<span class="hl com">/** convert a list of coords to be bit mask*/</span>
toBits <span class="hl sym">:: [(</span>Int<span class="hl sym">,</span> Int<span class="hl sym">)] -&gt;</span> Long<span class="hl sym">;</span>
toBits <span class="hl sym">!</span>coords <span class="hl sym">=</span> foldLeftStrict bitwiseOr <span class="hl num">0</span> <span class="hl sym">(</span>map toBit coords<span class="hl sym">);</span>

<span class="hl com">/** convert a list of coords to be bit mask, with a piece id in the lower bits*/</span>
coordsToBits <span class="hl sym">:: [(</span>Int<span class="hl sym">,</span> Int<span class="hl sym">)] -&gt;</span> Int <span class="hl sym">-&gt;</span> Long<span class="hl sym">;</span>
coordsToBits <span class="hl sym">!</span>coords <span class="hl sym">!</span>pieceNo <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        bits <span class="hl sym">:: [</span>Long<span class="hl sym">];</span>
        bits <span class="hl sym">=</span> map toBit coords<span class="hl sym">;</span>
    <span class="hl kwa">in</span>
        foldLeftStrict bitwiseOr <span class="hl sym">(</span>fromInt pieceNo<span class="hl sym">)</span> bits
    <span class="hl sym">;</span>

<span class="hl com">/** find the next empty square starting at square*/</span>
findNextEmptySquare <span class="hl sym">::</span> Long <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> Int<span class="hl sym">;</span>
findNextEmptySquare <span class="hl sym">!</span>board <span class="hl sym">!</span>square <span class="hl sym">=</span>
    <span class="hl kwa">if</span> bitwiseAnd board <span class="hl sym">(</span>shiftRUnsigned highBit <span class="hl sym">(</span>fromInt square<span class="hl sym">)) ==</span> <span class="hl num">0</span> <span class="hl kwa">then</span>
        square
    <span class="hl kwa">else</span>
        findNextEmptySquare board <span class="hl sym">(</span>square <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
    <span class="hl sym">;</span>

<span class="hl com">/** convert a solution to s string in the benchmark format*/</span>
showSolution <span class="hl sym">::</span> JLongArray <span class="hl sym">-&gt;</span> String<span class="hl sym">;</span>
showSolution <span class="hl sym">!</span>solution <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        findId <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> String<span class="hl sym">;</span>
        findId <span class="hl sym">!</span>i <span class="hl sym">!</span>bit <span class="hl sym">=</span>
            <span class="hl kwa">if</span> i <span class="hl sym">==</span> <span class="hl num">11</span> <span class="hl kwa">then</span>
                <span class="hl str">&quot;-&quot;</span>
            <span class="hl kwa">else if</span> bitwiseAnd <span class="hl sym">(</span>longArray_subscript solution i<span class="hl sym">)</span> bit <span class="hl sym">&gt;</span> <span class="hl num">0</span> <span class="hl kwa">then</span>
                show <span class="hl sym">(</span>i <span class="hl sym">-</span> <span class="hl num">1</span><span class="hl sym">)</span>
            <span class="hl kwa">else</span>
                findId <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span> bit
            <span class="hl sym">;</span>

        drawBoard <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> String <span class="hl sym">-&gt;</span> String<span class="hl sym">;</span>
        drawBoard <span class="hl sym">!</span>i <span class="hl sym">!</span>bit <span class="hl sym">!</span>result <span class="hl sym">=</span>
            <span class="hl kwa">let</span>
                term1 <span class="hl sym">::</span> String<span class="hl sym">;</span>
                term1 <span class="hl sym">=</span>
                    <span class="hl kwa">if</span> i <span class="hl sym">&gt;</span> <span class="hl num">0</span> <span class="hl sym">&amp;&amp;</span> i <span class="hl sym">%</span> <span class="hl num">5</span> <span class="hl sym">==</span> <span class="hl num">0</span> <span class="hl kwa">then</span>
                        <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span>
                    <span class="hl kwa">else</span>
                        <span class="hl str">&quot;&quot;</span>
                    <span class="hl sym">;</span>

                term2 <span class="hl sym">::</span> String<span class="hl sym">;</span>
                term2 <span class="hl sym">=</span>
                    <span class="hl kwa">if</span> i <span class="hl sym">%</span> <span class="hl num">10</span> <span class="hl sym">==</span> <span class="hl num">5</span> <span class="hl kwa">then</span>
                        <span class="hl str">&quot; &quot;</span>
                    <span class="hl kwa">else</span>
                        <span class="hl str">&quot;&quot;</span>
                    <span class="hl sym">;</span>
            <span class="hl kwa">in</span>
                <span class="hl kwa">if</span> i <span class="hl sym">&lt;</span> <span class="hl num">50</span> <span class="hl kwa">then</span>
                    drawBoard
                        <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
                        <span class="hl sym">(</span>shiftRUnsigned bit <span class="hl num">1</span><span class="hl sym">)</span>
                        <span class="hl sym">(</span>result <span class="hl sym">++</span> term1 <span class="hl sym">++</span> term2 <span class="hl sym">++</span> findId <span class="hl num">0</span> bit <span class="hl sym">++</span> <span class="hl str">&quot; &quot;</span><span class="hl sym">)</span>
                <span class="hl kwa">else</span>
                    result
            <span class="hl sym">;</span>
    <span class="hl kwa">in</span>

        drawBoard <span class="hl num">0</span> highBit <span class="hl str">&quot;&quot;</span>
    <span class="hl sym">;</span>

<span class="hl com">/**</span>
<span class="hl com"> * Creates an array in which for each square on the board</span>
<span class="hl com"> * there is an array of bit masks for the pieces that occupy that square as their first square</span>
<span class="hl com"> */</span>
allSortedMasks <span class="hl sym">:: [[</span>Direction<span class="hl sym">]] -&gt;</span> Array JLongArray<span class="hl sym">;</span>
allSortedMasks <span class="hl sym">!</span>pieces <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        masks <span class="hl sym">:: [</span>Long<span class="hl sym">];</span>
        masks <span class="hl sym">=</span>
            List<span class="hl sym">.</span>reverse
            $ List<span class="hl sym">.</span>sortExternal
            $ Prelude<span class="hl sym">.</span>concat
            $ List<span class="hl sym">.</span>zipWith getAllMasks pieces <span class="hl sym">[</span><span class="hl num">1</span><span class="hl sym">,</span> <span class="hl num">2</span><span class="hl sym">,</span> <span class="hl num">3</span><span class="hl sym">,</span> <span class="hl num">4</span><span class="hl sym">,</span> <span class="hl num">5</span><span class="hl sym">,</span> <span class="hl num">6</span><span class="hl sym">,</span> <span class="hl num">7</span><span class="hl sym">,</span> <span class="hl num">8</span><span class="hl sym">,</span> <span class="hl num">9</span><span class="hl sym">,</span> <span class="hl num">10</span><span class="hl sym">]</span>
            <span class="hl sym">;</span>

        loop <span class="hl sym">::</span> Long <span class="hl sym">-&gt; [</span>Long<span class="hl sym">] -&gt; [[</span>Long<span class="hl sym">]] -&gt; [[</span>Long<span class="hl sym">]];</span>
        loop <span class="hl sym">!</span>bit <span class="hl sym">!</span>masks <span class="hl sym">!</span>res <span class="hl sym">=</span>
            <span class="hl kwa">if</span> bit <span class="hl sym">&lt;</span> lowBit <span class="hl kwa">then</span>
                res
            <span class="hl kwa">else</span>
                loop
                    <span class="hl sym">(</span>shiftRUnsigned bit <span class="hl num">1</span><span class="hl sym">)</span>
                    <span class="hl sym">(</span>List<span class="hl sym">.</span>dropWhile <span class="hl sym">(</span>\<span class="hl sym">!</span>a <span class="hl sym">-&gt;</span> a <span class="hl sym">&gt;</span> bit<span class="hl sym">)</span> masks<span class="hl sym">)</span>
                    <span class="hl sym">(</span>res <span class="hl sym">++ [</span>List<span class="hl sym">.</span>takeWhile <span class="hl sym">(</span>\<span class="hl sym">!</span>a <span class="hl sym">-&gt;</span> a <span class="hl sym">&gt;</span> bit<span class="hl sym">)</span> masks<span class="hl sym">])</span>
            <span class="hl sym">;</span>
    <span class="hl kwa">in</span>

        Array<span class="hl sym">.</span>fromList <span class="hl sym">(</span>map jLongArrayfromList <span class="hl sym">(</span>loop highBit masks <span class="hl sym">[]))</span>
    <span class="hl sym">;</span>

meteor <span class="hl sym">::</span> Int <span class="hl sym">-&gt; ();</span>
meteor <span class="hl sym">!</span>n <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        masks <span class="hl sym">::</span> Array JLongArray<span class="hl sym">;</span>
        masks <span class="hl sym">=</span> allSortedMasks pieces<span class="hl sym">;</span>

        minSol <span class="hl sym">::</span> JLongArray<span class="hl sym">;</span>
        minSol <span class="hl sym">=</span> longArray_new <span class="hl num">11</span><span class="hl sym">;</span>

        maxSol <span class="hl sym">::</span> JLongArray<span class="hl sym">;</span>
        maxSol <span class="hl sym">=</span> longArray_new <span class="hl num">11</span><span class="hl sym">;</span>

        workingSolution <span class="hl sym">::</span> JLongArray<span class="hl sym">;</span>
        workingSolution <span class="hl sym">=</span> longArray_new <span class="hl num">11</span><span class="hl sym">;</span>
    <span class="hl kwa">in</span>
        longArray_update maxSol <span class="hl num">1</span> highBit
        <span class="hl sym">`</span>seq<span class="hl sym">`</span>
        longArray_update minSol <span class="hl num">1</span> <span class="hl sym">(</span>bitwiseOr highBit <span class="hl num">11</span><span class="hl sym">)</span>
        <span class="hl sym">`</span>seq<span class="hl sym">`</span>
        solve
            <span class="hl num">0</span>
            emptyBoard
            workingSolution
            <span class="hl sym">(</span>longArray_new <span class="hl num">11</span><span class="hl sym">)</span>
            masks
            <span class="hl sym">(</span>Array<span class="hl sym">.</span>subscript masks <span class="hl num">0</span><span class="hl sym">)</span>
            <span class="hl num">0</span>
            <span class="hl num">0</span>
            maxSol
            minSol
        <span class="hl sym">`</span>seq<span class="hl sym">`</span>
        printLine
            <span class="hl sym">(</span>
                show <span class="hl sym">(</span>longArray_subscript workingSolution <span class="hl num">0</span><span class="hl sym">)</span>
                <span class="hl sym">++</span> <span class="hl str">&quot; solutions found&quot;</span>
            <span class="hl sym">)</span>
        <span class="hl sym">`</span>seq<span class="hl sym">`</span>
        printLine <span class="hl str">&quot;&quot;</span>
        <span class="hl sym">`</span>seq<span class="hl sym">`</span>
        printLine <span class="hl sym">(</span>showSolution minSol<span class="hl sym">)</span>
        <span class="hl sym">`</span>seq<span class="hl sym">`</span>
        printLine <span class="hl str">&quot;&quot;</span>
        <span class="hl sym">`</span>seq<span class="hl sym">`</span>
        printLine <span class="hl sym">(</span>showSolution maxSol<span class="hl sym">)</span>
        <span class="hl sym">`</span>seq<span class="hl sym">`</span>
        printLine <span class="hl str">&quot;&quot;</span>
    <span class="hl sym">;</span>

solve <span class="hl sym">::</span>
    Int <span class="hl sym">-&gt;</span> Long <span class="hl sym">-&gt;</span> JLongArray <span class="hl sym">-&gt;</span> JLongArray <span class="hl sym">-&gt;</span> Array JLongArray <span class="hl sym">-&gt;</span> JLongArray
    <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> JLongArray <span class="hl sym">-&gt;</span> JLongArray <span class="hl sym">-&gt; ();</span>
solve <span class="hl sym">!</span>i <span class="hl sym">!</span>board <span class="hl sym">!</span>solution <span class="hl sym">!</span>reverseSolution <span class="hl sym">!</span>allMasks <span class="hl sym">!</span>masks <span class="hl sym">!</span>numPieces
      <span class="hl sym">!</span>boardSquare <span class="hl sym">!</span>maxSolution <span class="hl sym">!</span>minSolution <span class="hl sym">=</span>

    <span class="hl kwa">if</span> i <span class="hl sym">&gt;=</span> longArray_length masks <span class="hl kwa">then</span>
        <span class="hl sym">()</span>
    <span class="hl kwa">else</span>
        <span class="hl kwa">let</span>
            pieceMask <span class="hl sym">::</span> Long<span class="hl sym">;</span>
            pieceMask <span class="hl sym">=</span> eager $ longArray_subscript masks i<span class="hl sym">;</span>

            pieceId <span class="hl sym">::</span> Int<span class="hl sym">;</span>
            pieceId <span class="hl sym">=</span> eager $ Prelude<span class="hl sym">.</span>fromLong <span class="hl sym">(</span>bitwiseAnd pieceMask <span class="hl num">15</span><span class="hl sym">);</span>
        <span class="hl kwa">in</span>

            <span class="hl slc">//if the piece is not already in use and it fits</span>
            <span class="hl kwa">if</span>
                longArray_subscript solution pieceId <span class="hl sym">==</span> <span class="hl num">0</span>
                <span class="hl sym">&amp;&amp;</span> bitwiseAnd board pieceMask <span class="hl sym">&lt;</span> <span class="hl num">16</span>
            <span class="hl kwa">then</span>
                <span class="hl kwa">let</span>
                    newBoard <span class="hl sym">::</span> Long<span class="hl sym">;</span>
                    newBoard <span class="hl sym">=</span> eager $ bitwiseOr board pieceMask<span class="hl sym">;</span>

                    nextSquare <span class="hl sym">::</span> Int<span class="hl sym">;</span>
                    nextSquare <span class="hl sym">=</span>
                        eager $ findNextEmptySquare newBoard boardSquare<span class="hl sym">;</span>
                <span class="hl kwa">in</span>
                    longArray_update solution pieceId pieceMask
                    <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                    <span class="hl sym">(</span>
                        <span class="hl kwa">if</span> numPieces <span class="hl sym">==</span> <span class="hl num">9</span> <span class="hl kwa">then</span>
                            longArray_update
                                solution
                                <span class="hl num">0</span>
                                <span class="hl sym">(</span>longArray_subscript solution <span class="hl num">0</span> <span class="hl sym">+</span> <span class="hl num">2</span><span class="hl sym">)</span>
                            <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                            makeReverseSolution solution reverseSolution
                            <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                            updateMaxSolution maxSolution solution
                            <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                            updateMaxSolution maxSolution reverseSolution
                            <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                            updateMinSolution minSolution solution
                            <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                            updateMinSolution minSolution reverseSolution
                            <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                            longArray_update solution pieceId <span class="hl num">0</span>
                            <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                            <span class="hl sym">()</span>
                        <span class="hl kwa">else if</span>
                            nextSquare <span class="hl sym">&gt;</span> <span class="hl num">25</span>
                            <span class="hl sym">&amp;&amp;</span> longArray_subscript solution <span class="hl num">1</span> <span class="hl sym">==</span> <span class="hl num">0</span>
                        <span class="hl kwa">then</span>
                            longArray_update solution pieceId <span class="hl num">0</span>
                            <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                            solve
                                <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
                                board
                                solution
                                reverseSolution
                                allMasks
                                masks
                                numPieces
                                boardSquare
                                maxSolution
                                minSolution
                        <span class="hl kwa">else</span>
                            solve
                                <span class="hl num">0</span>
                                newBoard
                                solution
                                reverseSolution
                                allMasks
                                <span class="hl sym">(</span>Array<span class="hl sym">.</span>subscript allMasks nextSquare<span class="hl sym">)</span>
                                <span class="hl sym">(</span>numPieces <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
                                nextSquare
                                maxSolution
                                minSolution
                            <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                            longArray_update solution pieceId <span class="hl num">0</span>
                            <span class="hl sym">`</span>seq<span class="hl sym">`</span>
                            solve
                                <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
                                board
                                solution
                                reverseSolution
                                allMasks
                                masks
                                numPieces
                                boardSquare
                                maxSolution
                                minSolution
                    <span class="hl sym">)</span>
            <span class="hl kwa">else</span>
                solve
                    <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
                    board
                    solution
                    reverseSolution
                    allMasks
                    masks
                    numPieces
                    boardSquare
                    maxSolution
                    minSolution
    <span class="hl sym">;</span>

<span class="hl com">/**</span>
<span class="hl com"> * computes a list of all the masks for a particular piece.</span>
<span class="hl com"> * The list includes all positions, rotations and flips of the piece.</span>
<span class="hl com"> */</span>
getAllMasks <span class="hl sym">:: [</span>Direction<span class="hl sym">] -&gt;</span> Int <span class="hl sym">-&gt; [</span>Long<span class="hl sym">];</span>
getAllMasks <span class="hl sym">!</span>piece <span class="hl sym">!</span>pieceNo <span class="hl sym">=</span>
    <span class="hl kwa">let</span>

        <span class="hl slc">//this is used so we omit masks were piece 1 is in the bottom half of the board</span>
        <span class="hl slc">//these positions will be covered by symmetry</span>
        heightp <span class="hl sym">::</span> Int<span class="hl sym">;</span>
        heightp <span class="hl sym">=</span>
            eager
            $
            <span class="hl sym">(</span>
                <span class="hl kwa">if</span> pieceNo <span class="hl sym">==</span> <span class="hl num">1</span> <span class="hl kwa">then</span>
                    height <span class="hl sym">/</span> <span class="hl num">2</span> <span class="hl sym">-</span> <span class="hl num">1</span>
                <span class="hl kwa">else</span>
                    height
            <span class="hl sym">)</span>
            <span class="hl sym">;</span>

        getRotationMasks <span class="hl sym">:: [</span>Direction<span class="hl sym">] -&gt;</span> Int <span class="hl sym">-&gt; [</span>Long<span class="hl sym">] -&gt; [</span>Long<span class="hl sym">];</span>
        getRotationMasks <span class="hl sym">!</span>piece <span class="hl sym">!</span>n <span class="hl sym">!</span>masks <span class="hl sym">=</span>
            getTranslationMasks piece
            <span class="hl sym">++</span> iff
                <span class="hl sym">(</span>n <span class="hl sym">&gt;</span> <span class="hl num">0</span><span class="hl sym">)</span>
                <span class="hl sym">(</span>getRotationMasks <span class="hl sym">(</span>rotatePiece piece<span class="hl sym">) (</span>n <span class="hl sym">-</span> <span class="hl num">1</span><span class="hl sym">)</span> masks<span class="hl sym">)</span>
                <span class="hl sym">[]</span>
            <span class="hl sym">;</span>

        getTranslationMasks <span class="hl sym">:: [</span>Direction<span class="hl sym">] -&gt; [</span>Long<span class="hl sym">];</span>
        getTranslationMasks <span class="hl sym">!</span>piece <span class="hl sym">=</span>
            <span class="hl kwa">let</span>
                loop <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt; [</span>Long<span class="hl sym">] -&gt; [</span>Long<span class="hl sym">];</span>
                loop <span class="hl sym">!</span>x <span class="hl sym">!</span>y <span class="hl sym">!</span>masks <span class="hl sym">=</span>
                    <span class="hl kwa">if</span> x <span class="hl sym">&lt;</span> width <span class="hl kwa">then</span>
                        <span class="hl kwa">let</span>
                            coords <span class="hl sym">:: [(</span>Int<span class="hl sym">,</span> Int<span class="hl sym">)];</span>
                            coords <span class="hl sym">=</span> eager $ toCoords piece x y<span class="hl sym">;</span>

                            mask <span class="hl sym">::</span> Long<span class="hl sym">;</span>
                            mask <span class="hl sym">=</span> eager $ coordsToBits coords pieceNo<span class="hl sym">;</span>
                        <span class="hl kwa">in</span>
                            <span class="hl kwa">if</span>
                                fits coords
                                <span class="hl sym">&amp;&amp; (</span>Prelude<span class="hl sym">.</span>not $ hasSmallIslands mask<span class="hl sym">)</span>
                            <span class="hl kwa">then</span>
                                loop <span class="hl sym">(</span>x <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span> y <span class="hl sym">(</span>mask <span class="hl sym">:</span> masks<span class="hl sym">)</span>
                            <span class="hl kwa">else</span>
                                <span class="hl slc">//reject the piece</span>
                                loop <span class="hl sym">(</span>x <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span> y masks
                    <span class="hl kwa">else if</span> y <span class="hl sym">&lt;</span> heightp <span class="hl kwa">then</span>
                        loop <span class="hl num">0</span> <span class="hl sym">(</span>y <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span> masks
                    <span class="hl kwa">else</span>
                        masks
                    <span class="hl sym">;</span>
            <span class="hl kwa">in</span>
                loop <span class="hl num">0 0</span> <span class="hl sym">[]</span>
            <span class="hl sym">;</span>
    <span class="hl kwa">in</span>
        getRotationMasks piece <span class="hl num">5</span> <span class="hl sym">[]</span>
        <span class="hl sym">++</span> getRotationMasks <span class="hl sym">(</span>flipPiece piece<span class="hl sym">)</span> <span class="hl num">5</span> <span class="hl sym">[]</span>
    <span class="hl sym">;</span>

emptyBoard <span class="hl sym">::</span> Long<span class="hl sym">;</span>
emptyBoard <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">;</span>

main <span class="hl sym">:: [</span>String<span class="hl sym">] -&gt; ();</span>
<span class="hl kwa">public</span> main <span class="hl sym">!</span>args <span class="hl sym">=</span>
    <span class="hl kwa">let</span>
        n <span class="hl sym">::</span> Int<span class="hl sym">;</span>
        n <span class="hl sym">=</span> eager $ stringToInt <span class="hl sym">(</span>head args<span class="hl sym">);</span>
    <span class="hl kwa">in</span>
        meteor n
    <span class="hl sym">;</span>

