<span class="com">&quot;* The Computer Language Shootout</span>
<span class="com"> http://shootout.alioth.debian.org/</span>
<span class="com"> contributed by Isaac Gouy *&quot;</span>


<span class="sym">!</span> FileStream methodsFor<span class="sym">:</span> <span class="str">'accessing'</span><span class="sym">!</span>

readFasta<span class="sym">:</span> anId
   <span class="sym">|</span> idString newline buffer description line char <span class="sym">|</span>
   idString <span class="sym">:=</span> <span class="str">'&gt;'</span><span class="sym">,</span>anId<span class="sym">.</span>
   newline <span class="sym">:=</span> Character nl<span class="sym">.</span>

   <span class="com">&quot;* find start of particular fasta sequence *&quot;</span>
   <span class="sym">[(</span><span class="kwa">self</span> atEnd<span class="sym">)</span> or<span class="sym">: [</span>
         <span class="sym">(</span><span class="kwa">self</span> peek <span class="sym">= $&gt;)</span>
            ifTrue<span class="sym">: [(</span>line <span class="sym">:=</span> <span class="kwa">self</span> nextLine<span class="sym">)</span> startsWith<span class="sym">:</span> idString<span class="sym">]</span>
            ifFalse<span class="sym">: [</span><span class="kwa">self</span> skipTo<span class="sym">:</span> newline<span class="sym">.</span> <span class="kwa">false</span><span class="sym">]]</span>
      <span class="sym">]</span> whileFalse<span class="sym">.</span>

   <span class="com">&quot;* line-by-line read - it would be a lot faster to block read *&quot;</span>
   description <span class="sym">:=</span> line<span class="sym">.</span>
   buffer <span class="sym">:=</span> ByteStream on<span class="sym">: (</span>String new<span class="sym">:</span> <span class="num">1028</span><span class="sym">).</span>
   <span class="sym">[(</span><span class="kwa">self</span> atEnd<span class="sym">)</span> or<span class="sym">: [(</span>char <span class="sym">:=</span> <span class="kwa">self</span> peek<span class="sym">) = $&gt;]]</span> whileFalse<span class="sym">: [</span>
      <span class="sym">(</span>char <span class="sym">= $;)</span>
         ifTrue<span class="sym">: [</span><span class="kwa">self</span> nextLine<span class="sym">]</span>
         ifFalse<span class="sym">: [</span>buffer nextPutAll<span class="sym">:</span> <span class="kwa">self</span> nextLine<span class="sym">]</span>
      <span class="sym">].</span>

   <span class="sym">^</span>Association key<span class="sym">:</span> description value<span class="sym">:</span> buffer contents <span class="sym">!</span>


writeReverseComplementFasta<span class="sym">:</span> aString sequence<span class="sym">:</span> aSequence
   <span class="sym">|</span> lineLength n iub <span class="sym">|</span>
   <span class="sym">(</span>aString isNil<span class="sym">)</span> ifTrue<span class="sym">: [^</span><span class="kwa">self</span><span class="sym">].</span>

   lineLength <span class="sym">:=</span> <span class="num">60</span><span class="sym">.</span> n <span class="sym">:=</span> aSequence size<span class="sym">.</span>

   iub <span class="sym">:=</span> String new<span class="sym">:</span> <span class="num">128</span> withAll<span class="sym">: $*.</span>
   iub at<span class="sym">: $</span>a value put<span class="sym">: $</span>T<span class="sym">.</span> iub at<span class="sym">: $</span>A value put<span class="sym">: $</span>T<span class="sym">.</span>
   iub at<span class="sym">: $</span>b value put<span class="sym">: $</span>V<span class="sym">.</span> iub at<span class="sym">: $</span>B value put<span class="sym">: $</span>V<span class="sym">.</span>
   iub at<span class="sym">: $</span>c value put<span class="sym">: $</span>G<span class="sym">.</span> iub at<span class="sym">: $</span>C value put<span class="sym">: $</span>G<span class="sym">.</span>
   iub at<span class="sym">: $</span>d value put<span class="sym">: $</span>H<span class="sym">.</span> iub at<span class="sym">: $</span>D value put<span class="sym">: $</span>H<span class="sym">.</span>
   iub at<span class="sym">: $</span>g value put<span class="sym">: $</span>C<span class="sym">.</span> iub at<span class="sym">: $</span>G value put<span class="sym">: $</span>C<span class="sym">.</span>
   iub at<span class="sym">: $</span>h value put<span class="sym">: $</span>D<span class="sym">.</span> iub at<span class="sym">: $</span>H value put<span class="sym">: $</span>D<span class="sym">.</span>
   iub at<span class="sym">: $</span>k value put<span class="sym">: $</span>M<span class="sym">.</span> iub at<span class="sym">: $</span>K value put<span class="sym">: $</span>M<span class="sym">.</span>
   iub at<span class="sym">: $</span>m value put<span class="sym">: $</span>K<span class="sym">.</span> iub at<span class="sym">: $</span>M value put<span class="sym">: $</span>K<span class="sym">.</span>
   iub at<span class="sym">: $</span>n value put<span class="sym">: $</span>N<span class="sym">.</span> iub at<span class="sym">: $</span>N value put<span class="sym">: $</span>N<span class="sym">.</span>
   iub at<span class="sym">: $</span>r value put<span class="sym">: $</span>Y<span class="sym">.</span> iub at<span class="sym">: $</span>R value put<span class="sym">: $</span>Y<span class="sym">.</span>
   iub at<span class="sym">: $</span>s value put<span class="sym">: $</span>S<span class="sym">.</span> iub at<span class="sym">: $</span>S value put<span class="sym">: $</span>S<span class="sym">.</span>
   iub at<span class="sym">: $</span>t value put<span class="sym">: $</span>A<span class="sym">.</span> iub at<span class="sym">: $</span>T value put<span class="sym">: $</span>A<span class="sym">.</span>
   iub at<span class="sym">: $</span>v value put<span class="sym">: $</span>B<span class="sym">.</span> iub at<span class="sym">: $</span>V value put<span class="sym">: $</span>B<span class="sym">.</span>
   iub at<span class="sym">: $</span>w value put<span class="sym">: $</span>W<span class="sym">.</span> iub at<span class="sym">: $</span>W value put<span class="sym">: $</span>W<span class="sym">.</span>
   iub at<span class="sym">: $</span>y value put<span class="sym">: $</span>R<span class="sym">.</span> iub at<span class="sym">: $</span>Y value put<span class="sym">: $</span>R<span class="sym">.</span>

   <span class="kwa">self</span> nextPutAll<span class="sym">:</span> aString<span class="sym">;</span> nl<span class="sym">.</span>

   <span class="sym">[</span>n <span class="sym">&gt;</span> <span class="num">0</span><span class="sym">]</span> whileTrue<span class="sym">: [</span>
         <span class="num">1</span> to<span class="sym">: ((</span>n <span class="sym">&lt;</span> lineLength<span class="sym">)</span> ifTrue<span class="sym">: [</span>n<span class="sym">]</span> ifFalse<span class="sym">: [</span>lineLength<span class="sym">])</span> do<span class="sym">:</span>
            <span class="sym">[:</span>i <span class="sym">|</span> <span class="kwa">self</span> nextPut<span class="sym">: (</span>iub at<span class="sym">: (</span>aSequence at<span class="sym">:</span> n <span class="sym">-</span> i <span class="sym">+</span> <span class="num">1</span><span class="sym">)</span> value<span class="sym">)].</span>
         <span class="kwa">self</span> nl<span class="sym">.</span>
         n <span class="sym">:=</span> n <span class="sym">-</span> lineLength<span class="sym">.</span>
      <span class="sym">] ! !</span>


<span class="sym">|</span> in out fasta <span class="sym">|</span>
in <span class="sym">:=</span> FileStream stdin bufferSize<span class="sym">:</span> <span class="num">4096</span><span class="sym">.</span>
out <span class="sym">:=</span> FileStream stdout bufferSize<span class="sym">:</span> <span class="num">4096</span><span class="sym">.</span>

fasta <span class="sym">:=</span> in readFasta<span class="sym">:</span> <span class="str">'ONE'</span><span class="sym">.</span>
out writeReverseComplementFasta<span class="sym">:</span> fasta key sequence<span class="sym">:</span> fasta value<span class="sym">.</span>

fasta <span class="sym">:=</span> in readFasta<span class="sym">:</span> <span class="str">'TWO'</span><span class="sym">.</span>
out writeReverseComplementFasta<span class="sym">:</span> fasta key sequence<span class="sym">:</span> fasta value<span class="sym">.</span>

fasta <span class="sym">:=</span> in readFasta<span class="sym">:</span> <span class="str">'THREE'</span><span class="sym">.</span>
out writeReverseComplementFasta<span class="sym">:</span> fasta key sequence<span class="sym">:</span> fasta value<span class="sym">.</span>

in close<span class="sym">.</span> out close <span class="sym">!</span>
