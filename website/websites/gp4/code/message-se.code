<span class="hl slc">-- The Computer Language Shootout</span>
<span class="hl slc">-- http://shootout.alioth.debian.org/</span>
<span class="hl slc">-- contributed by  Cyril Adrian</span>

<span class="hl slc">-- SPLITFILE=linked_job.e</span>
<span class="hl kwa">class</span> LINKED_JOB

<span class="hl kwa">inherit</span>
   BACKGROUND_JOB
      <span class="hl kwa">redefine</span>
         is_ready
      <span class="hl kwa">end</span>

<span class="hl kwa">create</span> <span class="hl sym">{</span>ANY<span class="hl sym">}</span>
   link_to<span class="hl sym">,</span> make

<span class="hl kwa">feature</span> <span class="hl sym">{</span>ANY<span class="hl sym">}</span>
   <span class="hl kwd">message</span> <span class="hl sym">(</span>i<span class="hl sym">:</span> <span class="hl kwb">INTEGER</span><span class="hl sym">)</span> <span class="hl kwa">is</span>
      <span class="hl kwa">do</span>
         messages.<span class="hl kwd">add</span><span class="hl sym">(</span>i<span class="hl sym">)</span>
      <span class="hl kwa">end</span>

<span class="hl kwa">feature</span> <span class="hl sym">{</span>LOOP_ITEM<span class="hl sym">}</span>
   continue <span class="hl kwa">is</span>
      <span class="hl kwa">do</span>
         <span class="hl kwa">if</span> id <span class="hl sym">/=</span> <span class="hl num">0</span> <span class="hl kwa">then</span>
            next.<span class="hl kwd">message</span><span class="hl sym">(</span>messages.first <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
         <span class="hl kwa">else</span>
            <span class="hl kwa">if</span> sum <span class="hl sym">&gt;=</span> max <span class="hl kwa">then</span>
               stop.<span class="hl kwd">call</span><span class="hl sym">([</span>sum<span class="hl sym">])</span>
            <span class="hl kwa">else</span>
               sum <span class="hl sym">:=</span> sum <span class="hl sym">+ (</span>messages.first<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)</span>
            <span class="hl kwa">end</span>
         <span class="hl kwa">end</span>
         messages.remove
      <span class="hl kwa">end</span>

   <span class="hl kwd">is_ready</span> <span class="hl sym">(</span>ready<span class="hl sym">:</span> READY_DESCRIPTION<span class="hl sym">):</span> <span class="hl kwb">BOOLEAN</span> <span class="hl kwa">is</span>
      <span class="hl kwa">do</span>
         <span class="hl kwa">Result</span> <span class="hl sym">:=</span> <span class="hl kwa">not</span> messages.is_empty
         <span class="hl kwa">if</span> id <span class="hl sym">=</span> <span class="hl num">0</span> <span class="hl kwa">then</span>
            <span class="hl kwa">Result</span> <span class="hl sym">:=</span> <span class="hl kwa">Result or else</span> sum <span class="hl sym">&gt;=</span> max
         <span class="hl kwa">end</span>
      <span class="hl kwa">end</span>

   done<span class="hl sym">:</span> <span class="hl kwb">BOOLEAN</span> <span class="hl kwa">is</span>
      <span class="hl kwa">do</span>
         <span class="hl kwa">Result</span> <span class="hl sym">:=</span> <span class="hl kwa">False</span>
      <span class="hl kwa">end</span>

   restart <span class="hl kwa">is</span>
      <span class="hl kwa">do</span>
      <span class="hl kwa">end</span>

<span class="hl kwa">feature</span> <span class="hl sym">{}</span>
   id<span class="hl sym">:</span> <span class="hl kwb">INTEGER</span>
   next<span class="hl sym">:</span> <span class="hl kwa">like Current</span>
   messages<span class="hl sym">:</span> QUEUE<span class="hl sym">[</span><span class="hl kwb">INTEGER</span><span class="hl sym">]</span>
   sum<span class="hl sym">:</span> <span class="hl kwb">INTEGER</span>
   max<span class="hl sym">:</span> <span class="hl kwb">INTEGER</span>
   stop<span class="hl sym">:</span> PROCEDURE<span class="hl sym">[</span><span class="hl kwa">TUPLE</span><span class="hl sym">[</span><span class="hl kwb">INTEGER</span><span class="hl sym">]]</span>

   <span class="hl kwd">link_to</span> <span class="hl sym">(</span>a_id<span class="hl sym">:</span> <span class="hl kwa">like</span> id<span class="hl sym">;</span> a_next<span class="hl sym">:</span> <span class="hl kwa">like</span> next<span class="hl sym">)</span> <span class="hl kwa">is</span>
      <span class="hl kwa">require</span>
         a_id <span class="hl sym">&gt;</span> <span class="hl num">0</span>
         a_next <span class="hl sym">/=</span> Void
      <span class="hl kwa">do</span>
         id <span class="hl sym">:=</span> a_id
         next <span class="hl sym">:=</span> a_next
         <span class="hl kwa">create</span> messages.make
      <span class="hl kwa">end</span>

   <span class="hl kwd">make</span> <span class="hl sym">(</span>a_max<span class="hl sym">:</span> <span class="hl kwa">like</span> max<span class="hl sym">;</span> a_stop<span class="hl sym">:</span> <span class="hl kwa">like</span> stop<span class="hl sym">)</span> <span class="hl kwa">is</span>
      <span class="hl kwa">do</span>
         <span class="hl kwa">create</span> messages.make
         max <span class="hl sym">:=</span> a_max
         stop <span class="hl sym">:=</span> a_stop
      <span class="hl kwa">end</span>

<span class="hl kwa">end</span>
<span class="hl slc">-- SPLITFILE=message.e</span>
<span class="hl kwa">class</span> MESSAGE

<span class="hl kwa">inherit</span>
   BACKGROUND_JOB

insert
   ARGUMENTS

<span class="hl kwa">create</span> <span class="hl sym">{</span>ANY<span class="hl sym">}</span>
   make

<span class="hl kwa">feature</span> <span class="hl sym">{}</span>
   Jobs_count<span class="hl sym">:</span> <span class="hl kwb">INTEGER</span> <span class="hl kwa">is</span> <span class="hl num">500</span>
   messages_count<span class="hl sym">,</span> counter<span class="hl sym">:</span> <span class="hl kwb">INTEGER</span>
   job<span class="hl sym">:</span> LINKED_JOB
   stack<span class="hl sym">:</span> LOOP_STACK

   make <span class="hl kwa">is</span>
      <span class="hl kwa">local</span>
         i<span class="hl sym">:</span> <span class="hl kwb">INTEGER</span>
      <span class="hl kwa">do</span>
         <span class="hl kwa">create</span> stack.make
         stack.<span class="hl kwd">add_job</span><span class="hl sym">(</span><span class="hl kwa">Current</span><span class="hl sym">)</span>
         messages_count <span class="hl sym">:=</span> <span class="hl kwd">argument</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">)</span>.to_integer
         <span class="hl kwa">from</span>
            <span class="hl kwa">create</span> job.<span class="hl kwd">make</span><span class="hl sym">(</span>messages_count <span class="hl sym">*</span> Jobs_count<span class="hl sym">,</span> <span class="hl kwa">agent</span> stop<span class="hl sym">)</span>
            stack.<span class="hl kwd">add_job</span><span class="hl sym">(</span>job<span class="hl sym">)</span>
            i <span class="hl sym">:=</span> <span class="hl num">1</span>
         until
            i <span class="hl sym">=</span> Jobs_count
         <span class="hl kwa">loop</span>
            <span class="hl kwa">create</span> job.<span class="hl kwd">link_to</span><span class="hl sym">(</span>i<span class="hl sym">,</span> job<span class="hl sym">)</span>
            stack.<span class="hl kwd">add_job</span><span class="hl sym">(</span>job<span class="hl sym">)</span>
            i <span class="hl sym">:=</span> i <span class="hl sym">+</span> <span class="hl num">1</span>
         <span class="hl kwa">end</span>
         stack.run
      <span class="hl kwa">end</span>

   <span class="hl kwd">stop</span> <span class="hl sym">(</span>sum<span class="hl sym">:</span> <span class="hl kwb">INTEGER</span><span class="hl sym">)</span> <span class="hl kwa">is</span>
      <span class="hl kwa">do</span>
         <span class="hl kwd">print</span><span class="hl sym">(</span>sum.out <span class="hl sym">+</span> <span class="hl str">&quot;%N&quot;</span><span class="hl sym">)</span>
         stack.break
      <span class="hl kwa">end</span>

<span class="hl kwa">feature</span> <span class="hl sym">{</span>LOOP_ITEM<span class="hl sym">}</span>
   continue <span class="hl kwa">is</span>
      <span class="hl kwa">do</span>
         job.<span class="hl kwd">message</span><span class="hl sym">(</span><span class="hl num">0</span><span class="hl sym">)</span>
         counter <span class="hl sym">:=</span> counter <span class="hl sym">+</span> <span class="hl num">1</span>
      <span class="hl kwa">end</span>

   done<span class="hl sym">:</span> <span class="hl kwb">BOOLEAN</span> <span class="hl kwa">is</span>
      <span class="hl kwa">do</span>
         <span class="hl kwa">Result</span> <span class="hl sym">:=</span> counter <span class="hl sym">=</span> messages_count
      <span class="hl kwa">end</span>

   restart <span class="hl kwa">is</span>
      <span class="hl kwa">do</span>
      <span class="hl kwa">end</span>

<span class="hl kwa">end</span>
