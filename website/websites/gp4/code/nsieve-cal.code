<span class="hl com">/**</span>
<span class="hl com"> * The Computer Language Benchmarks Game</span>
<span class="hl com"> * Based on the CAL Open Quark version</span>
<span class="hl com"> * Contributed by Magnus Byne.</span>
<span class="hl com"> */</span>
module Nsieve<span class="hl sym">;</span>

<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Core<span class="hl sym">.</span>Prelude using
    typeClass <span class="hl sym">=</span> Inputable<span class="hl sym">,</span> Outputable<span class="hl sym">;</span>
    typeConstructor <span class="hl sym">=</span> <span class="hl kwc">Boolean</span><span class="hl sym">,</span> Int<span class="hl sym">,</span> <span class="hl kwc">String</span><span class="hl sym">;</span>
    dataConstructor <span class="hl sym">=</span> False<span class="hl sym">,</span> True<span class="hl sym">;</span>
    function <span class="hl sym">=</span> eager<span class="hl sym">,</span> seq<span class="hl sym">,</span> stringToInt<span class="hl sym">;</span>
    <span class="hl sym">;</span>

<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Core<span class="hl sym">.</span><span class="hl kwc">String</span> using
    function <span class="hl sym">=</span> replicate<span class="hl sym">;</span>
    <span class="hl sym">;</span>

<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Core<span class="hl sym">.</span>Bits using
    function <span class="hl sym">=</span> shiftL<span class="hl sym">,</span> shiftR<span class="hl sym">;</span>
    <span class="hl sym">;</span>

<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Core<span class="hl sym">.</span>Debug<span class="hl sym">;</span>

<span class="hl kwa">import</span> Cal<span class="hl sym">.</span><span class="hl kwc">Collections</span><span class="hl sym">.</span><span class="hl kwc">List</span> using
    function <span class="hl sym">=</span> head<span class="hl sym">;</span>
    <span class="hl sym">;</span>


data foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;boolean[]&quot;</span>
    JBooleanArray deriving Inputable<span class="hl sym">,</span> Outputable<span class="hl sym">;</span>

foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;newArray&quot;</span> booleanArray_new <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> JBooleanArray<span class="hl sym">;</span>

foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;subscriptArray&quot;</span>
    get <span class="hl sym">::</span> JBooleanArray <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> <span class="hl kwc">Boolean</span><span class="hl sym">;</span>

foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;updateArray&quot;</span>
    set <span class="hl sym">::</span> JBooleanArray <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> <span class="hl kwc">Boolean</span> <span class="hl sym">-&gt;</span> <span class="hl kwc">Boolean</span><span class="hl sym">;</span>

data foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;java.io.PrintStream&quot;</span> <span class="hl kwa">private</span> JPrintStream<span class="hl sym">;</span>

foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;static field java.lang.System.out&quot;</span>
    <span class="hl kwa">private</span> stdout <span class="hl sym">::</span> JPrintStream<span class="hl sym">;</span>

foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;method println&quot;</span>
    <span class="hl kwa">private</span> printLn <span class="hl sym">::</span> JPrintStream <span class="hl sym">-&gt;</span> <span class="hl kwc">String</span> <span class="hl sym">-&gt; ();</span>

<span class="hl com">/**pad width number returns number padded to width with spaces*/</span>
pad <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> <span class="hl kwc">String</span><span class="hl sym">;</span>
pad <span class="hl sym">!</span>width <span class="hl sym">!</span>number <span class="hl sym">=</span>
    let
        str <span class="hl sym">=</span> Debug<span class="hl sym">.</span>show number<span class="hl sym">;</span>
    in
        <span class="hl kwd">replicate</span> <span class="hl sym">(</span>width <span class="hl sym">-</span> <span class="hl kwc">String</span><span class="hl sym">.</span>length str<span class="hl sym">)</span> <span class="hl str">' '</span> <span class="hl sym">++</span> str
    <span class="hl sym">;</span>

<span class="hl com">/**this is used to initialise the values in the array to true*/</span>
setAll <span class="hl sym">!</span>start <span class="hl sym">!</span>end <span class="hl sym">!</span>array <span class="hl sym">=</span>
    <span class="hl kwa">if</span> start <span class="hl sym">==</span> end then
        array
    <span class="hl kwa">else</span>
        set array start True
        `seq`
        <span class="hl kwd">setAll</span> <span class="hl sym">(</span>start <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span> end array
    <span class="hl sym">;</span>

<span class="hl com">/** Count primes using nseive method*/</span>
nsieve <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> JBooleanArray <span class="hl sym">-&gt;</span> Int<span class="hl sym">;</span>
nsieve <span class="hl sym">!</span>n <span class="hl sym">!</span>isPrime <span class="hl sym">=</span>
    let
        nsieve_helper <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> Int<span class="hl sym">;</span>
        nsieve_helper <span class="hl sym">!</span>i <span class="hl sym">!</span>numPrimesFound <span class="hl sym">=</span>
            <span class="hl kwa">if</span> i <span class="hl sym">==</span> n then
                numPrimesFound
            <span class="hl kwa">else if</span> get isPrime i then
                let
                    update <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt; ();</span>
                    update <span class="hl sym">!</span>k <span class="hl sym">!</span>i <span class="hl sym">!</span>n <span class="hl sym">=</span>
                        <span class="hl kwa">if</span> k <span class="hl sym">&gt;</span> n then
                            <span class="hl sym">()</span>
                        <span class="hl kwa">else</span>
                            set isPrime k False
                            `seq`
                            <span class="hl kwd">update</span> <span class="hl sym">(</span>k <span class="hl sym">+</span> i<span class="hl sym">)</span> i n
                        <span class="hl sym">;</span>
                in
                    <span class="hl kwd">update</span> <span class="hl sym">(</span>i <span class="hl sym">+</span> i<span class="hl sym">)</span> i n
                    `seq`
                    <span class="hl kwd">nsieve_helper</span> <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">) (</span>numPrimesFound <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
            <span class="hl kwa">else</span>
                <span class="hl kwd">nsieve_helper</span> <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span> numPrimesFound
            <span class="hl sym">;</span>
    in
        setAll <span class="hl kwd">0</span> <span class="hl sym">(</span>n <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span> isPrime
        `seq`
        nsieve_helper <span class="hl num">2 0</span>
    <span class="hl sym">;</span>

main <span class="hl sym">:: [</span><span class="hl kwc">String</span><span class="hl sym">] -&gt; ();</span>
<span class="hl kwa">public</span> main <span class="hl sym">!</span>args <span class="hl sym">=</span>
    let
        n <span class="hl sym">=</span> eager $ <span class="hl kwd">stringToInt</span> <span class="hl sym">(</span>head args<span class="hl sym">);</span>
        showResult n <span class="hl sym">=</span>
            printLn
                stdout
                <span class="hl sym">(</span>
                    <span class="hl str">&quot;Primes up to &quot;</span>
                    <span class="hl sym">++</span> pad <span class="hl num">8</span> n
                    <span class="hl sym">++</span> <span class="hl str">&quot; &quot;</span>
                    <span class="hl sym">++</span> pad <span class="hl kwd">8</span> <span class="hl sym">(</span>nsieve n flags<span class="hl sym">)</span>
                <span class="hl sym">)</span>
            <span class="hl sym">;</span>
        m <span class="hl sym">=</span> shiftL <span class="hl num">1</span> n <span class="hl sym">*</span> <span class="hl num">10000</span><span class="hl sym">;</span>
        flags <span class="hl sym">=</span> <span class="hl kwd">booleanArray_new</span> <span class="hl sym">(</span>m <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">);</span>
    in
        showResult m
        `seq`
        <span class="hl kwd">showResult</span> <span class="hl sym">(</span>shiftR m <span class="hl num">1</span><span class="hl sym">)</span>
        `seq`
        <span class="hl kwd">showResult</span> <span class="hl sym">(</span>shiftR m <span class="hl num">2</span><span class="hl sym">)</span>
    <span class="hl sym">;</span>

