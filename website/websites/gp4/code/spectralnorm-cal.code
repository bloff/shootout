<span class="hl com">/**</span>
<span class="hl com"> * The Computer Language Benchmarks Game</span>
<span class="hl com"> * Based on the CAL Open Quark version</span>
<span class="hl com"> * Contributed by Magnus Byne.</span>
<span class="hl com"> */</span>
module Spectralnorm<span class="hl sym">;</span>

<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Core<span class="hl sym">.</span>Prelude using
    typeClass <span class="hl sym">=</span> Inputable<span class="hl sym">,</span> Outputable<span class="hl sym">;</span>
    typeConstructor <span class="hl sym">=</span> <span class="hl kwc">Boolean</span><span class="hl sym">,</span> Int<span class="hl sym">,</span> <span class="hl kwc">String</span><span class="hl sym">,</span> <span class="hl kwc">Double</span><span class="hl sym">;</span>
    dataConstructor <span class="hl sym">=</span> False<span class="hl sym">,</span> True<span class="hl sym">;</span>
    function <span class="hl sym">=</span> seq<span class="hl sym">,</span> fromInt<span class="hl sym">,</span> eager<span class="hl sym">,</span> stringToInt<span class="hl sym">;</span>
    <span class="hl sym">;</span>
<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Core<span class="hl sym">.</span>Bits using
    function <span class="hl sym">=</span> shiftL<span class="hl sym">;</span>
    <span class="hl sym">;</span>
<span class="hl kwa">import</span> Cal<span class="hl sym">.</span>Core<span class="hl sym">.</span>Debug using
    function <span class="hl sym">=</span> show<span class="hl sym">;</span>
    <span class="hl sym">;</span>
<span class="hl kwa">import</span> Cal<span class="hl sym">.</span><span class="hl kwc">Utilities</span><span class="hl sym">.</span><span class="hl kwc">Math</span> using
    function <span class="hl sym">=</span> sqrt<span class="hl sym">;</span>
    <span class="hl sym">;</span>
<span class="hl kwa">import</span> Cal<span class="hl sym">.</span><span class="hl kwc">Collections</span><span class="hl sym">.</span><span class="hl kwc">List</span> using
    function <span class="hl sym">=</span> head<span class="hl sym">;</span>
    <span class="hl sym">;</span>
<span class="hl kwa">import</span> Cal<span class="hl sym">.</span><span class="hl kwc">Utilities</span><span class="hl sym">.</span><span class="hl kwc">MessageFormat</span> using
    function <span class="hl sym">=</span> formatWithPattern<span class="hl sym">;</span>
    <span class="hl sym">;</span>
<span class="hl kwa">import</span> Cal<span class="hl sym">.</span><span class="hl kwc">Utilities</span><span class="hl sym">.</span><span class="hl kwc">Locale</span> using
    function <span class="hl sym">=</span> invariantLocale<span class="hl sym">;</span>
    <span class="hl sym">;</span>

data foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;double[]&quot;</span> JVector deriving Inputable<span class="hl sym">,</span> Outputable<span class="hl sym">;</span>

foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;newArray&quot;</span> newVector <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> JVector<span class="hl sym">;</span>

foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;subscriptArray&quot;</span> subscript <span class="hl sym">::</span> JVector <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> <span class="hl kwc">Double</span><span class="hl sym">;</span>

foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;updateArray&quot;</span>
    update <span class="hl sym">::</span> JVector <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> <span class="hl kwc">Double</span> <span class="hl sym">-&gt;</span> <span class="hl kwc">Double</span><span class="hl sym">;</span>

data foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;java.io.PrintStream&quot;</span> <span class="hl kwa">private</span> JPrintStream<span class="hl sym">;</span>

foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;static field java.lang.System.out&quot;</span>
    <span class="hl kwa">private</span> stdout <span class="hl sym">::</span> JPrintStream<span class="hl sym">;</span>

foreign unsafe <span class="hl kwa">import</span> jvm <span class="hl str">&quot;method println&quot;</span>
    <span class="hl kwa">private</span> printLn <span class="hl sym">::</span> JPrintStream <span class="hl sym">-&gt;</span> <span class="hl kwc">String</span> <span class="hl sym">-&gt; ();</span>

<span class="hl com">/** get element i,j of infinite matrix A*/</span>
matrixA <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> <span class="hl kwc">Double</span><span class="hl sym">;</span>
matrixA <span class="hl sym">!</span>i <span class="hl sym">!</span>j <span class="hl sym">=</span> <span class="hl num">1.0</span> <span class="hl sym">/</span> <span class="hl kwd">fromInt</span> <span class="hl sym">((</span>i <span class="hl sym">+</span> j<span class="hl sym">) * (</span>i <span class="hl sym">+</span> j <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">) /</span> <span class="hl num">2</span> <span class="hl sym">+</span> i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">);</span>

<span class="hl com">/** multiply A by v*/</span>
multiplyAv <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> JVector <span class="hl sym">-&gt;</span> JVector <span class="hl sym">-&gt; ();</span>
multiplyAv <span class="hl sym">!</span>n <span class="hl sym">!</span>v <span class="hl sym">!</span>av <span class="hl sym">=</span>
    let
        go <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt; ();</span>
        go <span class="hl sym">!</span>i <span class="hl sym">!</span>j <span class="hl sym">=</span>
            <span class="hl kwa">if</span> j <span class="hl sym">&lt;</span> n then
                update
                    av
                    i
                    <span class="hl sym">(</span>av `subscript` i <span class="hl sym">+</span> matrixA i j <span class="hl sym">*</span> v `subscript` j<span class="hl sym">)</span>
                `seq`
                go <span class="hl kwd">i</span> <span class="hl sym">(</span>j <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
            <span class="hl kwa">else</span>
                let
                    inc <span class="hl sym">::</span> Int<span class="hl sym">;</span>
                    inc <span class="hl sym">=</span> i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">;</span>
                in
                    <span class="hl kwa">if</span> inc <span class="hl sym">&lt;</span> n then
                        update av inc <span class="hl num">0.0</span>
                        `seq`
                        go inc <span class="hl num">0</span>
                    <span class="hl kwa">else</span>
                        <span class="hl sym">()</span>
            <span class="hl sym">;</span>
    in
        <span class="hl kwd">go</span> <span class="hl sym">(-</span><span class="hl num">1</span><span class="hl sym">)</span> n
    <span class="hl sym">;</span>

<span class="hl com">/** multiply (Transpose A) by v*/</span>
multiplyAtv <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> JVector <span class="hl sym">-&gt;</span> JVector <span class="hl sym">-&gt; ();</span>
multiplyAtv <span class="hl sym">!</span>n <span class="hl sym">!</span>v <span class="hl sym">!</span>av <span class="hl sym">=</span>
    let
        go <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt; ();</span>
        go <span class="hl sym">!</span>i <span class="hl sym">!</span>j <span class="hl sym">=</span>
            <span class="hl kwa">if</span> j <span class="hl sym">&lt;</span> n then
                update
                    av
                    i
                    <span class="hl sym">(</span>av `subscript` i <span class="hl sym">+</span> matrixA j i <span class="hl sym">*</span> v `subscript` j<span class="hl sym">)</span>
                `seq`
                go <span class="hl kwd">i</span> <span class="hl sym">(</span>j <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span>
            <span class="hl kwa">else</span>
                let
                    inc <span class="hl sym">::</span> Int<span class="hl sym">;</span>
                    inc <span class="hl sym">=</span> i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">;</span>
                in
                    <span class="hl kwa">if</span> inc <span class="hl sym">&lt;</span> n then
                        update av inc <span class="hl num">0.0</span>
                        `seq`
                        go inc <span class="hl num">0</span>
                    <span class="hl kwa">else</span>
                        <span class="hl sym">()</span>
            <span class="hl sym">;</span>
    in
        <span class="hl kwd">go</span> <span class="hl sym">(-</span><span class="hl num">1</span><span class="hl sym">)</span> n
    <span class="hl sym">;</span>

<span class="hl com">/**(transpose A) * A * v*/</span>
multiplyAtAv <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> JVector <span class="hl sym">-&gt;</span> JVector <span class="hl sym">-&gt;</span> JVector <span class="hl sym">-&gt; ();</span>
multiplyAtAv <span class="hl sym">!</span>n <span class="hl sym">!</span>temp <span class="hl sym">!</span>v <span class="hl sym">!</span>result <span class="hl sym">=</span>
    multiplyAv n v temp
    `seq`
    multiplyAtv n temp result
    <span class="hl sym">;</span>

<span class="hl com">/**run n steps of the approximation*/</span>
approximate <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> <span class="hl kwc">Double</span><span class="hl sym">;</span>
approximate <span class="hl sym">!</span>n <span class="hl sym">=</span>
    let
        u <span class="hl sym">::</span> JVector<span class="hl sym">;</span>
        u <span class="hl sym">=</span> eager $ newVector n<span class="hl sym">;</span>

        v <span class="hl sym">::</span> JVector<span class="hl sym">;</span>
        v <span class="hl sym">=</span> eager $ newVector n<span class="hl sym">;</span>

        temp <span class="hl sym">::</span> JVector<span class="hl sym">;</span>
        temp <span class="hl sym">=</span> eager $ newVector n<span class="hl sym">;</span>

        doStep <span class="hl sym">::</span> Int <span class="hl sym">-&gt; ();</span>
        doStep <span class="hl sym">!</span>i <span class="hl sym">=</span>
            <span class="hl kwa">if</span> i <span class="hl sym">==</span> <span class="hl num">0</span> then
                <span class="hl sym">()</span>
            <span class="hl kwa">else</span>
                multiplyAtAv n temp u v
                `seq`
                multiplyAtAv n temp v u
                `seq`
                <span class="hl kwd">doStep</span> <span class="hl sym">(</span>i <span class="hl sym">-</span> <span class="hl num">1</span><span class="hl sym">)</span>
            <span class="hl sym">;</span>

        vbv <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> <span class="hl kwc">Double</span> <span class="hl sym">-&gt;</span> <span class="hl kwc">Double</span><span class="hl sym">;</span>
        vbv <span class="hl sym">!</span>i <span class="hl sym">!</span>sum <span class="hl sym">=</span>
            <span class="hl kwa">if</span> i <span class="hl sym">==</span> n then
                sum
            <span class="hl kwa">else</span>
                <span class="hl kwd">vbv</span> <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">) (</span>sum <span class="hl sym">+</span> u `subscript` i <span class="hl sym">*</span> v `subscript` i<span class="hl sym">)</span>
            <span class="hl sym">;</span>

        vv <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> <span class="hl kwc">Double</span> <span class="hl sym">-&gt;</span> <span class="hl kwc">Double</span><span class="hl sym">;</span>
        vv <span class="hl sym">!</span>i <span class="hl sym">!</span>sum <span class="hl sym">=</span>
            <span class="hl kwa">if</span> i <span class="hl sym">==</span> n then
                sum
            <span class="hl kwa">else</span>
                <span class="hl kwd">vv</span> <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">) (</span>sum <span class="hl sym">+</span> v `subscript` i <span class="hl sym">*</span> v `subscript` i<span class="hl sym">)</span>
            <span class="hl sym">;</span>

        initVector <span class="hl sym">::</span> Int <span class="hl sym">-&gt;</span> Int <span class="hl sym">-&gt;</span> JVector <span class="hl sym">-&gt; ();</span>
        initVector <span class="hl sym">!</span>i <span class="hl sym">!</span>size <span class="hl sym">!</span>v <span class="hl sym">=</span>
            <span class="hl kwa">if</span> i <span class="hl sym">==</span> size then
                <span class="hl sym">()</span>
            <span class="hl kwa">else</span>
                update v i <span class="hl num">1.0</span>
                `seq`
                <span class="hl kwd">initVector</span> <span class="hl sym">(</span>i <span class="hl sym">+</span> <span class="hl num">1</span><span class="hl sym">)</span> size v
            <span class="hl sym">;</span>
    in

        initVector <span class="hl num">0</span> n u
        `seq`
        doStep <span class="hl num">10</span>
        `seq`
        <span class="hl kwd">sqrt</span> <span class="hl sym">(</span>vbv <span class="hl num">0 0.0</span> <span class="hl sym">/</span> vv <span class="hl num">0 0.0</span><span class="hl sym">)</span>
    <span class="hl sym">;</span>

main <span class="hl sym">:: [</span><span class="hl kwc">String</span><span class="hl sym">] -&gt; ();</span>
<span class="hl kwa">public</span> main <span class="hl sym">!</span>args <span class="hl sym">=</span>
    let
        n <span class="hl sym">::</span> Int<span class="hl sym">;</span>
        n <span class="hl sym">=</span> eager $ <span class="hl kwd">stringToInt</span> <span class="hl sym">(</span>head args<span class="hl sym">);</span>
    in
        printLn
            stdout
            <span class="hl sym">(</span>formatWithPattern
                <span class="hl str">&quot;{0,number,#.000000000}&quot;</span>
                invariantLocale
                <span class="hl sym">{</span>#<span class="hl num">1</span> <span class="hl sym">=</span> approximate n<span class="hl sym">}</span>
            <span class="hl sym">)</span>
    <span class="hl sym">;</span>

