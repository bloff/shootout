<span class="slc">-- $Id: nsieve-ghc.code,v 1.16 2005-11-05 21:54:16 igouy-guest Exp $</span>
<span class="slc">-- written by Einar Karttunen</span>

<span class="kwa">import</span> Data.Array.IO
<span class="kwa">import</span> Data.Array.Base
<span class="kwa">import</span> Data.Bits <span class="sym">(</span>shiftL<span class="sym">)</span>
<span class="kwa">import</span> System <span class="sym">(</span>getArgs<span class="sym">)</span>

loop <span class="sym">::</span> IOUArray <span class="kwb">Int Bool</span> <span class="sym">-&gt;</span> <span class="kwb">Int</span> <span class="sym">-&gt;</span> <span class="kwb">Int</span> <span class="sym">-&gt;</span> <span class="kwb">Int</span> <span class="sym">-&gt;</span> IO <span class="kwb">Int</span>
loop arr m n c <span class="sym">|</span> n <span class="sym">==</span> m    <span class="sym">=</span> return c
               <span class="sym">|</span> otherwise <span class="sym">=</span> <span class="kwa">do</span> el <span class="sym">&lt;-</span> unsafeRead arr n
                                if el <span class="kwa">then do</span> mapM_ <span class="sym">(</span>\i <span class="sym">-&gt;</span> unsafeWrite arr i <span class="kwa">False</span><span class="sym">) (</span>tail <span class="sym">[</span>n<span class="sym">,</span>n<span class="sym">+</span>n..m<span class="sym">])</span>
                                              loop arr m <span class="sym">(</span>n<span class="sym">+</span><span class="num">1</span><span class="sym">)</span> $<span class="sym">!</span> c<span class="sym">+</span><span class="num">1</span>
                                      <span class="kwa">else do</span> loop arr m <span class="sym">(</span>n<span class="sym">+</span><span class="num">1</span><span class="sym">)</span> c

fmt width i <span class="sym">=</span> <span class="kwa">let</span> is <span class="sym">=</span> show i <span class="kwa">in</span> <span class="sym">(</span>take <span class="sym">(</span>width <span class="sym">-</span> length is<span class="sym">) (</span>repeat <span class="str">' '</span><span class="sym">)) ++</span> is

sieve n <span class="sym">=</span> <span class="kwa">do let</span> m <span class="sym">= (</span><span class="num">1</span> `shiftL` n<span class="sym">) *</span> <span class="num">10000</span>
             arr <span class="sym">&lt;-</span> newArray <span class="sym">(</span><span class="num">2</span><span class="sym">,</span>m<span class="sym">)</span> <span class="kwa">True</span>
             c   <span class="sym">&lt;-</span> loop arr m <span class="num">2 0</span>
             putStrLn <span class="sym">(</span><span class="str">&quot;Primes up to &quot;</span><span class="sym">++</span>fmt <span class="num">8</span> m<span class="sym">++</span><span class="str">&quot; &quot;</span><span class="sym">++</span>fmt <span class="num">8</span> c<span class="sym">)</span>

main <span class="sym">=</span> <span class="kwa">do</span> n <span class="sym">&lt;-</span> getArgs <span class="sym">&gt;&gt;=</span> readIO.head
          sieve n <span class="sym">&gt;&gt;</span> sieve <span class="sym">(</span>n<span class="sym">-</span><span class="num">1</span><span class="sym">) &gt;&gt;</span> sieve <span class="sym">(</span>n<span class="sym">-</span><span class="num">2</span><span class="sym">)</span>
