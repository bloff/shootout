<span class="hl com">(* mandelbrot.sml</span>
<span class="hl com"> *</span>
<span class="hl com"> *   Mandelbrot (fractal generation) benchmark.</span>
<span class="hl com"> *     (Loosely based on the C version.)</span>
<span class="hl com"> *</span>
<span class="hl com"> * Copyright (c) 2004 by The Fellowship of SML/NJ</span>
<span class="hl com"> *</span>
<span class="hl com"> * Author: Matthias Blume (blume&#64;tti-c.org)</span>
<span class="hl com"> * Modified and ported to MLton by Vesa Karvonen.</span>
<span class="hl com"> *)</span>

<span class="hl kwa">val</span> <span class="hl sym">(</span>K<span class="hl sym">,</span> L2<span class="hl sym">) = (</span><span class="hl num">50</span><span class="hl sym">,</span> <span class="hl num">4.0</span><span class="hl sym">)</span>

<span class="hl kwa">fun</span> out b <span class="hl sym">=</span> <span class="hl kwa">TextIO</span>.output1 <span class="hl sym">(</span><span class="hl kwa">TextIO</span>.stdOut<span class="hl sym">,</span> Byte.byteToChar b<span class="hl sym">)</span>

<span class="hl kwa">fun</span> mandel <span class="hl sym">(</span>h<span class="hl sym">,</span> w<span class="hl sym">) =</span>
   <span class="hl kwa">let fun</span> p <span class="hl sym">(</span>x<span class="hl sym">,</span> y<span class="hl sym">) =</span>
          <span class="hl kwa">let val</span> <span class="hl sym">(</span>Cr<span class="hl sym">,</span> Ci<span class="hl sym">) = (</span><span class="hl kwb">real</span> x<span class="hl sym">*</span><span class="hl num">2.0</span><span class="hl sym">/</span><span class="hl kwb">real</span> w<span class="hl sym">-</span><span class="hl num">1.5</span><span class="hl sym">,</span> <span class="hl kwb">real</span> y<span class="hl sym">*</span><span class="hl num">2.0</span><span class="hl sym">/</span><span class="hl kwb">real</span> h<span class="hl sym">-</span><span class="hl num">1.0</span><span class="hl sym">)</span>
              <span class="hl kwa">fun</span> lp <span class="hl sym">(</span>r<span class="hl sym">,</span> i<span class="hl sym">,</span> k<span class="hl sym">) =</span>
                  <span class="hl kwa">let val</span> <span class="hl sym">(</span>r2<span class="hl sym">,</span> i2<span class="hl sym">) = (</span>r<span class="hl sym">*</span>r<span class="hl sym">,</span> i<span class="hl sym">*</span>i<span class="hl sym">)</span>
                  <span class="hl kwa">in</span> r2<span class="hl sym">+</span>i2 <span class="hl sym">&lt;=</span> L2 <span class="hl kwa">andalso</span>
                     <span class="hl sym">(</span>k<span class="hl sym">=</span><span class="hl num">0</span> <span class="hl kwa">orelse</span> lp <span class="hl sym">(</span>r2<span class="hl sym">-</span>i2<span class="hl sym">+</span>Cr<span class="hl sym">, (</span>r<span class="hl sym">+</span>r<span class="hl sym">)*</span>i<span class="hl sym">+</span>Ci<span class="hl sym">,</span> k<span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">))</span> <span class="hl kwa">end</span>
          <span class="hl kwa">in</span> lp <span class="hl sym">(</span><span class="hl num">0.0</span><span class="hl sym">,</span> <span class="hl num">0.0</span><span class="hl sym">,</span> K<span class="hl sym">)</span> <span class="hl kwa">end</span>
       <span class="hl kwa">fun</span> xl <span class="hl sym">(</span>x<span class="hl sym">,</span> y<span class="hl sym">,</span> b<span class="hl sym">,</span> n<span class="hl sym">) =</span>
          <span class="hl kwa">if</span> x <span class="hl sym">=</span> w <span class="hl kwa">then</span> <span class="hl sym">(</span>out <span class="hl sym">(</span><span class="hl kwa">Word8</span>.<span class="hl sym">&lt;&lt; (</span>b<span class="hl sym">,</span> n<span class="hl sym">)) ;</span> yl <span class="hl sym">(</span>y<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">))</span>
          <span class="hl kwa">else let val</span> <span class="hl sym">(</span>b<span class="hl sym">,</span> n<span class="hl sym">) =</span> <span class="hl kwa">if</span> n<span class="hl sym">=</span><span class="hl num">0</span>w0 <span class="hl kwa">then</span> <span class="hl sym">(</span>out b <span class="hl sym">; (</span><span class="hl num">0</span>w0<span class="hl sym">,</span> <span class="hl num">0</span>w8<span class="hl sym">))</span> <span class="hl kwa">else</span> <span class="hl sym">(</span>b<span class="hl sym">,</span> n<span class="hl sym">)</span>
               <span class="hl kwa">in</span> xl <span class="hl sym">(</span>x<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">,</span> y<span class="hl sym">,</span> b<span class="hl sym">+</span>b<span class="hl sym">+(</span><span class="hl kwa">if</span> p <span class="hl sym">(</span>x<span class="hl sym">,</span> y<span class="hl sym">)</span> <span class="hl kwa">then</span> <span class="hl num">0</span>w1 <span class="hl kwa">else</span> <span class="hl num">0</span>w0<span class="hl sym">),</span> n<span class="hl sym">-</span><span class="hl num">0</span>w1<span class="hl sym">)</span> <span class="hl kwa">end</span>
       <span class="hl kwa">and</span> yl y <span class="hl sym">=</span> <span class="hl kwa">if</span> y <span class="hl sym">&lt;</span> h <span class="hl kwa">then</span> xl <span class="hl sym">(</span><span class="hl num">0</span><span class="hl sym">,</span> y<span class="hl sym">,</span> <span class="hl num">0</span>w0<span class="hl sym">,</span> <span class="hl num">0</span>w8<span class="hl sym">)</span> <span class="hl kwa">else</span> <span class="hl sym">()</span>
   <span class="hl kwa">in</span> app print <span class="hl sym">[</span><span class="hl str">&quot;P4</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl sym">,</span> <span class="hl kwa">Int</span>.toString h<span class="hl sym">,</span> <span class="hl str">&quot; &quot;</span><span class="hl sym">,</span> <span class="hl kwa">Int</span>.toString w<span class="hl sym">,</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl sym">] ;</span> yl <span class="hl num">0</span> <span class="hl kwa">end</span>

<span class="hl kwa">val</span> n <span class="hl sym">=</span> valOf <span class="hl sym">(</span><span class="hl kwa">Int</span>.fromString <span class="hl sym">(</span>hd <span class="hl sym">(</span>CommandLine.arguments <span class="hl sym">())))</span> <span class="hl kwa">handle</span> _ <span class="hl sym">=&gt;</span> <span class="hl num">600</span>

<span class="hl kwa">val</span> _ <span class="hl sym">=</span> mandel <span class="hl sym">(</span>n<span class="hl sym">,</span> n<span class="hl sym">)</span>
