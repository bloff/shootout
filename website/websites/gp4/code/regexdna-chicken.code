<span class="hl slc">;; ---------------------------------------------------------------------</span>
<span class="hl slc">;; The Great Computer Language Shootout</span>
<span class="hl slc">;; http://shootout.alioth.debian.org/</span>
<span class="hl slc">;;</span>
<span class="hl slc">;; Tested with PCRE [compiler must be built with PCRE already installed</span>
<span class="hl slc">;; else other regex routines (with different behaviours) will be used].</span>
<span class="hl slc">;; Regex performance appears reasonable, but file loading [of 'large'</span>
<span class="hl slc">;; files] performance requires tweaking to effect a significant improvement.</span>
<span class="hl slc">;;</span>
<span class="hl slc">;; Contributed by Anthony Borla</span>
<span class="hl slc">;; ---------------------------------------------------------------------</span>

<span class="hl sym">(</span>require-extension format<span class="hl sym">)</span>

<span class="hl sym">(</span>declare <span class="hl sym">(</span>fixnum<span class="hl sym">) (</span>disable-interrupts<span class="hl sym">) (</span>unsafe<span class="hl sym">) (</span>block<span class="hl sym">) (</span>uses regex posix<span class="hl sym">))</span>

<span class="hl slc">; -------------------------------</span>

<span class="hl sym">(</span>define-constant VARIANTS
  <span class="hl sym">(</span><span class="hl kwa">list</span>
    <span class="hl str">&quot;agggtaaa|tttaccct&quot;</span> <span class="hl str">&quot;[cgt]gggtaaa|tttaccc[acg]&quot;</span> <span class="hl str">&quot;a[act]ggtaaa|tttacc[agt]t&quot;</span>
    <span class="hl str">&quot;ag[act]gtaaa|tttac[agt]ct&quot;</span> <span class="hl str">&quot;agg[act]taaa|ttta[agt]cct&quot;</span> <span class="hl str">&quot;aggg[acg]aaa|ttt[cgt]ccct&quot;</span>
    <span class="hl str">&quot;agggt[cgt]aa|tt[acg]accct&quot;</span> <span class="hl str">&quot;agggta[cgt]a|t[acg]taccct&quot;</span> <span class="hl str">&quot;agggtaa[cgt]|[acg]ttaccct&quot;</span><span class="hl sym">))</span>

<span class="hl slc">; --------------</span>

<span class="hl sym">(</span>define-constant IUBS
  <span class="hl sym">(</span><span class="hl kwa">list</span>
    <span class="hl sym">(</span><span class="hl kwa">cons</span> <span class="hl str">&quot;B&quot;</span> <span class="hl str">&quot;(c|g|t)&quot;</span><span class="hl sym">) (</span><span class="hl kwa">cons</span> <span class="hl str">&quot;D&quot;</span> <span class="hl str">&quot;(a|g|t)&quot;</span><span class="hl sym">) (</span><span class="hl kwa">cons</span> <span class="hl str">&quot;H&quot;</span> <span class="hl str">&quot;(a|c|t)&quot;</span><span class="hl sym">)</span>
    <span class="hl sym">(</span><span class="hl kwa">cons</span> <span class="hl str">&quot;K&quot;</span> <span class="hl str">&quot;(g|t)&quot;</span><span class="hl sym">) (</span><span class="hl kwa">cons</span> <span class="hl str">&quot;M&quot;</span> <span class="hl str">&quot;(a|c)&quot;</span><span class="hl sym">) (</span><span class="hl kwa">cons</span> <span class="hl str">&quot;N&quot;</span> <span class="hl str">&quot;(a|c|g|t)&quot;</span><span class="hl sym">)</span>
    <span class="hl sym">(</span><span class="hl kwa">cons</span> <span class="hl str">&quot;R&quot;</span> <span class="hl str">&quot;(a|g)&quot;</span><span class="hl sym">) (</span><span class="hl kwa">cons</span> <span class="hl str">&quot;S&quot;</span> <span class="hl str">&quot;(c|g)&quot;</span><span class="hl sym">) (</span><span class="hl kwa">cons</span> <span class="hl str">&quot;V&quot;</span> <span class="hl str">&quot;(a|c|g)&quot;</span><span class="hl sym">)</span>
    <span class="hl sym">(</span><span class="hl kwa">cons</span> <span class="hl str">&quot;W&quot;</span> <span class="hl str">&quot;(a|t)&quot;</span><span class="hl sym">) (</span><span class="hl kwa">cons</span> <span class="hl str">&quot;Y&quot;</span> <span class="hl str">&quot;(c|t)&quot;</span><span class="hl sym">)))</span>

<span class="hl slc">; -------------------------------</span>

<span class="hl sym">(</span>define <span class="hl sym">(</span><span class="hl kwa">load</span>-sequence fileno<span class="hl sym">)</span>
  <span class="hl sym">(</span>let<span class="hl sym">* ((</span>size <span class="hl sym">(</span>file-size fileno<span class="hl sym">))</span>
         <span class="hl sym">(</span>buffer <span class="hl sym">(</span>make-string size<span class="hl sym">)))</span>
    <span class="hl sym">(</span>file-<span class="hl kwa">read</span> fileno size buffer<span class="hl sym">)</span>
    <span class="hl sym">(</span><span class="hl kwa">cons</span> size buffer<span class="hl sym">)))</span>

<span class="hl slc">; --------------</span>

<span class="hl sym">(</span>define <span class="hl sym">(</span>match-count rx buffer<span class="hl sym">)</span>
  <span class="hl sym">(</span>let match <span class="hl sym">((</span>spos <span class="hl sym">(</span>string-search-positions rx buffer <span class="hl num">0</span><span class="hl sym">)) (</span>count <span class="hl num">0</span><span class="hl sym">))</span>
    <span class="hl sym">(</span><span class="hl kwa">if</span> <span class="hl sym">(</span>boolean? spos<span class="hl sym">)</span>
      count
      <span class="hl sym">(</span>match <span class="hl sym">(</span>string-search-positions rx buffer <span class="hl sym">(</span><span class="hl kwa">cadr</span> <span class="hl sym">(</span><span class="hl kwa">car</span> spos<span class="hl sym">))) (+</span> <span class="hl num">1</span> count<span class="hl sym">)))))</span>

<span class="hl slc">; -------------------------------</span>

<span class="hl sym">(</span>define <span class="hl sym">(</span>main<span class="hl sym">)</span>

  <span class="hl slc">; Load sequence and record its length</span>
  <span class="hl sym">(</span>let<span class="hl sym">* ((</span>buffer <span class="hl sym">(</span><span class="hl kwa">load</span>-sequence fileno<span class="hl sym">/</span>stdin<span class="hl sym">)) (</span>sequence <span class="hl sym">(</span><span class="hl kwa">cdr</span> buffer<span class="hl sym">))</span>
         <span class="hl sym">(</span>initial-<span class="hl kwa">length</span> <span class="hl sym">(</span><span class="hl kwa">car</span> buffer<span class="hl sym">)) (</span>code-<span class="hl kwa">length</span> <span class="hl num">0</span><span class="hl sym">))</span>

    <span class="hl slc">; Remove newline and segment divider line occurrences; record new length</span>
    <span class="hl sym">(</span><span class="hl kwa">set</span><span class="hl sym">!</span> sequence <span class="hl sym">(</span>string-substitute <span class="hl sym">(</span>regexp <span class="hl str">&quot;(&gt;.*?</span><span class="hl esc">\n</span><span class="hl str">)|(</span><span class="hl esc">\n</span><span class="hl str">)&quot;</span> #t<span class="hl sym">)</span> <span class="hl str">&quot;&quot;</span> sequence #t<span class="hl sym">))</span>
    <span class="hl sym">(</span><span class="hl kwa">set</span><span class="hl sym">!</span> code-<span class="hl kwa">length</span> <span class="hl sym">(</span>string-<span class="hl kwa">length</span> sequence<span class="hl sym">))</span>

    <span class="hl slc">; Perform regexp counts</span>
    <span class="hl sym">(</span>for-each
      <span class="hl sym">(</span><span class="hl kwa">lambda</span> <span class="hl sym">(</span>i<span class="hl sym">)</span>
        <span class="hl sym">(</span>format #t <span class="hl str">&quot;~A ~A~%&quot;</span> i <span class="hl sym">(</span>match-count i sequence<span class="hl sym">)))</span>
        VARIANTS<span class="hl sym">)</span>

    <span class="hl slc">; Perform regexp replacements, and record sequence length</span>
    <span class="hl sym">(</span>for-each
      <span class="hl sym">(</span><span class="hl kwa">lambda</span> <span class="hl sym">(</span>i<span class="hl sym">)</span>
        <span class="hl sym">(</span><span class="hl kwa">set</span><span class="hl sym">!</span> sequence <span class="hl sym">(</span>string-substitute <span class="hl sym">(</span>regexp <span class="hl sym">(</span><span class="hl kwa">car</span> i<span class="hl sym">)</span> #t<span class="hl sym">) (</span><span class="hl kwa">cdr</span> i<span class="hl sym">)</span> sequence #t<span class="hl sym">)))</span>
        IUBS<span class="hl sym">)</span>

    <span class="hl slc">; Print statistics</span>
    <span class="hl sym">(</span>format #t <span class="hl str">&quot;~%~A~%~A~%~A~%&quot;</span> initial-<span class="hl kwa">length</span> code-<span class="hl kwa">length</span> <span class="hl sym">(</span>string-<span class="hl kwa">length</span> sequence<span class="hl sym">))))</span>

<span class="hl slc">; -------------------------------</span>

<span class="hl sym">(</span>main<span class="hl sym">)</span>

