<span class="hl slc">%  The Great Computer Language Shootout</span>
<span class="hl slc">%   http://shootout.alioth.debian.org/</span>
<span class="hl slc">%</span>
<span class="hl slc">%   contributed by Soeren Finster</span>
<span class="hl slc">%</span>
<span class="hl slc">%   erl -noshell -noinput -run message main N</span>


<span class="hl sym">-</span><span class="hl kwd">module</span><span class="hl sym">(</span>message<span class="hl sym">)</span>.
<span class="hl sym">-</span><span class="hl kwd">export</span><span class="hl sym">([</span>main<span class="hl sym">/</span><span class="hl num">1</span><span class="hl sym">,</span> loop<span class="hl sym">/</span><span class="hl num">1</span><span class="hl sym">])</span>.

<span class="hl kwd">main</span><span class="hl sym">([</span>Arg<span class="hl sym">]) -&gt;</span>
    N <span class="hl sym">=</span> <span class="hl kwb">list_to_integer</span><span class="hl sym">(</span>Arg<span class="hl sym">),</span>
    Last <span class="hl sym">=</span> <span class="hl kwd">start</span><span class="hl sym">(</span><span class="hl num">500</span><span class="hl sym">,</span> <span class="hl kwb">self</span><span class="hl sym">()),</span>
    io<span class="hl sym">:</span><span class="hl kwd">fwrite</span><span class="hl sym">(</span><span class="hl str">&quot;~p~n&quot;</span><span class="hl sym">, [</span><span class="hl kwd">sendtimes</span><span class="hl sym">(</span>N<span class="hl sym">,</span> Last<span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">)]),</span>
    erlang<span class="hl sym">:</span><span class="hl kwb">halt</span><span class="hl sym">(</span><span class="hl num">0</span><span class="hl sym">)</span>.

<span class="hl kwd">start</span><span class="hl sym">(</span><span class="hl num">0</span><span class="hl sym">,</span> LastPID<span class="hl sym">) -&gt;</span> LastPID<span class="hl sym">;</span>

<span class="hl kwd">start</span><span class="hl sym">(</span>X<span class="hl sym">,</span> LastPID<span class="hl sym">) -&gt;</span> <span class="hl kwd">start</span><span class="hl sym">(</span>X<span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">,</span> <span class="hl kwb">spawn</span><span class="hl sym">(</span>message<span class="hl sym">,</span> loop<span class="hl sym">, [</span>LastPID<span class="hl sym">]))</span>.

<span class="hl kwd">loop</span><span class="hl sym">(</span>LastPID<span class="hl sym">) -&gt;</span>
	<span class="hl kwa">receive</span>
		N <span class="hl sym">-&gt;</span>
		LastPID <span class="hl sym">!</span> N<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">,</span>
		<span class="hl kwd">loop</span><span class="hl sym">(</span>LastPID<span class="hl sym">)</span>
	<span class="hl kwa">end</span>.

<span class="hl kwd">sendtimes</span><span class="hl sym">(</span><span class="hl num">0</span><span class="hl sym">,</span>_ <span class="hl sym">,</span>X<span class="hl sym">) -&gt;</span> X<span class="hl sym">;</span>

<span class="hl kwd">sendtimes</span><span class="hl sym">(</span>N<span class="hl sym">,</span> Last<span class="hl sym">,</span> X<span class="hl sym">) -&gt;</span>
	Last <span class="hl sym">!</span> <span class="hl num">0</span><span class="hl sym">,</span>
	<span class="hl kwa">receive</span>	Y <span class="hl sym">-&gt;</span> Y <span class="hl kwa">end</span><span class="hl sym">,</span>
	<span class="hl kwd">sendtimes</span><span class="hl sym">(</span>N<span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">,</span> Last<span class="hl sym">,</span> X<span class="hl sym">+</span>Y<span class="hl sym">)</span>.


