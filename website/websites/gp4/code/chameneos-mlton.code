<span class="hl com">(* The Computer Language Shootout</span>
<span class="hl com"> * http://shootout.alioth.debian.org/</span>
<span class="hl com"> *</span>
<span class="hl com"> * Contributed by Vesa Karvonen.</span>
<span class="hl com"> *)</span>

<span class="hl com">(* abbreviations *)</span>
<span class="hl kwa">structure</span> A<span class="hl sym">=</span>CommandLine <span class="hl kwa">and</span> C<span class="hl sym">=</span>CML <span class="hl kwa">and</span> I<span class="hl sym">=</span><span class="hl kwa">Int and</span> R<span class="hl sym">=</span>RunCML

<span class="hl com">(* color manipulation *)</span>
<span class="hl kwa">datatype</span> color <span class="hl sym">=</span> R <span class="hl sym">|</span> B <span class="hl sym">|</span> Y

<span class="hl kwa">val</span> compl <span class="hl sym">=</span> <span class="hl kwa">fn</span> <span class="hl sym">(</span>B<span class="hl sym">,</span>B<span class="hl sym">) =&gt;</span> B <span class="hl sym">| (</span>B<span class="hl sym">,</span>R<span class="hl sym">) =&gt;</span> Y <span class="hl sym">| (</span>B<span class="hl sym">,</span>Y<span class="hl sym">) =&gt;</span> R <span class="hl sym">| (</span>R<span class="hl sym">,</span>B<span class="hl sym">) =&gt;</span> Y <span class="hl sym">| (</span>R<span class="hl sym">,</span>R<span class="hl sym">) =&gt;</span> R
             <span class="hl sym">| (</span>R<span class="hl sym">,</span>Y<span class="hl sym">) =&gt;</span> B <span class="hl sym">| (</span>Y<span class="hl sym">,</span>B<span class="hl sym">) =&gt;</span> R <span class="hl sym">| (</span>Y<span class="hl sym">,</span>R<span class="hl sym">) =&gt;</span> B <span class="hl sym">| (</span>Y<span class="hl sym">,</span>Y<span class="hl sym">) =&gt;</span> Y

<span class="hl com">(* creates the meeting place *)</span>
<span class="hl kwa">fun</span> place n <span class="hl sym">=</span>
   <span class="hl kwa">let val</span> p <span class="hl sym">=</span> C.channel <span class="hl sym">()</span>
       <span class="hl kwa">fun</span> lp <span class="hl num">0</span> <span class="hl sym">= (</span>C.send <span class="hl sym">(</span>#<span class="hl num">1</span> <span class="hl sym">(</span>C.recv p<span class="hl sym">),</span> NONE<span class="hl sym">) ;</span> lp <span class="hl num">0</span><span class="hl sym">)</span>
         <span class="hl sym">|</span> lp n <span class="hl sym">=</span> <span class="hl kwa">let val</span> <span class="hl sym">((</span>a1<span class="hl sym">,</span> c1<span class="hl sym">), (</span>a2<span class="hl sym">,</span> c2<span class="hl sym">)) = (</span>C.recv p<span class="hl sym">,</span> C.recv p<span class="hl sym">)</span>
                  <span class="hl kwa">in</span> C.send <span class="hl sym">(</span>a1<span class="hl sym">,</span> SOME c2<span class="hl sym">) ;</span> C.send <span class="hl sym">(</span>a2<span class="hl sym">,</span> SOME c1<span class="hl sym">) ;</span> lp <span class="hl sym">(</span>n<span class="hl sym">-</span><span class="hl num">1</span><span class="hl sym">)</span> <span class="hl kwa">end</span>
   <span class="hl kwa">in</span> ignore <span class="hl sym">(</span>C.spawn <span class="hl sym">(</span><span class="hl kwa">fn</span> <span class="hl sym">() =&gt;</span> lp n<span class="hl sym">)) ;</span> p <span class="hl kwa">end</span>

<span class="hl com">(* creates an animal *)</span>
<span class="hl kwa">fun</span> animal p m c <span class="hl sym">=</span> <span class="hl kwa">let val</span> a <span class="hl sym">=</span> C.channel <span class="hl sym">()</span>
                       <span class="hl kwa">fun</span> lp <span class="hl sym">(</span>n<span class="hl sym">,</span> c<span class="hl sym">) = (</span>C.send <span class="hl sym">(</span>p<span class="hl sym">, (</span>a<span class="hl sym">,</span> c<span class="hl sym">))</span>
                                      <span class="hl sym">;</span> <span class="hl kwa">case</span> C.recv a <span class="hl kwa">of</span>
                                            NONE <span class="hl sym">=&gt;</span> C.send <span class="hl sym">(</span>m<span class="hl sym">,</span> n<span class="hl sym">)</span>
                                          <span class="hl sym">|</span> SOME oc <span class="hl sym">=&gt;</span> lp <span class="hl sym">(</span>n<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">,</span> compl <span class="hl sym">(</span>c<span class="hl sym">,</span> oc<span class="hl sym">)))</span>
                   <span class="hl kwa">in</span> ignore <span class="hl sym">(</span>C.spawn <span class="hl sym">(</span><span class="hl kwa">fn</span> <span class="hl sym">() =&gt;</span> lp <span class="hl sym">(</span><span class="hl num">0</span><span class="hl sym">,</span> c<span class="hl sym">)))</span> <span class="hl kwa">end</span>

<span class="hl com">(* driver *)</span>
<span class="hl kwa">fun</span> go n <span class="hl sym">() =</span> <span class="hl kwa">let val</span> <span class="hl sym">(</span>p<span class="hl sym">,</span> m<span class="hl sym">) = (</span>place n<span class="hl sym">,</span> C.channel <span class="hl sym">())</span>
              <span class="hl kwa">in</span> foldl <span class="hl sym">(</span><span class="hl kwa">fn</span> <span class="hl sym">(</span>c<span class="hl sym">,</span> f<span class="hl sym">) =&gt; (</span>animal p m c <span class="hl sym">;</span> f <span class="hl kwa">o</span> <span class="hl sym">(</span><span class="hl kwa">fn</span> s <span class="hl sym">=&gt;</span> s<span class="hl sym">+</span>C.recv m<span class="hl sym">)))</span>
                       <span class="hl sym">(</span><span class="hl kwa">fn</span> s <span class="hl sym">=&gt;</span> print <span class="hl sym">(</span>I.toString s^<span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span><span class="hl sym">)) [</span>B<span class="hl sym">,</span> R<span class="hl sym">,</span> Y<span class="hl sym">,</span> B<span class="hl sym">]</span> <span class="hl num">0</span> <span class="hl kwa">end</span>

<span class="hl kwa">val</span> _ <span class="hl sym">=</span> R.doit <span class="hl sym">(</span>go<span class="hl sym">(</span>valOf<span class="hl sym">(</span>I.fromString<span class="hl sym">(</span>hd<span class="hl sym">(</span>A.arguments<span class="hl sym">())))</span> <span class="hl kwa">handle</span> _ <span class="hl sym">=&gt;</span> <span class="hl num">1</span><span class="hl sym">),</span> NONE<span class="hl sym">)</span>
