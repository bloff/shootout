<span class="slc"># The Computer Language Shootout</span>
<span class="slc">#  http://shootout.alioth.debian.org/</span>
<span class="slc">#</span>
<span class="slc">#  contributed by drigz</span>
<span class="slc">#  modified by Josh G0ldfoot</span>

<span class="kwc">import</span> sys
<span class="kwc">import</span> thread

RED <span class="sym">=</span> <span class="num">1</span>
BLUE <span class="sym">=</span> <span class="num">2</span>
YELLOW <span class="sym">=</span> <span class="num">3</span>
FADED <span class="sym">=</span> <span class="num">4</span>



<span class="kwb">def</span> <span class="kwd">change_colour</span><span class="sym">(</span>me<span class="sym">,</span> other<span class="sym">):</span>
    <span class="kwb">return</span> <span class="num">6</span> <span class="sym">- (</span>me <span class="sym">+</span> other<span class="sym">)</span>

<span class="kwa">class</span> MeetingPlace<span class="sym">:</span>
    <span class="kwb">def</span> <span class="kwd">__init__</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">,</span> n<span class="sym">):</span>
        <span class="kwc">self</span><span class="sym">.</span>n <span class="sym">=</span> n

        <span class="kwc">self</span><span class="sym">.</span>first <span class="sym">=</span> None
        <span class="kwc">self</span><span class="sym">.</span>second <span class="sym">=</span> None

        <span class="kwc">self</span><span class="sym">.</span>empty <span class="sym">=</span> True
        <span class="kwc">self</span><span class="sym">.</span>entrylock <span class="sym">=</span> threading<span class="sym">.</span><span class="kwd">Lock</span><span class="sym">()</span> <span class="slc">#this locks the entry code</span>
        <span class="kwc">self</span><span class="sym">.</span>meetnotify <span class="sym">=</span> threading<span class="sym">.</span><span class="kwd">Condition</span><span class="sym">()</span>

    <span class="kwb">def</span> <span class="kwd">meet</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">,</span> me<span class="sym">):</span>
        <span class="kwc">self</span><span class="sym">.</span>entrylock<span class="sym">.</span><span class="kwd">acquire</span><span class="sym">()</span>

        <span class="kwb">if</span> <span class="kwc">self</span><span class="sym">.</span>empty<span class="sym">:</span> <span class="slc">#noone's here</span>
            <span class="kwb">if</span> <span class="kwc">self</span><span class="sym">.</span>n <span class="sym">==</span> <span class="num">0</span><span class="sym">:</span> <span class="slc">#check if we should meet or not</span>
                <span class="kwc">self</span><span class="sym">.</span>entrylock<span class="sym">.</span><span class="kwd">release</span><span class="sym">()</span>
                <span class="kwb">return</span> FADED

            <span class="kwc">self</span><span class="sym">.</span>empty <span class="sym">=</span> False
            <span class="kwc">self</span><span class="sym">.</span>n <span class="sym">-=</span> <span class="num">1</span>
            <span class="kwc">self</span><span class="sym">.</span>first <span class="sym">=</span> me <span class="slc">#register my presence</span>

            <span class="slc">#wait for the next person</span>
            <span class="kwc">self</span><span class="sym">.</span>meetnotify<span class="sym">.</span><span class="kwd">acquire</span><span class="sym">()</span>
            <span class="kwc">self</span><span class="sym">.</span>entrylock<span class="sym">.</span><span class="kwd">release</span><span class="sym">()</span> <span class="slc">#let the people enter so we can meet</span>
            <span class="kwc">self</span><span class="sym">.</span>meetnotify<span class="sym">.</span><span class="kwd">wait</span><span class="sym">()</span>
            <span class="kwc">self</span><span class="sym">.</span>meetnotify<span class="sym">.</span><span class="kwd">release</span><span class="sym">()</span>

            other <span class="sym">=</span> <span class="kwc">self</span><span class="sym">.</span>second <span class="slc">#we've met someone</span>

            <span class="kwc">self</span><span class="sym">.</span>first <span class="sym">=</span> None <span class="slc">#we both leave</span>
            <span class="kwc">self</span><span class="sym">.</span>second <span class="sym">=</span> None
            <span class="kwc">self</span><span class="sym">.</span>empty <span class="sym">=</span> True
            <span class="kwc">self</span><span class="sym">.</span>entrylock<span class="sym">.</span><span class="kwd">release</span><span class="sym">()</span> <span class="slc">#let others enter, our meeting is over</span>
        <span class="kwb">else</span><span class="sym">:</span> <span class="slc">#we've met someone else</span>
            other <span class="sym">=</span> <span class="kwc">self</span><span class="sym">.</span>first <span class="slc">#register our presence</span>
            <span class="kwc">self</span><span class="sym">.</span>second <span class="sym">=</span> me
            <span class="kwc">self</span><span class="sym">.</span>meetnotify<span class="sym">.</span><span class="kwd">acquire</span><span class="sym">()</span> <span class="slc">#notify the person waiting</span>
            <span class="kwc">self</span><span class="sym">.</span>meetnotify<span class="sym">.</span><span class="kwd">notify</span><span class="sym">()</span>
            <span class="kwc">self</span><span class="sym">.</span>meetnotify<span class="sym">.</span><span class="kwd">release</span><span class="sym">()</span>

        <span class="kwb">assert not</span> <span class="sym">(</span>other <span class="kwb">is</span> None<span class="sym">)</span>
        <span class="kwb">return</span> other

<span class="kwa">class</span> Creature<span class="sym">:</span>
    <span class="kwb">def</span> <span class="kwd">__init__</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">,</span> colour<span class="sym">,</span> meetingplace<span class="sym">):</span>
        <span class="kwc">self</span><span class="sym">.</span>colour <span class="sym">=</span> colour
        <span class="kwc">self</span><span class="sym">.</span>mp <span class="sym">=</span> meetingplace

        <span class="kwc">self</span><span class="sym">.</span>met <span class="sym">=</span> <span class="num">0</span>

    <span class="kwb">def</span> <span class="kwd">socialise</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">):</span>
        <span class="kwb">while</span> <span class="kwc">self</span><span class="sym">.</span>colour <span class="sym">!=</span> FADED<span class="sym">:</span> <span class="slc">#keep looking for creatures to meet</span>
            <span class="kwc">self</span><span class="sym">.</span><span class="kwd">meet</span><span class="sym">()</span>

    <span class="kwb">def</span> <span class="kwd">meet</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">):</span>
        other <span class="sym">=</span> <span class="kwc">self</span><span class="sym">.</span>mp<span class="sym">.</span><span class="kwd">meet</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">.</span>colour<span class="sym">)</span> <span class="slc">#get the other's colour</span>
        <span class="kwb">if</span> other <span class="sym">==</span> FADED<span class="sym">:</span>
            <span class="kwc">self</span><span class="sym">.</span>colour <span class="sym">=</span> FADED
        <span class="kwb">else</span><span class="sym">:</span>
            <span class="kwc">self</span><span class="sym">.</span>met <span class="sym">+=</span> <span class="num">1</span>
            <span class="kwc">self</span><span class="sym">.</span>colour <span class="sym">=</span> <span class="kwd">change_colour</span><span class="sym">(</span><span class="kwc">self</span><span class="sym">.</span>colour<span class="sym">,</span> other<span class="sym">)</span>

<span class="kwb">def</span> <span class="kwd">main</span><span class="sym">():</span>
    <span class="slc">#n = int(sys.argv[1])</span>
    n <span class="sym">=</span> <span class="num">10000</span>

    meetingplace <span class="sym">=</span> <span class="kwd">MeetingPlace</span><span class="sym">(</span>n<span class="sym">)</span>

    colours <span class="sym">= [</span>BLUE<span class="sym">,</span> RED<span class="sym">,</span> YELLOW<span class="sym">,</span> BLUE<span class="sym">]</span>
    creatures <span class="sym">= [</span><span class="kwd">Creature</span><span class="sym">(</span>c<span class="sym">,</span> meetingplace<span class="sym">)</span> <span class="kwb">for</span> c <span class="kwb">in</span> colours<span class="sym">]</span>
    threads <span class="sym">= [</span>threading<span class="sym">.</span><span class="kwd">Thread</span><span class="sym">(</span>target<span class="sym">=</span>c<span class="sym">.</span>socialise<span class="sym">)</span> <span class="kwb">for</span> c <span class="kwb">in</span> creatures<span class="sym">]</span>

    <span class="kwb">for</span> t <span class="kwb">in</span> threads<span class="sym">:</span>
        t<span class="sym">.</span><span class="kwd">start</span><span class="sym">()</span>

    <span class="kwb">for</span> t <span class="kwb">in</span> threads<span class="sym">:</span>
        t<span class="sym">.</span><span class="kwd">join</span><span class="sym">()</span>

    <span class="kwb">print</span> <span class="kwd">sum</span><span class="sym">([</span>c<span class="sym">.</span>met <span class="kwb">for</span> c <span class="kwb">in</span> creatures<span class="sym">])</span>

<span class="kwc">import</span> timeit
t <span class="sym">=</span>  timeit<span class="sym">.</span><span class="kwd">Timer</span><span class="sym">(</span><span class="str">&quot;main()&quot;</span><span class="sym">,</span> <span class="str">&quot;from __main__ import main&quot;</span><span class="sym">)</span>
<span class="kwb">print</span> t<span class="sym">.</span><span class="kwd">timeit</span><span class="sym">(</span><span class="num">5</span><span class="sym">)</span>
<span class="slc"># 4.52697088596 -- as I found it</span>

