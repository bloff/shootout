<span class="slc">% ----------------------------------------------------------------------</span>
<span class="slc">% The Great Computer Language Shootout</span>
<span class="slc">% http://shootout.alioth.debian.org/</span>
<span class="slc">%</span>
<span class="slc">% Contributed by Anthony Borla</span>
<span class="slc">% ----------------------------------------------------------------------</span>

<span class="kwa">functor</span>

<span class="kwa">import</span>
  System<span class="sym">(</span>showInfo printInfo<span class="sym">)</span> Application<span class="sym">(</span>exit getArgs<span class="sym">)</span> Open<span class="sym">(</span>file text<span class="sym">)</span>

<span class="kwa">define</span>

  <span class="kwa">class</span> TextFile_
    <span class="kwa">from</span> Open<span class="sym">.</span>file Open<span class="sym">.</span>text
  <span class="kwa">end</span>

<span class="slc">% ------------- %</span>

  ITERATIONS <span class="sym">=</span> <span class="num">50</span> LIMIT_SQR <span class="sym">=</span> <span class="num">4.0</span>

<span class="slc">% ------------- %</span>

  <span class="kwa">fun</span> <span class="sym">{</span>CmdlNArg Nth Default<span class="sym">}</span> N Nt <span class="kwa">in</span>
    <span class="kwa">try</span>
      Nt <span class="sym">= {</span>String<span class="sym">.</span>toInt <span class="sym">{</span>Application<span class="sym">.</span>getArgs plain<span class="sym">}.</span>Nth<span class="sym">}</span>
      N <span class="sym">=</span> <span class="kwa">if</span> Nt <span class="sym">&lt;</span> Default <span class="kwa">then</span> Default <span class="kwa">else</span> Nt <span class="kwa">end</span>
    <span class="kwa">catch</span> error<span class="sym">(...)</span> <span class="kwa">then</span>
      N <span class="sym">=</span> Default
    <span class="kwa">end</span>
    N
  <span class="kwa">end</span>

<span class="slc">% ------------- %</span>

  STDOUT <span class="sym">= {</span>New TextFile_ init<span class="sym">(</span>name<span class="sym">:</span>stdout<span class="sym">)}</span>

  N BitNum <span class="sym">= {</span>NewCell <span class="num">0</span><span class="sym">}</span> ByteAcc <span class="sym">= {</span>NewCell <span class="num">0</span><span class="sym">}</span>

  ZR <span class="sym">= {</span>NewCell <span class="num">0.0</span><span class="sym">}</span> ZI <span class="sym">= {</span>NewCell <span class="num">0.0</span><span class="sym">}</span> TR <span class="sym">= {</span>NewCell <span class="num">0.0</span><span class="sym">}</span>
  TI <span class="sym">= {</span>NewCell <span class="num">0.0</span><span class="sym">}</span> CR <span class="sym">= {</span>NewCell <span class="num">0.0</span><span class="sym">}</span> CI <span class="sym">= {</span>NewCell <span class="num">0.0</span><span class="sym">}</span>

  LIMIT_ADJ <span class="sym">= {</span>NewCell <span class="num">1</span><span class="sym">}</span> PRINT <span class="sym">= {</span>NewCell <span class="kwa">false</span><span class="sym">}</span>

<span class="slc">% ------------- %</span>

<span class="kwa">in</span>
  N <span class="sym">= {</span>CmdlNArg <span class="num">1 1</span><span class="sym">}</span>

  <span class="sym">{</span>STDOUT putS<span class="sym">({</span>VirtualString<span class="sym">.</span>toString &quot;P4<span class="sym">\</span>n&quot; <span class="sym">#</span> N <span class="sym">#</span> &quot; &quot; <span class="sym">#</span> N<span class="sym">})}</span>

  <span class="kwa">for</span> Y <span class="kwa">in</span> <span class="num">0</span><span class="sym">..(</span>N <span class="sym">-</span> <span class="num">1</span><span class="sym">)</span> do
    <span class="kwa">for</span> X <span class="kwa">in</span> <span class="num">0</span><span class="sym">..(</span>N <span class="sym">-</span> <span class="num">1</span><span class="sym">)</span> do
      ZR <span class="sym">:=</span> <span class="num">0.0</span> ZI <span class="sym">:=</span> <span class="num">0.0</span> TR <span class="sym">:=</span> <span class="num">0.0</span> TI <span class="sym">:=</span> <span class="num">0.0</span>

      CR <span class="sym">:= (</span><span class="num">2.0</span> <span class="sym">* {</span>IntToFloat X<span class="sym">} / {</span>IntToFloat N<span class="sym">}) -</span> <span class="num">1.5</span>
      CI <span class="sym">:= (</span><span class="num">2.0</span> <span class="sym">* {</span>IntToFloat Y<span class="sym">} / {</span>IntToFloat N<span class="sym">}) -</span> <span class="num">1.0</span>

      LIMIT_ADJ <span class="sym">:=</span> <span class="num">1</span>

      <span class="kwa">for</span> I <span class="kwa">in</span> <span class="num">0</span><span class="sym">;(</span>I <span class="sym">&lt;</span> ITERATIONS <span class="kwa">andthen</span> <span class="sym">&#64;</span>LIMIT_ADJ <span class="sym">\=</span> <span class="num">0</span><span class="sym">);(</span>I <span class="sym">+</span> <span class="num">1</span><span class="sym">)</span> do
        TR <span class="sym">:= &#64;</span>ZR <span class="sym">* &#64;</span>ZR <span class="sym">- &#64;</span>ZI <span class="sym">* &#64;</span>ZI <span class="sym">+ &#64;</span>CR
        TI <span class="sym">:=</span> <span class="num">2.0</span> <span class="sym">* &#64;</span>ZR <span class="sym">* &#64;</span>ZI <span class="sym">+ &#64;</span>CI ZR <span class="sym">:= &#64;</span>TR ZI <span class="sym">:= &#64;</span>TI

        <span class="kwa">if</span> <span class="sym">&#64;</span>ZR <span class="sym">* &#64;</span>ZR <span class="sym">+ &#64;</span>ZI <span class="sym">* &#64;</span>ZI <span class="sym">&gt;</span> LIMIT_SQR <span class="kwa">then</span> LIMIT_ADJ <span class="sym">:=</span> <span class="num">0</span> <span class="kwa">end</span>
      <span class="kwa">end</span>

      BitNum <span class="sym">:= &#64;</span>BitNum <span class="sym">+</span> <span class="num">1</span>
      ByteAcc <span class="sym">:= &#64;</span>ByteAcc <span class="sym">*</span> <span class="num">2</span> <span class="sym">+ &#64;</span>LIMIT_ADJ

      <span class="kwa">if</span> <span class="sym">&#64;</span>BitNum <span class="sym">==</span> <span class="num">8</span> <span class="kwa">then</span> PRINT <span class="sym">:=</span> <span class="kwa">true end</span>

      <span class="kwa">if</span> X <span class="sym">== (</span>N <span class="sym">-</span> <span class="num">1</span><span class="sym">)</span> <span class="kwa">andthen</span> <span class="sym">&#64;</span>BitNum <span class="sym">\=</span> <span class="num">8</span> <span class="kwa">then</span>
        ByteAcc <span class="sym">:= &#64;</span>ByteAcc <span class="sym">* {</span>Number<span class="sym">.</span>pow <span class="num">2</span> <span class="sym">(</span><span class="num">8</span> <span class="sym">- (</span>N mod <span class="num">8</span><span class="sym">))}</span>
        PRINT <span class="sym">:=</span> <span class="kwa">true</span>
      <span class="kwa">end</span>

      <span class="kwa">if</span> <span class="sym">&#64;</span>PRINT <span class="kwa">then</span>
        <span class="sym">{</span>STDOUT putC<span class="sym">(&#64;</span>ByteAcc<span class="sym">)}</span>
        ByteAcc <span class="sym">:=</span> <span class="num">0</span> BitNum <span class="sym">:=</span> <span class="num">0</span> PRINT <span class="sym">:=</span> <span class="kwa">false</span>
      <span class="kwa">end</span>

    <span class="kwa">end</span>
  <span class="kwa">end</span>

  <span class="sym">{</span>Application<span class="sym">.</span>exit <span class="num">0</span><span class="sym">}</span>
<span class="kwa">end</span>

