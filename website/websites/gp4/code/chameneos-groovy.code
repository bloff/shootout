<span class="hl com">/*</span>
<span class="hl com">	The Computer Language Shootout</span>
<span class="hl com">	http://shootout.alioth.debian.org/</span>
<span class="hl com"></span>
<span class="hl com">	contributed by Jochen Hinrichsen</span>
<span class="hl com">	modified by</span>
<span class="hl com"></span>
<span class="hl com">	For a description of the benchmark, check Chameneos.pdf</span>
<span class="hl com">*/</span>

<span class="hl kwc">class</span> Colour <span class="hl sym">{</span>

    <span class="hl kwb">static</span> <span class="hl kwc">public</span> blue		<span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Colour</span><span class="hl sym">(</span>colour<span class="hl sym">:</span><span class="hl str">&quot;blue&quot;</span><span class="hl sym">)</span>
    <span class="hl kwb">static</span> <span class="hl kwc">public</span> faded		<span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Colour</span><span class="hl sym">(</span>colour<span class="hl sym">:</span><span class="hl str">&quot;faded&quot;</span><span class="hl sym">)</span>
    <span class="hl kwb">static</span> <span class="hl kwc">public</span> red		<span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Colour</span><span class="hl sym">(</span>colour<span class="hl sym">:</span><span class="hl str">&quot;red&quot;</span><span class="hl sym">)</span>
    <span class="hl kwb">static</span> <span class="hl kwc">public</span> yellow	<span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Colour</span><span class="hl sym">(</span>colour<span class="hl sym">:</span><span class="hl str">&quot;yellow&quot;</span><span class="hl sym">)</span>

	&#64;Property colour

	<span class="hl slc">// == operator</span>
	<span class="hl kwc">public</span> <span class="hl kwd">isCase</span><span class="hl sym">(</span>Object c<span class="hl sym">) {</span>
		colour <span class="hl sym">==</span> c<span class="hl sym">.</span>colour
	<span class="hl sym">}</span>

	<span class="hl slc">// don't use arithmetic</span>
	<span class="hl slc">// use if-else or switch/case or pattern-match</span>
	<span class="hl kwc">public</span> Colour <span class="hl kwd">complement</span><span class="hl sym">(</span>Colour other<span class="hl sym">) {</span>
		<span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwa">this</span> <span class="hl sym">==</span> other<span class="hl sym">)</span> <span class="hl kwa">return this</span>

		def c <span class="hl sym">=</span> <span class="hl kwa">this</span>
		<span class="hl kwa">switch</span> <span class="hl sym">(</span><span class="hl kwa">this</span><span class="hl sym">) {</span>
			<span class="hl kwa">case</span> blue<span class="hl sym">:</span>		c <span class="hl sym">= (</span> other <span class="hl sym">==</span> Colour<span class="hl sym">.</span>red  ? Colour<span class="hl sym">.</span>yellow <span class="hl sym">:</span> Colour<span class="hl sym">.</span>red<span class="hl sym">)</span>
			<span class="hl kwa">case</span> red<span class="hl sym">:</span>		c <span class="hl sym">= (</span> other <span class="hl sym">==</span> Colour<span class="hl sym">.</span>blue ? Colour<span class="hl sym">.</span>yellow <span class="hl sym">:</span> Colour<span class="hl sym">.</span>blue<span class="hl sym">)</span>
         	<span class="hl kwa">case</span> yellow<span class="hl sym">:</span>	c <span class="hl sym">= (</span> other <span class="hl sym">==</span> Colour<span class="hl sym">.</span>blue ? Colour<span class="hl sym">.</span>red    <span class="hl sym">:</span> Colour<span class="hl sym">.</span>blue<span class="hl sym">)</span>
      	<span class="hl sym">}</span>
	  	<span class="hl kwa">return</span> c
	<span class="hl sym">}</span>

	<span class="hl kwc">public</span> String <span class="hl kwd">toString</span><span class="hl sym">() {</span>
		<span class="hl kwa">return</span> colour
	<span class="hl sym">}</span>

<span class="hl sym">}</span>

assert Colour<span class="hl sym">.</span>yellow<span class="hl sym">.</span><span class="hl kwd">complement</span><span class="hl sym">(</span>Colour<span class="hl sym">.</span>blue<span class="hl sym">) ==</span> Colour<span class="hl sym">.</span>red

<span class="hl kwc">class</span> Mall <span class="hl sym">{</span>

    &#64;Property AColour<span class="hl sym">,</span> BColour
    &#64;Property FirstCall <span class="hl sym">=</span> <span class="hl kwa">true</span>
    &#64;Property MustWait <span class="hl sym">=</span> <span class="hl kwa">false</span>

	&#64;Property maxMeetings <span class="hl sym">=</span> <span class="hl num">100</span>

    <span class="hl kwc">public</span> synchronized Colour <span class="hl kwd">Cooperation</span><span class="hl sym">(</span>id<span class="hl sym">,</span> Colour c<span class="hl sym">) {</span>
        def other <span class="hl sym">=</span> c
        <span class="hl kwa">while</span> <span class="hl sym">(</span>MustWait<span class="hl sym">) {</span> <span class="hl kwa">try</span> <span class="hl sym">{</span> <span class="hl kwd">wait</span> <span class="hl sym">() }</span> <span class="hl kwa">catch</span> <span class="hl sym">(</span>InterruptedException e<span class="hl sym">) {} }</span>

        <span class="hl kwa">if</span> <span class="hl sym">(</span>FirstCall<span class="hl sym">) {</span>
			<span class="hl kwa">if</span> <span class="hl sym">(</span>maxMeetings<span class="hl sym">-- &gt;</span> <span class="hl num">0</span><span class="hl sym">) {</span>
	            AColour <span class="hl sym">=</span> c
				FirstCall <span class="hl sym">=</span> <span class="hl kwa">false</span>
				<span class="hl kwa">while</span> <span class="hl sym">(!</span>FirstCall<span class="hl sym">) {</span> <span class="hl kwa">try</span> <span class="hl sym">{</span> <span class="hl kwd">wait</span> <span class="hl sym">() }</span> <span class="hl kwa">catch</span> <span class="hl sym">(</span>InterruptedException e<span class="hl sym">) {} }</span>
				MustWait <span class="hl sym">=</span> <span class="hl kwa">false</span>
				other <span class="hl sym">=</span> BColour
			 <span class="hl sym">}</span> <span class="hl kwa">else</span> <span class="hl sym">{</span>
			 	<span class="hl slc">// Thread termination condition</span>
				other <span class="hl sym">=</span> Colour<span class="hl sym">.</span>faded
			<span class="hl sym">}</span>
        <span class="hl sym">}</span> <span class="hl kwa">else</span> <span class="hl sym">{</span>
            BColour <span class="hl sym">=</span> c
            FirstCall <span class="hl sym">=</span> <span class="hl kwa">true</span>
            MustWait <span class="hl sym">=</span> <span class="hl kwa">true</span>
            other <span class="hl sym">=</span> AColour
        <span class="hl sym">}</span>
		assert other <span class="hl sym">!=</span> null
        <span class="hl kwd">notifyAll</span><span class="hl sym">()</span>
        <span class="hl kwa">return</span> other
    <span class="hl sym">}</span>

<span class="hl sym">}</span>

<span class="hl kwc">class</span> AChameneos extends Thread <span class="hl sym">{</span>

    &#64;Property Mall mall
    &#64;Property id
    &#64;Property Colour myColour<span class="hl sym">,</span> otherColour
	&#64;Property meetings <span class="hl sym">=</span> <span class="hl num">0</span>

    <span class="hl kwc">private</span> <span class="hl kwb">void</span> <span class="hl kwd">Mutating</span><span class="hl sym">() {</span>
        otherColour <span class="hl sym">=</span> mall<span class="hl sym">.</span><span class="hl kwd">Cooperation</span><span class="hl sym">(</span>id<span class="hl sym">,</span> myColour<span class="hl sym">)</span>
		<span class="hl kwa">if</span> <span class="hl sym">(</span>otherColour <span class="hl sym">==</span> Colour<span class="hl sym">.</span>faded<span class="hl sym">) {</span>
			myColour <span class="hl sym">=</span> otherColour<span class="hl sym">;</span>
		<span class="hl sym">}</span> <span class="hl kwa">else</span> <span class="hl sym">{</span>
			meetings<span class="hl sym">++</span>
        	myColour <span class="hl sym">=</span> myColour<span class="hl sym">.</span><span class="hl kwd">complement</span><span class="hl sym">(</span>otherColour<span class="hl sym">)</span>
		<span class="hl sym">}</span>
    <span class="hl sym">}</span>

    <span class="hl kwc">public</span> <span class="hl kwb">void</span> <span class="hl kwd">run</span><span class="hl sym">() {</span>
        <span class="hl kwa">while</span><span class="hl sym">(</span>myColour <span class="hl sym">!=</span> Colour<span class="hl sym">.</span>faded<span class="hl sym">) {</span>
	        <span class="hl slc">// EatingHoneysuckleAndTraining()</span>
   	      	<span class="hl slc">// GoingToTheMall()</span>
   	       	<span class="hl kwd">Mutating</span><span class="hl sym">()</span>
        <span class="hl sym">}</span>
    <span class="hl sym">}</span>
<span class="hl sym">}</span>

def N <span class="hl sym">= (</span>args<span class="hl sym">.</span>length <span class="hl sym">==</span> <span class="hl num">0</span><span class="hl sym">)</span> ? <span class="hl num">10000</span> <span class="hl sym">:</span> args<span class="hl sym">[</span><span class="hl num">0</span><span class="hl sym">].</span><span class="hl kwd">toInteger</span><span class="hl sym">()</span>
def colours <span class="hl sym">= [</span>
	Colour<span class="hl sym">.</span>blue<span class="hl sym">,</span>
	Colour<span class="hl sym">.</span>red<span class="hl sym">,</span>
	Colour<span class="hl sym">.</span>yellow<span class="hl sym">,</span>
	Colour<span class="hl sym">.</span>blue<span class="hl sym">,</span>
<span class="hl sym">]</span>

def chameneos <span class="hl sym">= []</span>
def myMall <span class="hl sym">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Mall</span><span class="hl sym">(</span>maxMeetings<span class="hl sym">:</span> N<span class="hl sym">)</span>
def i <span class="hl sym">=</span> <span class="hl num">0</span>
colours<span class="hl sym">.</span><span class="hl kwd">each</span><span class="hl sym">() {</span> colour <span class="hl sym">-&gt;</span>
    chameneos <span class="hl sym">+=</span> <span class="hl kwa">new</span> <span class="hl kwd">AChameneos</span><span class="hl sym">(</span>mall<span class="hl sym">:</span>myMall<span class="hl sym">,</span> id<span class="hl sym">:</span>i<span class="hl sym">++,</span> myColour<span class="hl sym">:</span>colour<span class="hl sym">)</span>
<span class="hl sym">}</span>

chameneos<span class="hl sym">.</span><span class="hl kwd">each</span><span class="hl sym">() {</span>
	it<span class="hl sym">.</span><span class="hl kwd">start</span><span class="hl sym">()</span>
<span class="hl sym">}</span>

chameneos<span class="hl sym">.</span><span class="hl kwd">each</span><span class="hl sym">() {</span>
	it<span class="hl sym">.</span><span class="hl kwd">join</span><span class="hl sym">()</span>
<span class="hl sym">}</span>

<span class="hl slc">// Count total meetings</span>
def total <span class="hl sym">=</span> chameneos<span class="hl sym">.</span><span class="hl kwd">inject</span><span class="hl sym">(</span><span class="hl num">0</span><span class="hl sym">) {</span> sum<span class="hl sym">,</span> it <span class="hl sym">-&gt;</span>
	sum <span class="hl sym">+=</span> it<span class="hl sym">.</span>meetings
<span class="hl sym">}</span>

println total
assert total <span class="hl sym">==</span> <span class="hl num">2</span> <span class="hl sym">*</span> N

<span class="hl slc">// EOF</span>

