<span class="com">(* The Computer Language Benchmarks Game</span>
<span class="com">   http://shootout.alioth.debian.org/</span>
<span class="com">   contributed by Isaac Gouy</span>
<span class="com">*)</span>

<span class="com">(* SPLITFILE=nbody.znn *)</span>

module nbody<span class="sym">;</span>
import
   JovianBodies as B<span class="sym">,</span>
   System<span class="sym">.</span>Math as M<span class="sym">,</span>
   System<span class="sym">.</span>Console<span class="sym">;</span>


type <span class="sym">{</span>ref<span class="sym">}</span> NBodySystem <span class="sym">=</span> object
   var b<span class="sym">:</span> array <span class="num">5</span> of B<span class="sym">.</span>Body<span class="sym">;</span>

   procedure <span class="sym">{</span>public<span class="sym">}</span> <span class="kwd">OffsetMomentum</span><span class="sym">();</span>
   var
      px<span class="sym">,</span> py<span class="sym">,</span> pz<span class="sym">:</span> real<span class="sym">;</span>
      i<span class="sym">:</span> integer<span class="sym">;</span>
   begin
      for i <span class="sym">:=</span> <span class="num">0</span> to <span class="kwd">len</span><span class="sym">(</span>b<span class="sym">)-</span><span class="num">1</span> do
         px <span class="sym">:=</span> px <span class="sym">+ (</span>b<span class="sym">[</span>i<span class="sym">].</span>vx <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>mass<span class="sym">);</span>
         py <span class="sym">:=</span> py <span class="sym">+ (</span>b<span class="sym">[</span>i<span class="sym">].</span>vy <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>mass<span class="sym">);</span>
         pz <span class="sym">:=</span> pz <span class="sym">+ (</span>b<span class="sym">[</span>i<span class="sym">].</span>vz <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>mass<span class="sym">);</span>
      end<span class="sym">;</span>
      b<span class="sym">[</span><span class="num">0</span><span class="sym">].</span><span class="kwd">OffsetMomentum</span><span class="sym">(</span>px<span class="sym">,</span>py<span class="sym">,</span>pz<span class="sym">);</span>
   end OffsetMomentum<span class="sym">;</span>

   procedure <span class="sym">{</span>public<span class="sym">}</span> <span class="kwd">Advance</span><span class="sym">(</span>dt<span class="sym">:</span> real<span class="sym">);</span>
   var
      dx<span class="sym">,</span> dy<span class="sym">,</span> dz<span class="sym">,</span> distance<span class="sym">,</span> mag<span class="sym">:</span> real<span class="sym">;</span>
      i<span class="sym">,</span> j<span class="sym">,</span> n<span class="sym">:</span> integer<span class="sym">;</span>
   begin
      n <span class="sym">:=</span> <span class="kwd">len</span><span class="sym">(</span>b<span class="sym">) -</span> <span class="num">1</span><span class="sym">;</span>
      for i <span class="sym">:=</span> <span class="num">0</span> to n do
         for j <span class="sym">:=</span> i<span class="sym">+</span><span class="num">1</span> to n do
            dx <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>x <span class="sym">-</span> b<span class="sym">[</span>j<span class="sym">].</span>x<span class="sym">;</span>
            dy <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>y <span class="sym">-</span> b<span class="sym">[</span>j<span class="sym">].</span>y<span class="sym">;</span>
            dz <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>z <span class="sym">-</span> b<span class="sym">[</span>j<span class="sym">].</span>z<span class="sym">;</span>

            distance <span class="sym">:=</span> M<span class="sym">.</span><span class="kwd">Sqrt</span><span class="sym">(</span>dx<span class="sym">*</span>dx <span class="sym">+</span> dy<span class="sym">*</span>dy <span class="sym">+</span> dz<span class="sym">*</span>dz<span class="sym">);</span>
            mag <span class="sym">:=</span> dt <span class="sym">/ (</span>distance <span class="sym">*</span> distance <span class="sym">*</span> distance<span class="sym">);</span>

            b<span class="sym">[</span>i<span class="sym">].</span>vx <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>vx <span class="sym">- (</span>dx <span class="sym">*</span> b<span class="sym">[</span>j<span class="sym">].</span>mass <span class="sym">*</span> mag<span class="sym">);</span>
            b<span class="sym">[</span>i<span class="sym">].</span>vy <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>vy <span class="sym">- (</span>dy <span class="sym">*</span> b<span class="sym">[</span>j<span class="sym">].</span>mass <span class="sym">*</span> mag<span class="sym">);</span>
            b<span class="sym">[</span>i<span class="sym">].</span>vz <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>vz <span class="sym">- (</span>dz <span class="sym">*</span> b<span class="sym">[</span>j<span class="sym">].</span>mass <span class="sym">*</span> mag<span class="sym">);</span>

            b<span class="sym">[</span>j<span class="sym">].</span>vx <span class="sym">:=</span> b<span class="sym">[</span>j<span class="sym">].</span>vx <span class="sym">+ (</span>dx <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>mass <span class="sym">*</span> mag<span class="sym">);</span>
            b<span class="sym">[</span>j<span class="sym">].</span>vy <span class="sym">:=</span> b<span class="sym">[</span>j<span class="sym">].</span>vy <span class="sym">+ (</span>dy <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>mass <span class="sym">*</span> mag<span class="sym">);</span>
            b<span class="sym">[</span>j<span class="sym">].</span>vz <span class="sym">:=</span> b<span class="sym">[</span>j<span class="sym">].</span>vz <span class="sym">+ (</span>dz <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>mass <span class="sym">*</span> mag<span class="sym">);</span>
         end<span class="sym">;</span>
      end<span class="sym">;</span>

      for i <span class="sym">:=</span> <span class="num">0</span> to n do
         b<span class="sym">[</span>i<span class="sym">].</span>x <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>x <span class="sym">+ (</span>dt <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>vx<span class="sym">);</span>
         b<span class="sym">[</span>i<span class="sym">].</span>y <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>y <span class="sym">+ (</span>dt <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>vy<span class="sym">);</span>
         b<span class="sym">[</span>i<span class="sym">].</span>z <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>z <span class="sym">+ (</span>dt <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>vz<span class="sym">);</span>
      end<span class="sym">;</span>
   end Advance<span class="sym">;</span>

   procedure <span class="sym">{</span>public<span class="sym">}</span> <span class="kwd">Energy</span><span class="sym">():</span> real<span class="sym">;</span>
   var
      e<span class="sym">,</span> dx<span class="sym">,</span> dy<span class="sym">,</span> dz<span class="sym">,</span> distance<span class="sym">:</span> real<span class="sym">;</span>
      i<span class="sym">,</span> j<span class="sym">,</span> n<span class="sym">:</span> integer<span class="sym">;</span>
   begin
      e <span class="sym">:=</span> <span class="num">0.0</span><span class="sym">;</span>
      n <span class="sym">:=</span> <span class="kwd">len</span><span class="sym">(</span>b<span class="sym">) -</span> <span class="num">1</span><span class="sym">;</span>
      for i <span class="sym">:=</span> <span class="num">0</span> to n do
         e <span class="sym">:=</span> e <span class="sym">+ (</span><span class="num">0.5</span> <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>mass <span class="sym">*</span>
            <span class="sym">(</span> b<span class="sym">[</span>i<span class="sym">].</span>vx <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>vx
            <span class="sym">+</span> b<span class="sym">[</span>i<span class="sym">].</span>vy <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>vy
            <span class="sym">+</span> b<span class="sym">[</span>i<span class="sym">].</span>vz <span class="sym">*</span> b<span class="sym">[</span>i<span class="sym">].</span>vz <span class="sym">));</span>

         for j <span class="sym">:=</span> i<span class="sym">+</span><span class="num">1</span> to n do
            dx <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>x <span class="sym">-</span> b<span class="sym">[</span>j<span class="sym">].</span>x<span class="sym">;</span>
            dy <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>y <span class="sym">-</span> b<span class="sym">[</span>j<span class="sym">].</span>y<span class="sym">;</span>
            dz <span class="sym">:=</span> b<span class="sym">[</span>i<span class="sym">].</span>z <span class="sym">-</span> b<span class="sym">[</span>j<span class="sym">].</span>z<span class="sym">;</span>

            distance <span class="sym">:=</span> M<span class="sym">.</span><span class="kwd">Sqrt</span><span class="sym">(</span>dx<span class="sym">*</span>dx <span class="sym">+</span> dy<span class="sym">*</span>dy <span class="sym">+</span> dz<span class="sym">*</span>dz<span class="sym">);</span>
            e <span class="sym">:=</span> e <span class="sym">- (</span>b<span class="sym">[</span>i<span class="sym">].</span>mass <span class="sym">*</span> b<span class="sym">[</span>j<span class="sym">].</span>mass <span class="sym">/</span> distance<span class="sym">);</span>
         end<span class="sym">;</span>
      end<span class="sym">;</span>
      return e<span class="sym">;</span>
   end Energy<span class="sym">;</span>

begin
   b<span class="sym">[</span><span class="num">0</span><span class="sym">] :=</span> B<span class="sym">.</span>Sun<span class="sym">;</span>
   b<span class="sym">[</span><span class="num">1</span><span class="sym">] :=</span> B<span class="sym">.</span>Jupiter<span class="sym">;</span>
   b<span class="sym">[</span><span class="num">2</span><span class="sym">] :=</span> B<span class="sym">.</span>Saturn<span class="sym">;</span>
   b<span class="sym">[</span><span class="num">3</span><span class="sym">] :=</span> B<span class="sym">.</span>Uranus<span class="sym">;</span>
   b<span class="sym">[</span><span class="num">4</span><span class="sym">] :=</span> B<span class="sym">.</span>Neptune<span class="sym">;</span>
end NBodySystem<span class="sym">;</span>


procedure <span class="kwd">writex</span><span class="sym">(</span>x<span class="sym">:</span>real<span class="sym">);</span> begin System<span class="sym">.</span>Console<span class="sym">.</span><span class="kwd">Write</span><span class="sym">(</span><span class="str">&quot;{0:f9}&quot;</span><span class="sym">,</span>x<span class="sym">);</span> end writex<span class="sym">;</span>

const n <span class="sym">=</span> <span class="num">200000</span><span class="sym">;</span>
var
   bodies<span class="sym">:</span> NBodySystem<span class="sym">;</span>
   i<span class="sym">:</span> integer<span class="sym">;</span>
begin
   bodies <span class="sym">:=</span> new <span class="kwd">NBodySystem</span><span class="sym">();</span>
   bodies<span class="sym">.</span><span class="kwd">OffsetMomentum</span><span class="sym">();</span>

   <span class="kwd">writex</span><span class="sym">(</span> bodies<span class="sym">.</span><span class="kwd">Energy</span><span class="sym">() );</span> writeln<span class="sym">;</span>
   for i <span class="sym">:=</span> <span class="num">1</span> to n do bodies<span class="sym">.</span><span class="kwd">Advance</span><span class="sym">(</span><span class="num">0.01</span><span class="sym">);</span> end<span class="sym">;</span>
   <span class="kwd">writex</span><span class="sym">(</span> bodies<span class="sym">.</span><span class="kwd">Energy</span><span class="sym">() );</span> writeln<span class="sym">;</span>

end nbody<span class="sym">.</span>


<span class="com">(* SPLITFILE=JovianBodies.znn *)</span>

module JovianBodies<span class="sym">;</span>

const PI <span class="sym">=</span> <span class="num">3.141592653589793</span><span class="sym">;</span>
const SOLAR_MASS <span class="sym">=</span> <span class="num">4</span> <span class="sym">*</span> PI <span class="sym">*</span> PI<span class="sym">;</span>
const DAYS_PER_YEAR <span class="sym">=</span> <span class="num">365.24</span><span class="sym">;</span>

type <span class="sym">{</span>public<span class="sym">,</span>ref<span class="sym">}</span> Body <span class="sym">=</span> object
   var <span class="sym">{</span>public<span class="sym">}</span> x<span class="sym">,</span> y<span class="sym">,</span> z<span class="sym">,</span> vx<span class="sym">,</span> vy<span class="sym">,</span> vz<span class="sym">,</span> mass<span class="sym">:</span> real<span class="sym">;</span>

   procedure <span class="sym">{</span>public<span class="sym">}</span> <span class="kwd">OffsetMomentum</span><span class="sym">(</span>px<span class="sym">,</span> py<span class="sym">,</span> pz<span class="sym">:</span> real<span class="sym">);</span>
      begin
         vx <span class="sym">:= -</span><span class="num">1.0</span> <span class="sym">*</span> px <span class="sym">/</span> SOLAR_MASS<span class="sym">;</span>
         vy <span class="sym">:= -</span><span class="num">1.0</span> <span class="sym">*</span> py <span class="sym">/</span> SOLAR_MASS<span class="sym">;</span>
         vz <span class="sym">:= -</span><span class="num">1.0</span> <span class="sym">*</span> pz <span class="sym">/</span> SOLAR_MASS<span class="sym">;</span>
      end OffsetMomentum<span class="sym">;</span>
end Body<span class="sym">;</span>


var <span class="sym">{</span>public<span class="sym">}</span> Jupiter<span class="sym">,</span> Saturn<span class="sym">,</span> Uranus<span class="sym">,</span> Neptune<span class="sym">,</span> Sun<span class="sym">:</span> Body<span class="sym">;</span>

begin
   Jupiter <span class="sym">:=</span> new <span class="kwd">Body</span><span class="sym">();</span>
   Jupiter<span class="sym">.</span>x <span class="sym">:=</span> <span class="num">4.84143144246472090E+00</span><span class="sym">;</span>
   Jupiter<span class="sym">.</span>y <span class="sym">:= -</span><span class="num">1.16032004402742839E+00</span><span class="sym">;</span>
   Jupiter<span class="sym">.</span>z <span class="sym">:= -</span><span class="num">1.03622044471123109E-01</span><span class="sym">;</span>
   Jupiter<span class="sym">.</span>vx <span class="sym">:=</span> <span class="num">1.66007664274403694E-03</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Jupiter<span class="sym">.</span>vy <span class="sym">:=</span> <span class="num">7.69901118419740425E-03</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Jupiter<span class="sym">.</span>vz <span class="sym">:= -</span><span class="num">6.90460016972063023E-05</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Jupiter<span class="sym">.</span>mass <span class="sym">:=</span> <span class="num">9.54791938424326609E-04</span> <span class="sym">*</span> SOLAR_MASS<span class="sym">;</span>

   Saturn <span class="sym">:=</span> new <span class="kwd">Body</span><span class="sym">();</span>
   Saturn<span class="sym">.</span>x <span class="sym">:=</span> <span class="num">8.34336671824457987E+00</span><span class="sym">;</span>
   Saturn<span class="sym">.</span>y <span class="sym">:=</span> <span class="num">4.12479856412430479E+00</span><span class="sym">;</span>
   Saturn<span class="sym">.</span>z <span class="sym">:= -</span><span class="num">4.03523417114321381E-01</span><span class="sym">;</span>
   Saturn<span class="sym">.</span>vx <span class="sym">:= -</span><span class="num">2.76742510726862411E-03</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Saturn<span class="sym">.</span>vy <span class="sym">:=</span> <span class="num">4.99852801234917238E-03</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Saturn<span class="sym">.</span>vz <span class="sym">:=</span> <span class="num">2.30417297573763929E-05</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Saturn<span class="sym">.</span>mass <span class="sym">:=</span> <span class="num">2.85885980666130812E-04</span> <span class="sym">*</span> SOLAR_MASS<span class="sym">;</span>

   Uranus <span class="sym">:=</span> new <span class="kwd">Body</span><span class="sym">();</span>
   Uranus<span class="sym">.</span>x <span class="sym">:=</span> <span class="num">1.28943695621391310E+01</span><span class="sym">;</span>
   Uranus<span class="sym">.</span>y <span class="sym">:= -</span><span class="num">1.51111514016986312E+01</span><span class="sym">;</span>
   Uranus<span class="sym">.</span>z <span class="sym">:= -</span><span class="num">2.23307578892655734E-01</span><span class="sym">;</span>
   Uranus<span class="sym">.</span>vx <span class="sym">:=</span> <span class="num">2.96460137564761618E-03</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Uranus<span class="sym">.</span>vy <span class="sym">:=</span> <span class="num">2.37847173959480950E-03</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Uranus<span class="sym">.</span>vz <span class="sym">:= -</span><span class="num">2.96589568540237556E-05</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Uranus<span class="sym">.</span>mass <span class="sym">:=</span> <span class="num">4.36624404335156298E-05</span> <span class="sym">*</span> SOLAR_MASS<span class="sym">;</span>

   Neptune <span class="sym">:=</span> new <span class="kwd">Body</span><span class="sym">();</span>
   Neptune<span class="sym">.</span>x <span class="sym">:=</span> <span class="num">1.53796971148509165E+01</span><span class="sym">;</span>
   Neptune<span class="sym">.</span>y <span class="sym">:= -</span><span class="num">2.59193146099879641E+01</span><span class="sym">;</span>
   Neptune<span class="sym">.</span>z <span class="sym">:=</span> <span class="num">1.79258772950371181E-01</span><span class="sym">;</span>
   Neptune<span class="sym">.</span>vx <span class="sym">:=</span> <span class="num">2.68067772490389322E-03</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Neptune<span class="sym">.</span>vy <span class="sym">:=</span> <span class="num">1.62824170038242295E-03</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Neptune<span class="sym">.</span>vz <span class="sym">:= -</span><span class="num">9.51592254519715870E-05</span> <span class="sym">*</span> DAYS_PER_YEAR<span class="sym">;</span>
   Neptune<span class="sym">.</span>mass <span class="sym">:=</span> <span class="num">5.15138902046611451E-05</span> <span class="sym">*</span> SOLAR_MASS<span class="sym">;</span>

   Sun <span class="sym">:=</span> new <span class="kwd">Body</span><span class="sym">();</span>
   Sun<span class="sym">.</span>mass <span class="sym">:=</span> SOLAR_MASS<span class="sym">;</span>

end JovianBodies<span class="sym">.</span>
