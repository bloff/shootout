<source>
<def></def><com>(*</com><br />
<com> * The Computer Language Benchmarks Game</com><br />
<com> * http://shootout.alioth.debian.org/</com><br />
<com> * contributed by kaustuv Chaudhuri</com><br />
<com> *)</com><def></def><br />
<br />
<kwa>fun</kwa> <def>setup nThreads N</def> <sym>=</sym><br />
<def></def>    <kwa>let</kwa><br />
<def></def>      <kwa>val</kwa> <def>res</def> <sym>=</sym> <def>CML.channel</def> <sym>()</sym><br />
<def></def><br />
      <kwa>fun</kwa> <def>ringT</def> <sym>((</sym><def>inn</def><sym>,</sym> <def>inc</def><sym>), (</sym><def>oun</def><sym>,</sym> <def>ouc</def><sym>)) =</sym><br />
<def></def>          <kwa>let</kwa><br />
<def></def>            <kwa>fun</kwa> <def>loop</def> <sym>() =</sym><br />
<def></def>                <sym>(</sym><def></def><kwa>case</kwa> <def>CML.recv inc</def> <kwa>of</kwa><br />
<def></def>                   <num>0</num> <def></def><sym>=&gt;</sym> <def>CML.send</def> <sym>(</sym><def>res</def><sym>,</sym> <def>inn</def><sym>)</sym><br />
<def></def>                 <sym>|</sym> <def>n</def> <sym>=&gt; (</sym><def>CML.send</def> <sym>(</sym><def>ouc</def><sym>,</sym> <def>n</def> <sym>-</sym> <def></def><num>1</num><def></def><sym>);</sym><br />
<def>                         loop</def> <sym>()))</sym><br />
<def></def>          <kwa>in</kwa><br />
<def>            CML.spawn loop</def><br />
          <kwa>end</kwa><br />
<def></def><br />
      <kwa>val</kwa> <def>chans</def> <kwa>as</kwa> <def>c0</def> <sym>::</sym> <def>c1s</def> <sym>=</sym><br />
<def></def>            <kwa>List</kwa><def>.tabulate</def> <sym>(</sym><def>nThreads</def><sym>,</sym> <def></def><kwa>fn</kwa> <def>n</def> <sym>=&gt; (</sym><def>n</def> <sym>+</sym> <def></def><num>1</num><def></def><sym>,</sym> <def>CML.channel</def> <sym>()))</sym><br />
<def></def><br />
      <kwa>val</kwa> <def>threads</def> <sym>=</sym> <def></def><kwa>ListPair</kwa><def>.map ringT</def> <sym>(</sym><def>chans</def><sym>,</sym> <def>c1s @</def> <sym>[</sym><def>c0</def><sym>])</sym><br />
<def></def>    <kwa>in</kwa><br />
<def>      CML.send</def> <sym>(</sym><def>#</def><num>2</num> <def>c0</def><sym>,</sym> <def>N</def><sym>);</sym><br />
<def></def>      <kwa>TextIO</kwa><def>.print</def> <sym>(</sym><def></def><kwa>Int</kwa><def>.toString</def> <sym>(</sym><def>CML.recv res</def><sym>)</sym> <def>^</def> <str>&quot;</str><esc>\n</esc><str>&quot;</str><def></def><sym>)</sym><br />
<def></def>    <kwa>end</kwa><br />
<def></def><br />
<kwa>fun</kwa> <def>doit N</def> <sym>=</sym> <def>RunCML.doit</def> <sym>(</sym><def></def><kwa>fn</kwa> <def></def><sym>() =&gt;</sym> <def>setup</def> <num>503</num> <def>N</def><sym>,</sym> <def>NONE</def><sym>)</sym><br />
<def></def><br />
<kwa>val</kwa> <def>_</def> <sym>= (</sym><def>doit</def> <kwa>o</kwa> <def>Option.valOf</def> <kwa>o Int</kwa><def>.fromString</def> <kwa>o List</kwa><def>.hd</def> <kwa>o</kwa> <def>CommandLine.arguments</def><sym>) ()</sym><def></def><br />
</source>
