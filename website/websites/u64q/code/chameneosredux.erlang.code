<source>
<def></def><slc>%%% The Computer Language Benchmarks Game</slc><br />
<def></def><slc>%%% http://shootout.alioth.debian.org/</slc><br />
<def></def><slc>%%% contributed by Christian von Roques</slc><br />
<def></def><br />
<slc>%% Compile: erlc +native +&quot;{hipe, [o3]}&quot; chameneos_redux.erl</slc><br />
<def></def><slc>%% Run: erl -noinput -noshell -run chameneos_redux main 600</slc><br />
<def></def><br />
<slc>%% Each chameneos is its own process.</slc><br />
<def></def><slc>%% A chameneos sends {self(), Color} to the broker to request a</slc><br />
<def></def><slc>%% meeting with another chameneos.</slc><br />
<def></def><slc>%% The broker replies with {Pid, Color} of the partner met or 'stop'</slc><br />
<def></def><slc>%% whereupon the chameneos prints the Meetings and Selfmeetings it had</slc><br />
<def></def><slc>%% and replies with the number of Meetings for the broker to sum.</slc><br />
<def></def><br />
<sym>-</sym><def></def><kwa>module</kwa><def></def><sym>(</sym><def>chameneosredux</def><sym>).</sym><br />
<def></def><sym>-</sym><def></def><kwa>export</kwa><def></def><sym>([</sym><def>main</def><sym>/</sym><def></def><num>1</num><def></def><sym>]).</sym><br />
<def></def><br />
<sym>-</sym><def></def><kwd>import</kwd><def></def><sym>(</sym><def>lists</def><sym>, [</sym><def>foreach</def><sym>/</sym><def></def><num>2</num><def></def><sym>]).</sym><br />
<def></def><br />
<kwd>spell</kwd><def></def><sym>(</sym><def></def><num>0</num><def></def><sym>) -&gt;</sym> <def></def><str>&quot; zero&quot;</str><def></def><sym>;</sym><br />
<def></def><kwd>spell</kwd><def></def><sym>(</sym><def>N</def><sym>) -&gt;</sym> <def></def><kwd>spell</kwd><def></def><sym>(</sym><def>N</def><sym>, []).</sym><br />
<def></def><br />
<kwd>spell</kwd><def></def><sym>(</sym><def></def><num>0</num><def></def><sym>,</sym> <def>L</def><sym>) -&gt;</sym> <def>L</def><sym>;</sym><br />
<def></def><kwd>spell</kwd><def></def><sym>(</sym><def>N</def><sym>,</sym> <def>L</def><sym>) -&gt;</sym> <def></def><kwd>spell</kwd><def></def><sym>(</sym><def>N</def> <kwa>div</kwa> <def></def><num>10</num><def></def><sym>, [</sym><def></def><kwb>element</kwb><def></def><sym>(</sym><def>N</def> <kwa>rem</kwa> <def></def><num>10</num> <def></def><sym>+</sym> <def></def><num>1</num><def></def><sym>, {</sym><def></def><str>&quot; zero&quot;</str><def></def><sym>,</sym> <def></def><str>&quot; one&quot;</str><def></def><sym>,</sym> <def></def><str>&quot; two&quot;</str><def></def><sym>,</sym> <def></def><str>&quot; three&quot;</str><def></def><sym>,</sym> <def></def><str>&quot; four&quot;</str><def></def><sym>,</sym> <def></def><str>&quot; five&quot;</str><def></def><sym>,</sym> <def></def><str>&quot; six&quot;</str><def></def><sym>,</sym> <def></def><str>&quot; seven&quot;</str><def></def><sym>,</sym> <def></def><str>&quot; eight&quot;</str><def></def><sym>,</sym> <def></def><str>&quot; nine&quot;</str><def></def><sym>}) |</sym> <def>L</def><sym>]).</sym><br />
<def></def><br />
<br />
<kwd>complement</kwd><def></def><sym>(</sym><def>C</def><sym>,</sym> <def>C</def><sym>) -&gt;</sym> <def>C</def><sym>;</sym><br />
<def></def><kwd>complement</kwd><def></def><sym>(</sym><def>blue</def><sym>,</sym> <def>red</def><sym>) -&gt;</sym> <def>yellow</def><sym>;</sym><br />
<def></def><kwd>complement</kwd><def></def><sym>(</sym><def>blue</def><sym>,</sym> <def>yellow</def><sym>) -&gt;</sym> <def>red</def><sym>;</sym><br />
<def></def><kwd>complement</kwd><def></def><sym>(</sym><def>red</def><sym>,</sym> <def>blue</def><sym>) -&gt;</sym> <def>yellow</def><sym>;</sym><br />
<def></def><kwd>complement</kwd><def></def><sym>(</sym><def>red</def><sym>,</sym> <def>yellow</def><sym>) -&gt;</sym> <def>blue</def><sym>;</sym><br />
<def></def><kwd>complement</kwd><def></def><sym>(</sym><def>yellow</def><sym>,</sym> <def>blue</def><sym>) -&gt;</sym> <def>red</def><sym>;</sym><br />
<def></def><kwd>complement</kwd><def></def><sym>(</sym><def>yellow</def><sym>,</sym> <def>red</def><sym>) -&gt;</sym> <def>blue</def><sym>.</sym><br />
<def></def><br />
<br />
<kwd>show_complements</kwd><def></def><sym>() -&gt;</sym><br />
<def></def>    <sym>[</sym> <def>io</def><sym>:</sym><def></def><kwd>fwrite</kwd><def></def><sym>(</sym><def></def><str>&quot;~p + ~p -&gt; ~p~n&quot;</str><def></def><sym>, [</sym><def>A</def><sym>,</sym> <def>B</def><sym>,</sym> <def></def><kwd>complement</kwd><def></def><sym>(</sym><def>A</def><sym>,</sym> <def>B</def><sym>)]) ||</sym><br />
<def>	A</def> <sym>&lt;- [</sym><def>blue</def><sym>,</sym> <def>red</def><sym>,</sym> <def>yellow</def><sym>],</sym><br />
<def>	B</def> <sym>&lt;- [</sym><def>blue</def><sym>,</sym> <def>red</def><sym>,</sym> <def>yellow</def><sym>]].</sym><br />
<def></def><br />
<br />
<kwd>run</kwd><def></def><sym>(</sym><def>L</def><sym>,</sym> <def>N</def><sym>) -&gt;</sym><br />
<def>    io</def><sym>:</sym><def></def><kwd>fwrite</kwd><def></def><sym>(</sym><def></def><str>&quot;~n&quot;</str><def></def><sym>),</sym><br />
<def>    Broker</def> <sym>=</sym> <def></def><kwb>self</kwb><def></def><sym>(),</sym><br />
<def></def>    <kwd>foreach</kwd><def></def><sym>(</sym><def></def><kwa>fun</kwa><def></def><sym>(</sym><def>Color</def><sym>) -&gt;</sym> <def></def><kwb>spawn</kwb><def></def><sym>(</sym><def></def><kwa>fun</kwa><def></def><sym>() -&gt;</sym> <def></def><kwd>chameneos</kwd><def></def><sym>(</sym><def>Broker</def><sym>,</sym> <def>Color</def><sym>)</sym> <def></def><kwa>end</kwa><def></def><sym>)</sym> <def></def><kwa>end</kwa><def></def><sym>,</sym> <def>L</def><sym>),</sym><br />
<def></def>    <kwd>broker</kwd><def></def><sym>(</sym><def>N</def><sym>),</sym><br />
<def>    io</def><sym>:</sym><def></def><kwd>fwrite</kwd><def></def><sym>(</sym><def></def><str>&quot;~n&quot;</str><def></def><sym>),</sym><br />
<def></def>    <kwd>cleanup</kwd><def></def><sym>(</sym><def></def><kwb>length</kwb><def></def><sym>(</sym><def>L</def><sym>),</sym> <def></def><num>0</num><def></def><sym>).</sym><br />
<def></def><br />
<br />
<kwd>chameneos</kwd><def></def><sym>(</sym><def>Broker</def><sym>,</sym> <def>Color</def><sym>) -&gt;</sym><br />
<def>    io</def><sym>:</sym><def></def><kwd>fwrite</kwd><def></def><sym>(</sym><def></def><str>&quot; ~p&quot;</str><def></def><sym>, [</sym><def>Color</def><sym>]),</sym><br />
<def></def>    <kwd>chameneos</kwd><def></def><sym>(</sym><def>Broker</def><sym>,</sym> <def>Color</def><sym>,</sym> <def></def><num>0</num><def></def><sym>,</sym> <def></def><num>0</num><def></def><sym>).</sym><br />
<def></def><br />
<kwd>chameneos</kwd><def></def><sym>(</sym><def>Broker</def><sym>,</sym> <def>Color</def><sym>,</sym> <def>Meetings</def><sym>,</sym> <def>MetSelf</def><sym>) -&gt;</sym><br />
<def>    Broker</def> <sym>! {</sym> <def></def><kwb>self</kwb><def></def><sym>(),</sym> <def>Color</def> <sym>},</sym><br />
<def></def>    <kwa>receive</kwa><br />
<def></def>	<sym>{</sym><def>OPid</def><sym>,</sym> <def>OColor</def><sym>} -&gt;</sym><br />
<def></def>	    <kwd>chameneos</kwd><def></def><sym>(</sym><def>Broker</def><sym>,</sym> <def></def><kwd>complement</kwd><def></def><sym>(</sym><def>Color</def><sym>,</sym> <def>OColor</def><sym>),</sym> <def>Meetings</def><sym>+</sym><def></def><num>1</num><def></def><sym>,</sym><br />
<def></def>		      <kwa>if</kwa> <def>OPid</def> <sym>==</sym> <def></def><kwb>self</kwb><def></def><sym>() -&gt;</sym> <def>MetSelf</def><sym>+</sym><def></def><num>1</num><def></def><sym>;</sym> <def>true</def> <sym>-&gt;</sym> <def>MetSelf</def> <kwa>end</kwa><def></def><sym>);</sym><br />
<def>	stop</def> <sym>-&gt;</sym><br />
<def>	    io</def><sym>:</sym><def></def><kwd>fwrite</kwd><def></def><sym>(</sym><def></def><str>&quot;~w~s</str><esc>\</esc><str>n&quot;</str><def></def><sym>, [</sym><def>Meetings</def><sym>,</sym> <def></def><kwd>spell</kwd><def></def><sym>(</sym><def>MetSelf</def><sym>)]),</sym><br />
<def>	    Broker</def> <sym>!</sym> <def>Meetings</def><br />
    <kwa>end</kwa><def></def><sym>.</sym><br />
<def></def><br />
<br />
<kwd>broker</kwd><def></def><sym>(</sym><def></def><num>0</num><def></def><sym>) -&gt;</sym> <def>nil</def><sym>;</sym><br />
<def></def><kwd>broker</kwd><def></def><sym>(</sym><def>N</def><sym>) -&gt;</sym><br />
<def></def>    <kwa>receive</kwa><br />
<def>	C1</def> <sym>= {</sym><def>Pid1</def><sym>,</sym> <def>_</def><sym>} -&gt;</sym> <def>nil</def><br />
    <kwa>end</kwa><def></def><sym>,</sym><br />
<def></def>    <kwa>receive</kwa><br />
<def>	C2</def> <sym>= {</sym><def>Pid2</def><sym>,</sym> <def>_</def><sym>} -&gt;</sym><br />
<def>	    Pid1</def> <sym>!</sym> <def>C2</def><sym>,</sym><br />
<def>	    Pid2</def> <sym>!</sym> <def>C1</def><sym>,</sym><br />
<def></def>	    <kwd>broker</kwd><def></def><sym>(</sym><def>N</def><sym>-</sym><def></def><num>1</num><def></def><sym>)</sym><br />
<def></def>    <kwa>end</kwa><def></def><sym>.</sym><br />
<def></def><br />
<kwd>cleanup</kwd><def></def><sym>(</sym><def></def><num>0</num><def></def><sym>,</sym> <def>M</def><sym>) -&gt;</sym> <def>io</def><sym>:</sym><def></def><kwd>fwrite</kwd><def></def><sym>(</sym><def></def><str>&quot;~s~n&quot;</str><def></def><sym>, [</sym><def></def><kwd>spell</kwd><def></def><sym>(</sym><def>M</def><sym>)]);</sym><br />
<def></def><kwd>cleanup</kwd><def></def><sym>(</sym><def>N</def><sym>,</sym> <def>M</def><sym>) -&gt;</sym><br />
<def></def>    <kwa>receive</kwa><br />
<def></def>	<sym>{</sym><def>Pid</def><sym>,</sym> <def>_Color</def><sym>} -&gt;</sym><br />
<def>	    Pid</def> <sym>!</sym> <def>stop</def><sym>,</sym><br />
<def></def>	    <kwd>cleanup</kwd><def></def><sym>(</sym><def>N</def><sym>,</sym> <def>M</def><sym>);</sym><br />
<def>	Meetings</def> <sym>-&gt;</sym><br />
<def></def>	    <kwd>cleanup</kwd><def></def><sym>(</sym><def>N</def><sym>-</sym><def></def><num>1</num><def></def><sym>,</sym> <def>M</def><sym>+</sym><def>Meetings</def><sym>)</sym><br />
<def></def>    <kwa>end</kwa><def></def><sym>.</sym><br />
<def></def><br />
<br />
<kwd>main</kwd><def></def><sym>([</sym><def>Arg</def><sym>]) -&gt;</sym><br />
<def>    N</def> <sym>=</sym> <def></def><kwb>list_to_integer</kwb><def></def><sym>(</sym><def>Arg</def><sym>),</sym><br />
<def></def>    <kwd>show_complements</kwd><def></def><sym>(),</sym><br />
<def></def>    <kwd>run</kwd><def></def><sym>([</sym><def>blue</def><sym>,</sym> <def>red</def><sym>,</sym> <def>yellow</def><sym>],</sym> <def>N</def><sym>),</sym><br />
<def></def>    <kwd>run</kwd><def></def><sym>([</sym><def>blue</def><sym>,</sym> <def>red</def><sym>,</sym> <def>yellow</def><sym>,</sym> <def>red</def><sym>,</sym> <def>yellow</def><sym>,</sym> <def>blue</def><sym>,</sym> <def>red</def><sym>,</sym> <def>yellow</def><sym>,</sym> <def>red</def><sym>,</sym> <def>blue</def><sym>],</sym> <def>N</def><sym>),</sym><br />
<def>    io</def><sym>:</sym><def></def><kwd>fwrite</kwd><def></def><sym>(</sym><def></def><str>&quot;~n&quot;</str><def></def><sym>),</sym><br />
<def></def>    <kwb>halt</kwb><def></def><sym>(</sym><def></def><num>0</num><def></def><sym>).</sym><def></def><br />
</source>
