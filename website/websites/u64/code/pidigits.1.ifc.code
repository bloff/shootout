<span class="hl slc">! -*- mode: f90 -*-</span>
<span class="hl slc">!</span>
<span class="hl slc">! $Id: pidigits.1.ifc.code,v 1.4 2009-04-27 18:00:38 igouy-guest Exp $ ; $Name:  $</span>
<span class="hl slc">!</span>
<span class="hl slc">! The Computer Language Shootout Benchmarks</span>
<span class="hl slc">! http://shootout.alioth.debian.org/</span>
<span class="hl slc">!</span>
<span class="hl slc">! contributed by Steve Decker</span>
<span class="hl slc">! compilation:</span>
<span class="hl slc">!    g95 -O3 -funroll-loops -fomit-frame-pointer pidigits.f90</span>
<span class="hl slc">!    ifort -O -ip pidigits.f90</span>

<span class="hl kwa">module</span> big_int_mod
  <span class="hl kwa">implicit none</span>
  <span class="hl kwa">save</span>

  <span class="hl kwb">integer</span><span class="hl sym">,</span> <span class="hl kwa">parameter</span><span class="hl sym">,</span> private <span class="hl sym">::</span> Pwr <span class="hl sym">=</span> <span class="hl num">15</span><span class="hl sym">,</span> Base <span class="hl sym">=</span> <span class="hl num">2</span><span class="hl sym">**</span>Pwr<span class="hl sym">,</span> maxDigs <span class="hl sym">=</span> <span class="hl num">2558</span>

  <span class="hl kwa">type</span> big_int
     private
     <span class="hl kwb">integer</span> <span class="hl sym">::</span> sigDigs
     <span class="hl kwb">logical</span> <span class="hl sym">::</span> sign
     <span class="hl kwb">integer</span><span class="hl sym">,</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span>maxDigs<span class="hl sym">) ::</span> digits
  <span class="hl kwa">end type</span> big_int

  <span class="hl kwa">interface</span> <span class="hl kwd">assignment</span> <span class="hl sym">(=)</span>
     <span class="hl kwa">module</span> procedure int_to_big_int
  <span class="hl kwa">end interface</span>

  <span class="hl kwa">interface</span> <span class="hl kwd">operator</span> <span class="hl sym">(*)</span>
     <span class="hl kwa">module</span> procedure big_int_times_int
  <span class="hl kwa">end interface</span>

  <span class="hl kwa">interface</span> <span class="hl kwd">operator</span> <span class="hl sym">(+)</span>
     <span class="hl kwa">module</span> procedure big_int_plus_big_int
  <span class="hl kwa">end interface</span>

  <span class="hl kwa">interface</span> <span class="hl kwd">operator</span> <span class="hl sym">(/)</span>
     <span class="hl kwa">module</span> procedure big_int_div_big_int
  <span class="hl kwa">end interface</span>

<span class="hl kwa">contains</span>

  <span class="hl kwa">subroutine</span> <span class="hl kwd">int_to_big_int</span><span class="hl sym">(</span>bi<span class="hl sym">,</span> n<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>inout<span class="hl sym">) ::</span> bi
    <span class="hl kwb">integer</span><span class="hl sym">,</span>       <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">)    ::</span> n

    <span class="hl kwb">integer</span> <span class="hl sym">::</span> i

    <span class="hl kwa">if</span> <span class="hl sym">(</span>n <span class="hl sym">&gt;</span> <span class="hl num">0</span><span class="hl sym">)</span> <span class="hl kwa">then</span>
       bi <span class="hl sym">=</span> <span class="hl kwd">big_int</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">, .</span>true<span class="hl sym">., (/</span> n<span class="hl sym">, (</span><span class="hl num">0</span><span class="hl sym">,</span> i <span class="hl sym">=</span> <span class="hl num">2</span><span class="hl sym">,</span> maxDigs<span class="hl sym">) /) )</span>
    <span class="hl kwa">else</span>
       bi <span class="hl sym">=</span> <span class="hl kwd">big_int</span><span class="hl sym">(</span><span class="hl num">0</span><span class="hl sym">, .</span>true<span class="hl sym">.,</span> <span class="hl num">0</span><span class="hl sym">)</span>
    <span class="hl kwa">end if</span>
  <span class="hl kwa">end subroutine</span> int_to_big_int

  <span class="hl kwa">function</span> <span class="hl kwd">big_int_times_int</span><span class="hl sym">(</span>bi<span class="hl sym">,</span> n<span class="hl sym">)</span> <span class="hl kwd">result</span><span class="hl sym">(</span>c<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> bi
    <span class="hl kwb">integer</span><span class="hl sym">,</span>       <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> n
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">) ::</span> c

    <span class="hl kwb">integer</span> <span class="hl sym">::</span> m<span class="hl sym">,</span> i<span class="hl sym">,</span> curDig<span class="hl sym">,</span> k<span class="hl sym">,</span> j<span class="hl sym">,</span> carry

    c <span class="hl sym">=</span> <span class="hl kwd">big_int</span><span class="hl sym">(</span><span class="hl num">0</span><span class="hl sym">, .</span>true<span class="hl sym">.,</span> <span class="hl num">0</span><span class="hl sym">)</span>
    <span class="hl kwa">if</span> <span class="hl sym">(</span>n <span class="hl sym">==</span> <span class="hl num">0</span> <span class="hl sym">.</span>or<span class="hl sym">.</span> bi<span class="hl sym">%</span>sigDigs <span class="hl sym">==</span> <span class="hl num">0</span><span class="hl sym">)</span> <span class="hl kwa">return</span>
    c<span class="hl sym">%</span>sign <span class="hl sym">=</span> n <span class="hl sym">&gt;=</span> <span class="hl num">0</span> <span class="hl sym">.</span>eqv<span class="hl sym">.</span> bi<span class="hl sym">%</span>sign
    m <span class="hl sym">=</span> <span class="hl kwd">abs</span><span class="hl sym">(</span>n<span class="hl sym">)</span>

    <span class="hl kwa">do</span> i <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> maxDigs
       curDig <span class="hl sym">=</span> <span class="hl kwd">mod</span><span class="hl sym">(</span>m<span class="hl sym">,</span>Base<span class="hl sym">)</span>
       k <span class="hl sym">=</span> <span class="hl num">1</span>
       carry <span class="hl sym">=</span> <span class="hl num">0</span>
       <span class="hl kwa">do</span> j <span class="hl sym">=</span> i<span class="hl sym">,</span> i <span class="hl sym">+</span> bi<span class="hl sym">%</span>sigDigs <span class="hl sym">+</span> <span class="hl num">1</span>
          c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">) =</span> c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">) +</span> curDig <span class="hl sym">*</span> bi<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>k<span class="hl sym">) +</span> carry
          carry <span class="hl sym">=</span> <span class="hl kwd">ibits</span><span class="hl sym">(</span>c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">),</span>Pwr<span class="hl sym">,</span>Pwr<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)</span>
          c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">) =</span> <span class="hl kwd">mod</span><span class="hl sym">(</span>c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">),</span>Base<span class="hl sym">)</span>
          k <span class="hl sym">=</span> k <span class="hl sym">+</span> <span class="hl num">1</span>
       <span class="hl kwa">end do</span>
       m <span class="hl sym">=</span> <span class="hl kwd">ibits</span><span class="hl sym">(</span>m<span class="hl sym">,</span>Pwr<span class="hl sym">,</span>Pwr<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)</span>
       <span class="hl kwa">if</span> <span class="hl sym">(</span>m <span class="hl sym">==</span> <span class="hl num">0</span><span class="hl sym">)</span> exit
    <span class="hl kwa">end do</span>
    <span class="hl kwa">do</span> j <span class="hl sym">=</span> i <span class="hl sym">+</span> bi<span class="hl sym">%</span>sigDigs<span class="hl sym">,</span> <span class="hl num">1</span><span class="hl sym">, -</span><span class="hl num">1</span>
       c<span class="hl sym">%</span>sigDigs <span class="hl sym">=</span> j
       <span class="hl kwa">if</span> <span class="hl sym">(</span>c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">) /=</span> <span class="hl num">0</span><span class="hl sym">)</span> exit
    <span class="hl kwa">end do</span>
  <span class="hl kwa">end function</span> big_int_times_int

  <span class="hl kwa">function</span> <span class="hl kwd">big_int_plus_big_int</span><span class="hl sym">(</span>bi1<span class="hl sym">,</span> bi2<span class="hl sym">)</span> <span class="hl kwd">result</span><span class="hl sym">(</span>c<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> target<span class="hl sym">,</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> bi1<span class="hl sym">,</span> bi2
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">) ::</span> c

    <span class="hl kwb">integer</span> <span class="hl sym">::</span> i<span class="hl sym">,</span> carry<span class="hl sym">,</span> n
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwa">pointer</span> <span class="hl sym">::</span> a<span class="hl sym">,</span> b

    c <span class="hl sym">=</span> <span class="hl kwd">big_int</span><span class="hl sym">(</span><span class="hl num">0</span><span class="hl sym">, .</span>true<span class="hl sym">.,</span> <span class="hl num">0</span><span class="hl sym">)</span>

    <span class="hl kwa">if</span> <span class="hl sym">(</span>bi1<span class="hl sym">%</span>sigDigs <span class="hl sym">==</span> <span class="hl num">0</span><span class="hl sym">)</span> <span class="hl kwa">then</span>
       c <span class="hl sym">=</span> bi2
       <span class="hl kwa">return</span>
    <span class="hl kwa">else if</span> <span class="hl sym">(</span>bi2<span class="hl sym">%</span>sigDigs <span class="hl sym">==</span> <span class="hl num">0</span><span class="hl sym">)</span> <span class="hl kwa">then</span>
       c <span class="hl sym">=</span> bi1
       <span class="hl kwa">return</span>
    <span class="hl kwa">end if</span>

    <span class="hl kwa">if</span> <span class="hl sym">(</span>bi1<span class="hl sym">%</span>sign <span class="hl sym">.</span>eqv<span class="hl sym">.</span> bi2<span class="hl sym">%</span>sign<span class="hl sym">)</span> <span class="hl kwa">then</span>
       c<span class="hl sym">%</span>sign <span class="hl sym">=</span> bi1<span class="hl sym">%</span>sign
       carry <span class="hl sym">=</span> <span class="hl num">0</span>
       n <span class="hl sym">=</span> <span class="hl kwd">max</span><span class="hl sym">(</span>bi1<span class="hl sym">%</span>sigDigs<span class="hl sym">,</span> bi2<span class="hl sym">%</span>sigDigs<span class="hl sym">) +</span> <span class="hl num">1</span>
       <span class="hl kwa">do</span> i <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> n
          c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) =</span> bi1<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) +</span> bi2<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) +</span> carry
          carry <span class="hl sym">=</span> <span class="hl kwd">ibits</span><span class="hl sym">(</span>c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">),</span>Pwr<span class="hl sym">,</span>Pwr<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)</span>
          c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) =</span> <span class="hl kwd">mod</span><span class="hl sym">(</span>c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">),</span>Base<span class="hl sym">)</span>
       <span class="hl kwa">end do</span>
    <span class="hl kwa">else</span>
       <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwd">greater_in_mag</span><span class="hl sym">(</span>bi1<span class="hl sym">,</span> bi2<span class="hl sym">))</span> <span class="hl kwa">then</span>
          a <span class="hl sym">=&gt;</span> bi1
          b <span class="hl sym">=&gt;</span> bi2
       <span class="hl kwa">else if</span> <span class="hl sym">(</span><span class="hl kwd">greater_in_mag</span><span class="hl sym">(</span>bi2<span class="hl sym">,</span> bi1<span class="hl sym">))</span> <span class="hl kwa">then</span>
          a <span class="hl sym">=&gt;</span> bi2
          b <span class="hl sym">=&gt;</span> bi1
       <span class="hl kwa">else</span>
          <span class="hl kwa">return</span>
       <span class="hl kwa">end if</span>

       n <span class="hl sym">=</span> <span class="hl kwd">max</span><span class="hl sym">(</span>a<span class="hl sym">%</span>sigDigs<span class="hl sym">,</span> b<span class="hl sym">%</span>sigDigs<span class="hl sym">)</span>
       c<span class="hl sym">%</span>sign <span class="hl sym">=</span> a<span class="hl sym">%</span>sign
       <span class="hl kwa">do</span> i <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> n
          <span class="hl kwa">if</span> <span class="hl sym">(</span>a<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) &lt;</span> b<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">))</span> <span class="hl kwa">then</span>
             a<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) =</span> a<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) +</span> Base
             a<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">) =</span> a<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">) -</span> <span class="hl num">1</span>
          <span class="hl kwa">end if</span>
          c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) =</span> a<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) -</span> b<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">)</span>
       <span class="hl kwa">end do</span>
    <span class="hl kwa">end if</span>

    <span class="hl kwa">do</span> i <span class="hl sym">=</span> n<span class="hl sym">,</span> <span class="hl num">1</span><span class="hl sym">, -</span><span class="hl num">1</span>
       c<span class="hl sym">%</span>sigDigs <span class="hl sym">=</span> i
       <span class="hl kwa">if</span> <span class="hl sym">(</span>c<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) /=</span> <span class="hl num">0</span><span class="hl sym">)</span> exit
    <span class="hl kwa">end do</span>
  <span class="hl kwa">end function</span> big_int_plus_big_int

  <span class="hl kwa">function</span> <span class="hl kwd">big_int_div_big_int</span><span class="hl sym">(</span>a<span class="hl sym">,</span> b<span class="hl sym">)</span> <span class="hl kwd">result</span><span class="hl sym">(</span>c<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> a<span class="hl sym">,</span> b
    <span class="hl kwb">integer</span>                   <span class="hl sym">::</span> c

    <span class="hl kwb">integer</span> <span class="hl sym">::</span> k<span class="hl sym">,</span> carry<span class="hl sym">,</span> n<span class="hl sym">,</span> j
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">) ::</span> accumulator

    c <span class="hl sym">=</span> <span class="hl num">0</span>
    <span class="hl kwa">if</span> <span class="hl sym">(</span>a<span class="hl sym">%</span>sigDigs <span class="hl sym">==</span> <span class="hl num">0</span><span class="hl sym">)</span> <span class="hl kwa">return</span>

    accumulator <span class="hl sym">=</span> <span class="hl kwd">big_int</span><span class="hl sym">(</span><span class="hl num">0</span><span class="hl sym">, .</span>true<span class="hl sym">.,</span> <span class="hl num">0</span><span class="hl sym">)</span>
    <span class="hl kwa">do</span> k <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">,</span> Base<span class="hl sym">-</span><span class="hl num">1</span>
       carry <span class="hl sym">=</span> <span class="hl num">0</span>
       n <span class="hl sym">=</span> <span class="hl kwd">max</span><span class="hl sym">(</span>accumulator<span class="hl sym">%</span>sigDigs<span class="hl sym">,</span> b<span class="hl sym">%</span>sigDigs<span class="hl sym">) +</span> <span class="hl num">1</span>
       <span class="hl kwa">do</span> j <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> n
          accumulator<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">) =  &amp;</span>
               accumulator<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">) +</span> b<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">) +</span> carry
          carry <span class="hl sym">=</span> <span class="hl kwd">ibits</span><span class="hl sym">(</span>accumulator<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">),</span>Pwr<span class="hl sym">,</span>Pwr<span class="hl sym">+</span><span class="hl num">1</span><span class="hl sym">)</span>
          accumulator<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">) =</span> <span class="hl kwd">mod</span><span class="hl sym">(</span>accumulator<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">),</span>Base<span class="hl sym">)</span>
       <span class="hl kwa">end do</span>
       <span class="hl kwa">do</span> j <span class="hl sym">=</span> n<span class="hl sym">,</span> <span class="hl num">1</span><span class="hl sym">, -</span><span class="hl num">1</span>
          accumulator<span class="hl sym">%</span>sigDigs <span class="hl sym">=</span> j
          <span class="hl kwa">if</span> <span class="hl sym">(</span>accumulator<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>j<span class="hl sym">) /=</span> <span class="hl num">0</span><span class="hl sym">)</span> exit
       <span class="hl kwa">end do</span>
       <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwd">greater_in_mag</span><span class="hl sym">(</span>accumulator<span class="hl sym">,</span> a<span class="hl sym">))</span> <span class="hl kwa">then</span>
          c <span class="hl sym">=</span> k
          exit
       <span class="hl kwa">end if</span>
    <span class="hl kwa">end do</span>
  <span class="hl kwa">end function</span> big_int_div_big_int

  <span class="hl kwb">logical</span> <span class="hl kwa">function</span> <span class="hl kwd">greater_in_mag</span><span class="hl sym">(</span>a<span class="hl sym">,</span> b<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> a<span class="hl sym">,</span> b

    <span class="hl kwb">integer</span> <span class="hl sym">::</span> i

    greater_in_mag <span class="hl sym">= .</span>false<span class="hl sym">.</span>
    <span class="hl kwa">do</span> i <span class="hl sym">=</span> <span class="hl kwd">max</span><span class="hl sym">(</span>a<span class="hl sym">%</span>sigDigs<span class="hl sym">,</span> b<span class="hl sym">%</span>sigDigs<span class="hl sym">),</span> <span class="hl num">1</span><span class="hl sym">, -</span><span class="hl num">1</span>
       <span class="hl kwa">if</span> <span class="hl sym">(</span>a<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) &gt;</span> b<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">))</span> <span class="hl kwa">then</span>
          greater_in_mag <span class="hl sym">= .</span>true<span class="hl sym">.</span>
          exit
       <span class="hl kwa">else if</span> <span class="hl sym">(</span>a<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">) &lt;</span> b<span class="hl sym">%</span><span class="hl kwd">digits</span><span class="hl sym">(</span>i<span class="hl sym">))</span> <span class="hl kwa">then</span>
          exit
       <span class="hl kwa">end if</span>
    <span class="hl kwa">end do</span>
  <span class="hl kwa">end function</span> greater_in_mag
<span class="hl kwa">end module</span> big_int_mod

<span class="hl kwa">module</span> pi_mod
  <span class="hl kwa">use</span> big_int_mod
  <span class="hl kwa">implicit none</span>

<span class="hl kwa">contains</span>

  <span class="hl kwa">function</span> <span class="hl kwd">lfts</span><span class="hl sym">(</span>k<span class="hl sym">)</span>
    <span class="hl kwb">integer</span><span class="hl sym">,</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">)     ::</span> k
    <span class="hl kwb">integer</span><span class="hl sym">,</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) ::</span> lfts

    lfts <span class="hl sym">=</span> <span class="hl kwd">reshape</span><span class="hl sym">( (/</span> k<span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">,</span> <span class="hl num">4</span><span class="hl sym">*</span>k <span class="hl sym">+</span> <span class="hl num">2</span><span class="hl sym">,</span> <span class="hl num">2</span><span class="hl sym">*</span>k <span class="hl sym">+</span> <span class="hl num">1</span> <span class="hl sym">/), (/</span> <span class="hl num">2</span><span class="hl sym">,</span> <span class="hl num">2</span> <span class="hl sym">/) )</span>
  <span class="hl kwa">end function</span> lfts

  <span class="hl kwa">function</span> <span class="hl kwd">comp1</span><span class="hl sym">(</span>a<span class="hl sym">,</span> b<span class="hl sym">)</span>
    <span class="hl kwb">integer</span><span class="hl sym">,</span>       <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> a
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> b
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) ::</span> comp1

    <span class="hl kwd">comp1</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) =</span> <span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">)*</span><span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) +</span> <span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">)*</span><span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)</span>
    <span class="hl kwd">comp1</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) =</span> <span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">)*</span><span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) +</span> <span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">)*</span><span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)</span>
    <span class="hl kwd">comp1</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) =</span> <span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)*</span><span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) +</span> <span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)*</span><span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)</span>
    <span class="hl kwd">comp1</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) =</span> <span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)*</span><span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) +</span> <span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)*</span><span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)</span>
  <span class="hl kwa">end function</span> comp1

  <span class="hl kwa">function</span> <span class="hl kwd">comp2</span><span class="hl sym">(</span>a<span class="hl sym">,</span> b<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> a
    <span class="hl kwb">integer</span><span class="hl sym">,</span>       <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> b
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) ::</span> comp2

    <span class="hl kwd">comp2</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) =</span> <span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">)*</span><span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) +</span> <span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)*</span><span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">)</span>
    <span class="hl kwd">comp2</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) =</span> <span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">)*</span><span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) +</span> <span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)*</span><span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">)</span>
    <span class="hl kwd">comp2</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) =</span> <span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">)*</span><span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) +</span> <span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)*</span><span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)</span>
    <span class="hl kwd">comp2</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) =</span> <span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">)*</span><span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) +</span> <span class="hl kwd">a</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)*</span><span class="hl kwd">b</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)</span>
  <span class="hl kwa">end function</span> comp2

  <span class="hl kwa">function</span> <span class="hl kwd">prod</span><span class="hl sym">(</span>z<span class="hl sym">,</span> n<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> z
    <span class="hl kwb">integer</span><span class="hl sym">,</span>                       <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> n
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) ::</span> prod

    prod <span class="hl sym">=</span> <span class="hl kwd">comp1</span><span class="hl sym">(</span><span class="hl kwd">reshape</span><span class="hl sym">( (/</span> <span class="hl num">10</span><span class="hl sym">,</span> <span class="hl num">0</span><span class="hl sym">, -</span><span class="hl num">10</span><span class="hl sym">*</span>n<span class="hl sym">,</span> <span class="hl num">1</span> <span class="hl sym">/), (/</span> <span class="hl num">2</span><span class="hl sym">,</span> <span class="hl num">2</span> <span class="hl sym">/) ),</span> z<span class="hl sym">)</span>
  <span class="hl kwa">end function</span> prod

  <span class="hl kwb">logical</span> <span class="hl kwa">function</span> <span class="hl kwd">safe</span><span class="hl sym">(</span>z<span class="hl sym">,</span> n<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> z
    <span class="hl kwb">integer</span><span class="hl sym">,</span>                       <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> n

    safe <span class="hl sym">=</span> n <span class="hl sym">== (</span><span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) *</span> <span class="hl num">4</span> <span class="hl sym">+</span> <span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)) / (</span><span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) *</span> <span class="hl num">4</span> <span class="hl sym">+</span> <span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">))</span>
  <span class="hl kwa">end function</span> safe

  <span class="hl kwb">integer</span> <span class="hl kwa">function</span> <span class="hl kwd">next</span><span class="hl sym">(</span>z<span class="hl sym">)</span>
    <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">),</span> <span class="hl kwd">intent</span><span class="hl sym">(</span>in<span class="hl sym">) ::</span> z

    next <span class="hl sym">= (</span><span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) *</span> <span class="hl num">3</span> <span class="hl sym">+</span> <span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">)) / (</span><span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) *</span> <span class="hl num">3</span> <span class="hl sym">+</span> <span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">))</span>
  <span class="hl kwa">end function</span> next
<span class="hl kwa">end module</span> pi_mod

<span class="hl kwa">program</span> pidigits
  <span class="hl kwa">use</span> pi_mod
  <span class="hl kwa">implicit none</span>

  <span class="hl kwb">character</span><span class="hl sym">(</span>len<span class="hl sym">=</span><span class="hl num">12</span><span class="hl sym">),</span> <span class="hl kwa">parameter</span>  <span class="hl sym">::</span> proForma <span class="hl sym">=</span> <span class="hl str">&quot;          &quot;</span> <span class="hl sym">//</span> <span class="hl kwd">achar</span><span class="hl sym">(</span><span class="hl num">9</span><span class="hl sym">) //</span> <span class="hl str">&quot;:&quot;</span>
  <span class="hl kwa">type</span><span class="hl sym">(</span>big_int<span class="hl sym">),</span> <span class="hl kwa">dimension</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) ::</span> z
  <span class="hl kwb">integer</span>           <span class="hl sym">::</span> num<span class="hl sym">,</span> y<span class="hl sym">,</span> i <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> j <span class="hl sym">=</span> <span class="hl num">1</span><span class="hl sym">,</span> k <span class="hl sym">=</span> <span class="hl num">1</span>
  <span class="hl kwb">character</span><span class="hl sym">(</span>len<span class="hl sym">=</span><span class="hl num">17</span><span class="hl sym">) ::</span> outLine <span class="hl sym">=</span> proForma
  <span class="hl kwb">character</span><span class="hl sym">(</span>len<span class="hl sym">=</span><span class="hl num">4</span><span class="hl sym">)  ::</span> argv

  <span class="hl kwa">call</span> <span class="hl kwd">get_command_argument</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span> argv<span class="hl sym">)</span>
  <span class="hl kwa">read</span><span class="hl sym">(</span>argv<span class="hl sym">, *)</span> num

  <span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) =</span> <span class="hl num">1</span><span class="hl sym">;</span> <span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">1</span><span class="hl sym">) =</span> <span class="hl num">0</span><span class="hl sym">;</span> <span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">1</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) =</span> <span class="hl num">0</span><span class="hl sym">;</span> <span class="hl kwd">z</span><span class="hl sym">(</span><span class="hl num">2</span><span class="hl sym">,</span><span class="hl num">2</span><span class="hl sym">) =</span> <span class="hl num">1</span>

  <span class="hl kwa">do</span>
     y <span class="hl sym">=</span> <span class="hl kwd">next</span><span class="hl sym">(</span>z<span class="hl sym">)</span>
     <span class="hl kwa">if</span> <span class="hl sym">(</span><span class="hl kwd">safe</span><span class="hl sym">(</span>z<span class="hl sym">,</span> y<span class="hl sym">))</span> <span class="hl kwa">then</span>
        <span class="hl kwa">write</span><span class="hl sym">(</span>unit<span class="hl sym">=</span><span class="hl kwd">outLine</span><span class="hl sym">(</span>k<span class="hl sym">:</span>k<span class="hl sym">),</span> fmt<span class="hl sym">=</span><span class="hl str">&quot;(i1)&quot;</span><span class="hl sym">)</span> y
        <span class="hl kwa">if</span> <span class="hl sym">(</span>k <span class="hl sym">&lt;</span> <span class="hl num">10</span> <span class="hl sym">.</span>and<span class="hl sym">.</span> i <span class="hl sym">&lt;</span> num<span class="hl sym">)</span> <span class="hl kwa">then</span>
           k <span class="hl sym">=</span> k <span class="hl sym">+</span> <span class="hl num">1</span>
        <span class="hl kwa">else</span>
           k <span class="hl sym">=</span> <span class="hl num">1</span>
           <span class="hl kwa">write</span><span class="hl sym">(</span>unit<span class="hl sym">=</span><span class="hl kwd">outLine</span><span class="hl sym">(</span><span class="hl num">13</span><span class="hl sym">:</span><span class="hl num">17</span><span class="hl sym">),</span> fmt<span class="hl sym">=</span><span class="hl str">&quot;(i0)&quot;</span><span class="hl sym">)</span> i
           <span class="hl kwa">write</span><span class="hl sym">(*,</span> <span class="hl str">&quot;(a)&quot;</span><span class="hl sym">)</span> <span class="hl kwd">trim</span><span class="hl sym">(</span>outLine<span class="hl sym">)</span>
           outLine <span class="hl sym">=</span> proForma
        <span class="hl kwa">end if</span>
        <span class="hl kwa">if</span> <span class="hl sym">(</span>i <span class="hl sym">==</span> num<span class="hl sym">)</span> exit
        z <span class="hl sym">=</span> <span class="hl kwd">prod</span><span class="hl sym">(</span>z<span class="hl sym">,</span> y<span class="hl sym">)</span>
        i <span class="hl sym">=</span> i <span class="hl sym">+</span> <span class="hl num">1</span>
     <span class="hl kwa">else</span>
        z <span class="hl sym">=</span> <span class="hl kwd">comp2</span><span class="hl sym">(</span>z<span class="hl sym">,</span> <span class="hl kwd">lfts</span><span class="hl sym">(</span>j<span class="hl sym">))</span>
        j <span class="hl sym">=</span> j <span class="hl sym">+</span> <span class="hl num">1</span>
     <span class="hl kwa">end if</span>
  <span class="hl kwa">end do</span>
<span class="hl kwa">end program</span> pidigits
